<!DOCTYPE html>

<html lang="fi">

  <head>

    <meta charset="utf-8">

    <title>Konkurrenssikone 2.0</title>

    <script>

// ********************************************************************************************************************
// Konkurrenssikoneen lähdekoodi
// Laatinut hovioikeudenneuvos Juha Terho
// ********************************************************************************************************************
//
// Sisällysluettelo
// ----------------
//
// Globaalit vakiot/muuttujat ym.
//
// Käyttöliittymään liittyvät funktiot:
// - alkutoimet
// - näytäTaiPiilota
// - näytäTaiPiilotaKenttä
// - tallennaKäyttöehtojenAjankohta
//
// Konkurrenssikoneen käynnistäminen:
// - analysoiRikosrekisteriote
// - konkurrenssikone
//
// Konstruktorit:
// - Rikos
// - Tuomio
// - Konkurrenssiryhmä
//
// Konkurrenssikoneen ydin:
// - lajitteleTuomiot
// - määritäKonkurrenssiryhmät
// - valmisteleKonkurrenssilausunnot
// - etsiTuomioidenPäällekkäisyydet
// - laskeKokonaisrangaistukset
//
// Tulosteen muodostamiseen liittyvät yleiset funktiot:
// - listaaSyytekohdat
// - pvmTekstiksi
// - ajankohtaTekstiksi
// - ajanjaksoTekstiksi
// - lyhennäTuomionTiedot
// - nroRoomalaiseksi
//
// Tulosteen sisällön muodostaminen:
// - tulostaJohdanto
// - tulostaMuutoksetJaVaroitukset
// - tulostaEhdottomatTuomiot
// - tulostaKonkurrenssiryhmät
// - tulostaKonkurrenssikaavio
//
// PDF-muotoisen rikosrekisteriotteen luenta:
// - luePDFRikosrekisteriote
//
// Esittelytoiminto, joka luo fiktiivisen rikosrekisteriotteen:
// - luoEsimerkkiRikosrekisteriote
//
// Tiivisteiden laskeminen:
// - tiiviste
//
// ********************************************************************************************************************

"use strict";

// ********************************************************************************************************************
// globaalit vakiot/muuttujat ym.
// ********************************************************************************************************************

// tarkistetaan, onko käytössä IE tai IE-tila
if (window.navigator.userAgent.includes("Trident")) {
    alert("Konkurrenssikone ei tue Internet Explorer -selainta (IE) eikä Edge-selaimen IE-tilaa. Jos käytössä on "
        + "Edgen IE-tila, kytke se pois päältä selaimen oikean yläkulman painikkeesta tai sulje selain ja avaa "
        + "konkurrenssikone sitten uudelleen.");
    throw new Error("Ei IE-tukea");
}

// konkurrenssikoneen versionumero (numeron ja päivämäärän oltava myös html:ssä)
const versio = "2.09, 29.1.2025";

// konkurrenssikoneen käyttötarkoitus
const tuomioistuinkäyttö = false;

// laskuri, joka sisältää tiedon siitä, monettako kertaa konkurrenssikonetta käytetään
let käyttökertalaskuri = 0;

// käyttöliittymän alkutoimet tehdään sitten, kun html-osio on varmasti ladattu kokonaan
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", alkutoimet);
} else {
    alkutoimet();
}

// ********************************************************************************************************************
// alkutoimet:
// funktio, joka sisältää konkurrenssikonetta avattaessa suoritettavat käyttöliittymän alkutoimet
// ********************************************************************************************************************

function alkutoimet() {

    document.getElementById("jsVaroitus").style.display = "none";

    if (tuomioistuinkäyttö) {
        document.getElementById("käyttöehto-osio").style.display = "none";
        document.getElementById("tuomioistuinkäyttö").style.display = "block";
    } else {
        document.getElementById("käyttöehto-osio").style.display = "block";
        document.getElementById("tuomioistuinkäyttö").style.display = "none";
    }

    let liukusäädin1 = document.getElementById("ehdottomienMäärä");
    let liukusäädin2 = document.getElementById("ehdollistenMäärä");
    let liukusäädin3 = document.getElementById("rikostenEnimmäismäärä");
    let liukusäädin4 = document.getElementById("tuomioidenVäliMax");
    let liukusäädin5 = document.getElementById("rikostenVäliMax");
    let liukusäädin6 = document.getElementById("mhTodennäköisyys");
    let liukusäädin7 = document.getElementById("mhVäliMax");

    let lukema1 = document.getElementById("ehdottomienMääräLukema");
    let lukema2 = document.getElementById("ehdollistenMääräLukema");
    let lukema3 = document.getElementById("rikostenEnimmäismääräLukema");
    let lukema4 = document.getElementById("tuomioidenVäliMaxLukema");
    let lukema5 = document.getElementById("rikostenVäliMaxLukema");
    let lukema6 = document.getElementById("mhTodennäköisyysLukema");
    let lukema7 = document.getElementById("mhVäliMaxLukema");

    lukema1.innerHTML = liukusäädin1.value + "&nbsp;kpl";
    lukema2.innerHTML = liukusäädin2.value + "&nbsp;kpl";
    lukema3.innerHTML = liukusäädin3.value + "&nbsp;kpl";
    lukema4.innerHTML = liukusäädin4.value + "&nbsp;pv";
    lukema5.innerHTML = liukusäädin5.value + "&nbsp;pv";
    lukema6.innerHTML = liukusäädin6.value + "&nbsp;%";
    lukema7.innerHTML = liukusäädin7.value + "&nbsp;pv";

    liukusäädin1.oninput = function() { lukema1.innerHTML = this.value + "&nbsp;kpl"; tarkista(); }
    liukusäädin2.oninput = function() { lukema2.innerHTML = this.value + "&nbsp;kpl"; tarkista(); }
    liukusäädin3.oninput = function() { lukema3.innerHTML = this.value + "&nbsp;kpl"; tarkista(); }
    liukusäädin4.oninput = function() { lukema4.innerHTML = this.value + "&nbsp;pv"; tarkista(); }
    liukusäädin5.oninput = function() { lukema5.innerHTML = this.value + "&nbsp;pv"; tarkista(); }
    liukusäädin6.oninput = function() { lukema6.innerHTML = this.value + "&nbsp;%"; tarkista(); }
    liukusäädin7.oninput = function() { lukema7.innerHTML = this.value + "&nbsp;pv"; tarkista(); }

    function tarkista() {
        if (liukusäädin1.value == liukusäädin1.max &&
            liukusäädin2.value == liukusäädin2.max &&
            liukusäädin3.value == liukusäädin3.max &&
            liukusäädin4.value == liukusäädin4.max &&
            liukusäädin5.value == liukusäädin5.max &&
            liukusäädin6.value == liukusäädin6.max &&
            liukusäädin7.value == liukusäädin7.max ) {
            document.getElementById("max").style.display = "inline";
        } else {
            document.getElementById("max").style.display = "none";
        }
    }

}

// ********************************************************************************************************************
// näytäTaiPiilota:
// funktio, joka näyttää/piilottaa konkurrenssikoneen käyttöliittymän yhden osion (argumentti 0) ja piilottaa kaikki
// muut (argumentti 1, taulukko); jos yksi osio näytetään, sitä vastaava painike muutetaan väriltään mustaksi, muut
// normaalin värisiksi; lisäksi tietyissä painikkeissa olevat nuolet käännetään tarvittaessa ylös/alas
// ********************************************************************************************************************

function näytäTaiPiilota(id, muutIdt) {

    let x = document.getElementById(id);
    let y = document.getElementById(id + "Painike");

    if (x.style.display != "block") {

        x.style.display = "block";

        if (arguments.length > 1) {
            for (let i = 0; i < muutIdt.length; i++) {
                let a = document.getElementById(muutIdt[i]);
                let b = document.getElementById(muutIdt[i] + "Painike");
                a.style.display = "none";
                b.style.backgroundColor = "#ddd";
                b.style.color = "black";
            }
        }

        setTimeout(() => { x.style.opacity = 1; }, 10);
        y.style.backgroundColor = "black";
        y.style.color = "#ddd";

    } else {

        x.style.opacity = 0;
        setTimeout(() => { x.style.display = "none"; }, 400);
        y.style.backgroundColor = "#ddd";
        y.style.color = "black";

    }

    if (id == "käyttöehdot") {
        let nuoliAlas = document.getElementById("käyttöehtoNuoliAlas");
        let nuoliYlös = document.getElementById("käyttöehtoNuoliYlös");
        if (nuoliAlas.style.display == "none") {
            nuoliAlas.style.display = "inline";
            nuoliYlös.style.display = "none";
        } else {
            nuoliAlas.style.display = "none";
            nuoliYlös.style.display = "inline";
        }
    }

    if (id == "muokkaaTuomiota") {
        let nuoliAlas = document.getElementById("muokkausNuoliAlas");
        let nuoliYlös = document.getElementById("muokkausNuoliYlös");
        if (nuoliAlas.style.display == "none") {
            nuoliAlas.style.display = "inline";
            nuoliYlös.style.display = "none";
        } else {
            nuoliAlas.style.display = "none";
            nuoliYlös.style.display = "inline";
        }
    }

}

// ********************************************************************************************************************
// näytäTaiPiilotaKenttä:
// erillinen funktio tekstikentän näyttämistä ja piilottamista varten
// ********************************************************************************************************************

function näytäTaiPiilotaKenttä(id) {
    if (document.getElementById(id).checked) {
        document.getElementById(id + "kenttä").style.display = "inline";
    } else {
        document.getElementById(id + "kenttä").style.display = "none";
    }
}

// ********************************************************************************************************************
// tallennaKäyttöehtojenAjankohta:
// funktio, joka tallentaa käyttöehtojen ajankohdan lomakkeen piilotettuun kenttään
// ********************************************************************************************************************

function tallennaKäyttöehtojenAjankohta() {
    if (document.getElementById("käyttöehdotHyväksytty").checked) {
        document.getElementById("käyttöehtojenAjankohta").value = ajankohtaTekstiksi(new Date());
    } else {
        document.getElementById("käyttöehtojenAjankohta").value = "";
    }
}

// ********************************************************************************************************************
// analysoiRikosrekisteriote:
// funktio, joka käynnistyy painamalla "Analysoi rikosrekisteri" -painiketta ja kutsuu konkurrenssikone-funktiota
// lomakkeen tietojen perusteella; jos esittely == true, tuloste perustuu luotavaan esimerkkirikosrekisteriin
// ********************************************************************************************************************

function analysoiRikosrekisteriote(lomake, esittely, lataus) {

    // haetaan tiedot lomakkeesta

    let rikosrekisteriote = stilisoi(lomake.rikrek.value);

    let asetukset = {}

    asetukset.lausuntoLyhyt = lomake.lausuntoLyhyt.checked;             // tulostetaanko lyhyen mallin lausunto
    asetukset.lausuntoKeskipitkä = lomake.lausuntoKeskipitkä.checked;   // tulostetaanko keskipitkän mallin lausunto
    asetukset.lausuntoPitkä = lomake.lausuntoPitkä.checked;             // tulostetaanko pitkän mallin lausunto
    asetukset.lausuntoKaikille = lomake.lausuntoKaikille.checked;       // konkurrenssilausunnot myös lainvoimaisille
    asetukset.mhKaaviossa = lomake.mhKaaviossa.checked;                 // näytetäänkö kaaviossa myös muutoksenhaut
    asetukset.ehdollisetKaaviossa = lomake.ehdollisetKaaviossa.checked; // näytetäänkö kaaviossa myös ehdolliset ym.
    asetukset.isoKaavio = lomake.isoKaavio.checked;                     // onko kaavion mittakaava kaksinkertainen
    asetukset.värillinenKaavio = lomake.värillinenKaavio.checked;       // onko konkurrenssikaavio värillinen
    asetukset.tyhjennäLeikepöytä = lomake.tyhjennäLeikepöytä.checked;   // tyhjennetäänkö leikepöytä käytön jälkeen
    asetukset.vianhaku = lomake.vianhaku.checked;                       // vianhakutiedot pdf-rikosrekisterin luennasta
    asetukset.lähdekoodi = lomake.lähdekoodi.checked;                   // HTML-koodi erilliseen tekstikenttään
    asetukset.tiivisteet = lomake.tiivisteet.checked;                   // lasketaanko tiivisteet

    asetukset.esittely = false;                                         // onko kyseessä esittelytila
    if (esittely) {
        asetukset.esittely = true;
        asetukset.esittely_ehdottomienMäärä = lomake.ehdottomienMäärä.value;
        asetukset.esittely_ehdollistenMäärä = lomake.ehdollistenMäärä.value;
        asetukset.esittely_rikostenEnimmäismäärä = lomake.rikostenEnimmäismäärä.value;
        asetukset.esittely_tuomioidenVäliMax = lomake.tuomioidenVäliMax.value;
        asetukset.esittely_rikostenVäliMax = lomake.rikostenVäliMax.value;
        asetukset.esittely_mhTodennäköisyys = lomake.mhTodennäköisyys.value / 100;
        asetukset.esittely_mhVäliMax = lomake.mhVäliMax.value;
    }

    let muokkaukset = {};
    muokkaukset.muutokset = [];
    muokkaukset.uudenTuomionPvm = stilisoi(lomake.uudenTuomionPvm.value);
    muokkaukset.uudenTuomionRikokset = stilisoi(lomake.uudenTuomionRikokset.value);
    if (lomake.uusiTuomioRitu.checked) {
        muokkaukset.uusiTuomioLaji = "Ritu";
    } else if (lomake.uusiTuomioAipa.checked) {
        muokkaukset.uusiTuomioLaji = "Aipa";
    } else {
        muokkaukset.uusiTuomioLaji = "";
    }
    muokkaukset.poistettavaTuomio = stilisoi(lomake.poistettavaTuomio.value);
    muokkaukset.poistettavatRikoksetTuomio = stilisoi(lomake.poistettavatRikoksetTuomio.value);
    muokkaukset.poistettavatRikokset = stilisoi(lomake.poistettavatRikokset.value);
    muokkaukset.muokattavaTuomio = stilisoi(lomake.muokattavaTuomio.value);
    muokkaukset.muokattavaTuomioRikokset = stilisoi(lomake.muokattavaTuomioRikokset.value);
    if (lomake.rikoksetRitu.checked) {
        muokkaukset.muokattavaTuomioLaji = "Ritu";
    } else if (lomake.rikoksetAipa.checked) {
        muokkaukset.muokattavaTuomioLaji = "Aipa";
    } else {
        muokkaukset.muokattavaTuomioLaji = "";
    }
    muokkaukset.tuomioEhdottomaksi = stilisoi(lomake.tuomioEhdottomaksi.value);
    muokkaukset.tuomioEhdottomaksiPvm = stilisoi(lomake.tuomioEhdottomaksiPvm.value);
    muokkaukset.katkaisevatTuomiot = stilisoi(lomake.katkaisevatTuomiot.value);

    let tiivisteet = {};

    if (rikosrekisteriote == "" && !asetukset.esittely) {
        alert("Konkurrenssikoneeseen ei ole syötetty rikosrekisteriotteen tietoja. Konkurrenssikonetta voi "
            + "kuitenkin testata ilman rikosrekisteriotetta käyttämällä ns. esittelytoimintoa, joka luo "
            + "fiktiivisen mallitulosteen (Esittelytoiminto-painike).");
        return;
    }

    // jos kyse ei ole tuomioistuinkäytöstä, tarkistetaan käyttöehtojen hyväksyntä ja tallennetaan sen ajankohta

    if (!tuomioistuinkäyttö) {
        if (!lomake.käyttöehdotHyväksytty.checked && !asetukset.esittely) {
            alert("Käyttöehtoja ei ole hyväksytty. Konkurrenssikoneen käyttäminen edellyttää käyttöehtojen "
                + "hyväksymistä.\n\nNs. esittelytoiminnolla voi kuitenkin luoda fiktiivisen mallitulosteen "
                + "ilman käyttöehtojen hyväksymistä (Esittelytoiminto-painike).");
            return;
        } else {
            asetukset.käyttöehtojenAjankohta = lomake.käyttöehtojenAjankohta.value;
        }
    }

    // syötetään lomakkeen tiedot konkurrenssikoneeseen, joka palauttaa tulosteen

    let tuloste = konkurrenssikone(rikosrekisteriote, asetukset, muokkaukset, tiivisteet);

    // koodi tallennetaan erilliseen muuttujaan sen varalta, että se halutaan ladata tai tallentaa tekstikenttään

    let koodi = "<!D" + "OCTYPE ht" + "ml>\n\n<ht" + "ml lang='fi'>\n\n<head>\n\n" + tuloste[0]
        + "</head>\n\n<body>\n\n" + tuloste[1] + "</body>\n\n</html>\n";

    // seuraavassa aloitetaan tiivisteen laskeminen vasta siitä tulosteen johdannon kohdasta, jossa ilmoitetaan
    // asetukset, koska muuten mukaan tulee konkurrenssikoneen käyttöajankohta ja muita vaihtelevia tietoja 

    if (asetukset.tiivisteet && !asetukset.esittely) {
        tiivisteet.tuloste = tiiviste(tuloste[1].substring(tuloste[1].indexOf("<p><b>Asetukset")));
        tuloste[1] = tuloste[1].replace("[[tiivisteet]]", JSON.stringify(tiivisteet)
            .replaceAll("\"", "").replaceAll("{", "").replaceAll("}", "").replaceAll(":", " <b>")
            .replaceAll(",", "</b>, ") + "</b>");
    }

    if (!asetukset.tiivisteet || asetukset.esittely) {
        document.getElementById("tiivisteetkenttä").value = "";
    }

    // vaihtoehtoina on joko tulosteen (tai vianhakutulosteen) esittäminen tai tulosteen lataaminen; ensimmäisessä
    // vaihtoehdossa avataan uusi ikkuna konkurrenssikoneen tulosteelle (tuloste[0] = head-elementti ja
    // tuloste[1] = body-elementti) tai mahdolliselle vianhakutulosteelle (tuloste[2]) ja koodi tallennetaan
    // haluttaessa myös erilliseen tekstikenttään

    if (!lataus) {

        let tulostusikkuna = window.open();

        if (asetukset.vianhaku && !asetukset.esittely) {
            tulostusikkuna.document.write(tuloste[2]);
        } else {
            tulostusikkuna.document.head.insertAdjacentHTML("beforeend", tuloste[0]);
            tulostusikkuna.document.body.insertAdjacentHTML("beforeend", tuloste[1]);
            if (asetukset.lähdekoodi) {
                document.getElementById("lähdekoodikenttä").value = koodi;
            }
        }

        // seuraavat kaksi ovat samoja kuin alla

        if (asetukset.tiivisteet && !asetukset.esittely) {
            document.getElementById("tiivisteetkenttä").value = JSON.stringify(tiivisteet);
        }

        if (asetukset.tyhjennäLeikepöytä) {
            tyhjennäLeikepöytä();
        }

    } else {

        if (!asetukset.vianhaku) {

            let nyt = ajankohtaTekstiksi(new Date());
            let nimenJatke = prompt("Vahvista, että haluat ladata konkurrenssikoneen tulosteen erillisenä "
                    + "html-tiedostona.\n\nTiedosto tallentuu selaimen latauskansioon nimellä ”Konkurrenssituloste "
                    + nyt + "”. Voit täydentää tiedostonimeä kirjoittamalla täydennyksen alla olevaan "
                    + "tekstikenttään.\n\nMuista poistaa tiedosto, kun sitä ei enää tarvita.");

            if (nimenJatke != null) {

                // poistetaan turhat välilyönnit, rajataan pituus 35 merkkiin ja korvataan kauttaviivat viivoilla
                nimenJatke = nimenJatke.trim();
                if (nimenJatke.length > 35) {
                    nimenJatke = nimenJatke.substring(0, 35);
                }
                nimenJatke = nimenJatke.replaceAll("/", "-");

                if (nimenJatke != "") {
                    nimenJatke += " ";
                }

                let elementti = document.createElement("a");
                elementti.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(koodi));
                elementti.setAttribute("download", "Konkurrenssituloste " + nimenJatke + nyt + ".html");
                elementti.style.display = "none";
                document.body.appendChild(elementti);
                elementti.click();
                document.body.removeChild(elementti);

                // seuraavat kaksi ovat samoja kuin yllä

                if (asetukset.tiivisteet && !asetukset.esittely) {
                    document.getElementById("tiivisteetkenttä").value = JSON.stringify(tiivisteet);
                }

                if (asetukset.tyhjennäLeikepöytä) {
                    tyhjennäLeikepöytä();
                }

            }

        } else {

            alert("Asetuksista on valittuna vaihtoehto ”Tiedot pdf:n luennan etenemisestä normaalin tulosteen "
                + "sijaan”. Luentatietoja ei kuitenkaan voi ladata erillisenä tiedostona. Jos haluat ladata "
                + "konkurrenssikoneen normaalin tulosteen, poista ensin kyseinen valinta asetuksista.");

        }

    }

    function stilisoi(merkkijono) {
        return merkkijono
            .replaceAll("&", "&#38;")
            .replaceAll("'", "&#8217;")
            .replaceAll("\"", "&#8221;")
            .replaceAll("<", "&#60;")
            .replaceAll(">", "&#62;")
            .replaceAll("=", "&#61;")
            .replaceAll("`", "&#8219;")
            .replaceAll("\\", "&#92;");
    }

    function tyhjennäLeikepöytä() {
        try {
            navigator.clipboard.writeText("");
        } catch (virhe) {
            console.error("Virhe leikepöytää tyhjennettäessä: " + virhe.message);
        }
    }

}

// ********************************************************************************************************************
// konkurrenssikone:
// funktio, joka lukee pdf-muotoisen rikosrekisterin ja laatii siitä html-muotoisen tulosteen
// ********************************************************************************************************************

function konkurrenssikone(rikosrekisteriote, asetukset, muokkaukset, tiivisteet) {

    // suoritusajan mittaus
    let aika = {
        aloitettu: 0,
        alustusValmis: 0,
        rikosrekisterioteLuettuTaiLuotu: 0,
        konkurrenssiryhmätMääritetty: 0,
        valmis: 0,
    }

    aika.aloitettu = performance.now();

    // taulukot konkurrenssikoneen HTML-muotoisten tulosteiden osille (varsinainen tuloste ja vianhakutiedot
    // pdf-rikosrekisterin luennasta); lopuksi näiden taulukoiden sisältö yhdistetään palautettaviksi merkkijonoiksi
    let tulosteHTML = [];
    let tulosteHTMLheader = [];
    let vianhakuHTML = [];
    let tulosteHTMLhead = "";
    let tulosteHTMLbody = "";
    let vianhakuHTMLlopullinen = "";

    // tulostetaan konsoliin tiedot konkurrenssikoneen versiosta, asetuksista ym.
    käyttökertalaskuri++;
    console.log("Konkurrenssikone v" + versio + ", käyttöajankohta " + new Date().toLocaleString("fi-FI")
        + ", käyttökerta " + käyttökertalaskuri);
    if (tuomioistuinkäyttö) {
        console.log("Tuomioistuinkäyttöön tarkoitettu versio");
    } else {
        console.log("Julkinen versio, käyttöehtojen hyväksymisajankohta: " + asetukset.käyttöehtojenAjankohta);
    }
    console.log("Konkurrenssilausuntojen asetukset:");
    console.log("- lausunnot kaikille tuomioille: " + asetukset.lausuntoKaikille);
    console.log("- lyhyt lausunto: " + asetukset.lausuntoLyhyt);
    console.log("- keskipitkä lausunto: " + asetukset.lausuntoKeskipitkä);
    console.log("- pitkä lausunto: " + asetukset.lausuntoPitkä);
    console.log("Konkurrenssikaavion asetukset:");
    console.log("- näytetään muutoksenhaut: " + asetukset.mhKaaviossa);
    console.log("- näytetään ehdolliset ja nuorisorangaistukset: " + asetukset.ehdollisetKaaviossa);
    console.log("- kaksinkertainen mittakaava: " + asetukset.isoKaavio);
    console.log("- värillinen kaavio: " + asetukset.värillinenKaavio);
    console.log("Muut asetukset:");
    console.log("- tiivisteet: " + asetukset.tiivisteet);
    console.log("- vianhakutila: " + asetukset.vianhaku);
    console.log("- esittelytila: " + asetukset.esittely);
    if (asetukset.esittely) {
        console.log("Esittelytilan asetukset: ");
        console.log("- ehdottomia: " + asetukset.esittely_ehdottomienMäärä);
        console.log("- ehdollisia: " + asetukset.esittely_ehdollistenMäärä);
        console.log("- rikoksia/tuomio max: " + asetukset.esittely_rikostenEnimmäismäärä);
        console.log("- tuomioiden väli max: " + asetukset.esittely_tuomioidenVäliMax);
        console.log("- rikosten väli max: " + asetukset.esittely_rikostenVäliMax);
        console.log("- mh-todennäköisyys: " + asetukset.esittely_mhTodennäköisyys);
        console.log("- mh-tuomioiden väli max: " + asetukset.esittely_mhVäliMax);
    } else {
        if (muokkaukset.uudenTuomionPvm + muokkaukset.uudenTuomionRikokset + muokkaukset.poistettavaTuomio
            + muokkaukset.poistettavatRikoksetTuomio + muokkaukset.poistettavatRikokset
            + muokkaukset.muokattavaTuomio + muokkaukset.muokattavaTuomioRikokset
            + muokkaukset.tuomioEhdottomaksi + muokkaukset.tuomioEhdottomaksiPvm != "") {
            console.log("Käyttäjän määrittämät rikosrekisteriotteen muokkaukset:");
        } else {
            console.log("Käyttäjä ei ole määrittänyt rikosrekisteriotteen muokkauksia");
        }
        if (muokkaukset.uudenTuomionPvm != "") {
            console.log("- uuden tuomion antopvm: " + muokkaukset.uudenTuomionPvm);
        }
        if (muokkaukset.uudenTuomionRikokset != "") {
            console.log("- uuden tuomion rikokset:\n" + muokkaukset.uudenTuomionRikokset);
        }
        if (muokkaukset.poistettavaTuomio != "") {
            console.log("- poistettavan tuomion nro: " + muokkaukset.poistettavaTuomio);
        }
        if (muokkaukset.poistettavatRikoksetTuomio != "") {
            console.log("- rikosten poistaminen, tuomion nro: " + muokkaukset.poistettavatRikoksetTuomio);
        }
        if (muokkaukset.poistettavatRikokset != "") {
            console.log("- rikosten poistaminen, syytekohdat: " + muokkaukset.poistettavatRikokset);
        }
        if (muokkaukset.muokattavaTuomio != "") {
            console.log("- rikosten lisääminen, tuomion nro: " + muokkaukset.muokattavaTuomio);
        }
        if (muokkaukset.muokattavaTuomioRikokset != "") {
            console.log("- rikosten lisääminen, rikokset:\n" + muokkaukset.muokattavaTuomioRikokset);
        }
        if (muokkaukset.tuomioEhdottomaksi != "") {
            console.log("- tuomio ehdottomaksi, nro: " + muokkaukset.tuomioEhdottomaksi);
        }
        if (muokkaukset.tuomioEhdottomaksiPvm != "") {
            console.log("- tuomio ehdottomaksi, uusi antopvm: " + muokkaukset.tuomioEhdottomaksiPvm);
        }
    }

    // jos käytössä on esittelytila, rikosrekisteriotetta ei voi muokata
    if (asetukset.esittely) {
        muokkaukset = {};
        muokkaukset.muutokset = [];
    }

    // konkurrenssikaavion mittakaava
    let kaavionKoko = 1;
    if (asetukset.isoKaavio) {
        kaavionKoko = 2;
    }

    // seuraaviin taulukoihin tallennetaan RL 7:6:n mukaiset ehdottomat tuomiot ja niiden rikokset
    // (ml. ns. riittävä seuraamus -tuomiot, jotka käsitellään käytännössä kuten ehdottomat)
    let ehdottomatTuomiot = []; // taulukko, joka sisältää ehdottomat tuomiot
    let rikosluetteloEhdottomat = []; // taulukko, joka sisältää ehdottomien tuomioiden rikokset

     // konkurrenssiryhmät määritetään määritäKonkurrenssiryhmät-funktiossa kahden edellisen taulukon pohjalta
    let konkurrenssiryhmät = [];

    // seuraaviin taulukoihin tallennetaan ehdolliset tuomiot (sekä nuorisorangaistukset);
    // ehdolliset eivät vaikuta RL 7:6:n soveltamiseen tai konkurrenssiryhmiin mutta näytetään konkurrenssikaaviossa
    let ehdollisetTuomiot = [];
    let rikosluetteloEhdolliset = [];

    // taulukko käyttäjälle annettavista ilmoituksista koskien tulkinnanvaraisia tilanteita ym.
    let varoitukset = [];

    // taulukko, johon tulee tieto rikosrekisterikyselyn tekijästä (kyselytiedot[0]) ja ajankohdasta (kyselytiedot[1])
    let kyselytiedot = ["", ""];

    aika.alustusValmis = performance.now();

    // luetaan pdf-muotoinen rikosrekisteriote tai luodaan esimerkkirikosrekisteri ja sen jälkeen tehdään
    // rikosrekisterin tietoihin käyttäjän ilmoittamat muutokset (lisätään tai poistetaan tuomioita)

    if (!asetukset.esittely) {

        luePDFRikosrekisteriote(rikosrekisteriote, ehdottomatTuomiot, rikosluetteloEhdottomat, ehdollisetTuomiot,
            rikosluetteloEhdolliset, kyselytiedot, varoitukset, muokkaukset, asetukset.tiivisteet, tiivisteet,
            asetukset.vianhaku, vianhakuHTML);

        if (asetukset.tiivisteet) {
            tiivisteet.luenta = tiiviste(JSON.stringify(ehdottomatTuomiot)
                + JSON.stringify(rikosluetteloEhdottomat) + JSON.stringify(ehdollisetTuomiot)
                + JSON.stringify(rikosluetteloEhdolliset));
        }

    } else {

        // aloitetaan tuomioiden luominen kuluvasta päivästä
        let tuomionPvm = new Date();

        // luodaan ehdottomat tuomiot rikosrekisteriin; funktio palauttaa vanhimman tuomion päivämäärän;
        // viimeinen argumentti (3) määrittää, montako uusimmista tuomioista (ainakin) on lainvoimaa vailla
        tuomionPvm = luoEsimerkkiRikosrekisteriote(ehdottomatTuomiot, rikosluetteloEhdottomat, tuomionPvm,
            asetukset.esittely_ehdottomienMäärä, asetukset.esittely_rikostenEnimmäismäärä,
            asetukset.esittely_tuomioidenVäliMax, asetukset.esittely_rikostenVäliMax,
            asetukset.esittely_mhTodennäköisyys, asetukset.esittely_mhVäliMax, 3);

        // luodaan ehdolliset tuomiot em. päivämäärästä taaksepäin
        luoEsimerkkiRikosrekisteriote(ehdollisetTuomiot, rikosluetteloEhdolliset, tuomionPvm,
            asetukset.esittely_ehdollistenMäärä, asetukset.esittely_rikostenEnimmäismäärä,
            asetukset.esittely_tuomioidenVäliMax, asetukset.esittely_rikostenVäliMax,
            asetukset.esittely_mhTodennäköisyys, asetukset.esittely_mhVäliMax, 0);

    }

    aika.rikosrekisterioteLuettuTaiLuotu = performance.now();

    // tutkitaan rikosrekisteri ja laaditaan tuloste
    // tulosteen sisältö määräytyyy sen mukaan, onko rikosrekisterissä ehdottomia tuomioita

    if (rikosluetteloEhdottomat.length > 0) {

        // lajitellaan rikosrekisterin sisältö (pdf:ssä tai muussa lähteessä ei välttämättä oikeassa järjestyksessä)
        lajitteleTuomiot(ehdottomatTuomiot, rikosluetteloEhdottomat);

        // määritetään konkurrenssiryhmät
        määritäKonkurrenssiryhmät(ehdottomatTuomiot, rikosluetteloEhdottomat, konkurrenssiryhmät, varoitukset);

        if (asetukset.tiivisteet) {
            tiivisteet.konkurrenssiryhmät = tiiviste(JSON.stringify(konkurrenssiryhmät));
        }

        // luodaan tuomiokohtaiset luettelot rikosten konkurrenssiryhmistä konkurrenssilausuntojen luomiseksi
        valmisteleKonkurrenssilausunnot(ehdottomatTuomiot, rikosluetteloEhdottomat, varoitukset,
            asetukset.lausuntoKaikille);

        if (asetukset.tiivisteet) {
            tiivisteet.lausunnot = tiiviste(JSON.stringify(ehdottomatTuomiot)
                + JSON.stringify(rikosluetteloEhdottomat));
        }

        // käydään läpi rikosrekisteri sen tarkistamiseksi, onko samana päivänä annettu useampia tuomioita
        etsiTuomioidenPäällekkäisyydet(ehdottomatTuomiot, konkurrenssiryhmät, varoitukset);

        // lasketaan konkurrenssiryhmittäiset kokonaisrangaistukset
        laskeKokonaisrangaistukset(ehdottomatTuomiot, konkurrenssiryhmät, varoitukset);

        aika.konkurrenssiryhmätMääritetty = performance.now();

        // tulostetaan otsikko- ym. tiedot, rikosrekisteriotteen tiedot ja asetukset
        tulostaJohdanto(kyselytiedot, asetukset, Math.trunc(aika.konkurrenssiryhmätMääritetty
            - aika.rikosrekisterioteLuettuTaiLuotu), tulosteHTML, tulosteHTMLheader);

        // tulostetaan rikosrekisteriin tehdyt muutokset sekä varoitukset/virheilmoitukset
        tulostaMuutoksetJaVaroitukset(muokkaukset.muutokset, varoitukset, tulosteHTML);

        // tulostetaan rikosrekisterin ehdottomat tuomiot konkurrenssimerkinnöin
        tulostaEhdottomatTuomiot(ehdottomatTuomiot, rikosluetteloEhdottomat, asetukset.lausuntoLyhyt,
            asetukset.lausuntoKeskipitkä, asetukset.lausuntoPitkä, asetukset.lausuntoKaikille, tulosteHTML);

        // tulostetaan tuomiot ja rikokset konkurrenssiryhmittäin
        tulostaKonkurrenssiryhmät(ehdottomatTuomiot, rikosluetteloEhdottomat, konkurrenssiryhmät, tulosteHTML);

        // jos konkurrenssikaavioon ei haluta ehdollisia ja nuorisorangaistuksia, tyhjennetään ao. taulukot
        if (!asetukset.ehdollisetKaaviossa) {
            ehdollisetTuomiot = [];
            rikosluetteloEhdolliset = [];
        }

        // tulostetaan konkurrenssikaavio eli "tikapuut"
        tulostaKonkurrenssikaavio(ehdottomatTuomiot, rikosluetteloEhdottomat, ehdollisetTuomiot,
            rikosluetteloEhdolliset, asetukset.mhKaaviossa, asetukset.värillinenKaavio, kaavionKoko, tulosteHTML);

    } else {

        // jos rikosrekisterissä ei ole ehdottomia tuomioita, tulostetaan enintään konkurrenssikaavio

        // tulostetaan otsikko- ym. tiedot, rikosrekisteriotteen tiedot ja asetukset
        // (kun konkurrenssiryhmien analysoinnin kestoksi annetaan negatiivinen arvo, tietoa ei tulosteta)
        tulostaJohdanto(kyselytiedot, asetukset, -1, tulosteHTML, tulosteHTMLheader);

        // tulostetaan varoitukset/virheilmoitukset
        tulostaMuutoksetJaVaroitukset(muokkaukset.muutokset, varoitukset, tulosteHTML);

        // tulostetaan ilmoitukset siitä, että rikosrekisteristä ei löydetty (ehdottomia) tuomioita

        if (ehdollisetTuomiot.length == 0) {

            tulosteHTML.push("<h2>Rikosrekisteriotteelta ei löydetty tuomioita</h2>\n\n");
            tulosteHTML.push("<p>Konkurrenssikone ei havainnut tuomioita, jotka olisivat RL 7:6:n mukaisesti "
                + "huomioon otettavia (ehdottomat vankeustuomiot sekä ykp- ja valvontarangaistustuomiot). "
                + "Myöskään konkurrenssikaaviossa esitettäviä muita tuomioita (ehdolliset vankeustuomiot "
                + "ja nuorisorangaistustuomiot) ei havaittu. Tarkista alkuperäisestä rikosrekisteriotteesta, "
                + "että tuomioita ei ole.</p>\n\n");

        } else {

            tulosteHTML.push("<h2>Rikosrekisteriotteelta ei löydetty ehdottomia vankeustuomioita</h2>\n\n");
            tulosteHTML.push("<p>Konkurrenssikone ei havainnut tuomioita, jotka olisivat RL 7:6:n mukaisesti "
                + "huomioon otettavia (ehdottomat vankeustuomiot sekä ykp- ja valvontarangaistustuomiot). "
                + "Tarkista alkuperäisestä rikosrekisteriotteesta, että tällaisia tuomioita ei ole.</p>\n\n");

            if (asetukset.ehdollisetKaaviossa) {

                tulosteHTML.push("<p>Konkurrenssikaaviossa esitetään kuitenkin rikosrekisteriotteesta havaitut "
                    + "ehdolliset vankeustuomiot ja/tai nuorisorangaistustuomiot.</p>\n\n");
                tulostaKonkurrenssikaavio(ehdottomatTuomiot, rikosluetteloEhdottomat, ehdollisetTuomiot,
                    rikosluetteloEhdolliset, asetukset.mhKaaviossa, asetukset.värillinenKaavio, kaavionKoko,
                    tulosteHTML);

            } else {

                tulosteHTML.push("<p>Konkurrenssikone on kuitenkin havainnut ainakin yhden ehdollisen tuomion "
                    + "tai nuorisorangaistustuomion, jollaiset voitaisiin näyttää konkurrenssikaaviossa. "
                    + "Konkurrenssikoneen asetusten mukaan tällaiset tuomiot jätetään kuitenkin pois "
                    + "konkurrenssikaaviosta. Tämän vuoksi myöskään konkurrenssikaaviota ei tulosteta.</p>\n\n");
            }
        }

    }

    // yhdistetään tulostetaulukoiden tiedot yksittäisiksi merkkijonoiksi

    for (let i = 0; i < tulosteHTMLheader.length; i++) {
        tulosteHTMLhead += tulosteHTMLheader[i];
    }

    for (let i = 0; i < tulosteHTML.length; i++) {
        tulosteHTMLbody += tulosteHTML[i];
    }

    for (let i = 0; i < vianhakuHTML.length; i++) {
        vianhakuHTMLlopullinen += vianhakuHTML[i];
    }

    aika.valmis = performance.now();

    // tulostetaan konsoliin tiedot eri vaiheiden kestosta

    if (rikosluetteloEhdottomat.length > 0) {

        console.log("Konkurrenssikone valmis. Toimenpiteiden kesto millisekunteina:");
        console.log("- alustus " + Math.round(aika.alustusValmis - aika.aloitettu) + " ms");
        if (!asetukset.esittely) {
            console.log("- pdf-muotoisen rikosrekisterin luenta "
                + Math.round(aika.rikosrekisterioteLuettuTaiLuotu - aika.alustusValmis) + " ms");
        } else {
            console.log("- esimerkkirikosrekisterin luonti "
                + Math.round(aika.rikosrekisterioteLuettuTaiLuotu - aika.alustusValmis) + " ms");
        }
        console.log("- konkurrenssiryhmien määrittäminen "
            + Math.round(aika.konkurrenssiryhmätMääritetty - aika.rikosrekisterioteLuettuTaiLuotu) + " ms");
        console.log("- konkurrenssikoneen tulosteen laatiminen "
            + Math.round(aika.valmis - aika.konkurrenssiryhmätMääritetty) + " ms");
        console.log("- koko aika " + Math.round(aika.valmis - aika.aloitettu) + " ms.");
        console.log("--------------------");

    } else {

        console.log("Konkurrenssikone valmis. Huomioon otettavia ehdottomia tuomioita ei löydetty. "
            + "Toimenpiteiden kesto millisekunteina:");
        console.log("- alustus " + Math.round(aika.alustusValmis - aika.aloitettu) + " ms");
        if (!asetukset.esittely) {
            console.log("- pdf-muotoisen rikosrekisterin luenta "
                + Math.round(aika.rikosrekisterioteLuettuTaiLuotu - aika.alustusValmis) + " ms");
        } else {
            console.log("- esimerkkirikosrekisterin luonti "
                + Math.round(aika.rikosrekisterioteLuettuTaiLuotu - aika.alustusValmis) + " ms");
        }
        console.log("- konkurrenssikoneen tulosteen laatiminen "
            + Math.round(aika.valmis - aika.rikosrekisterioteLuettuTaiLuotu) + " ms");
        console.log("- koko aika " + Math.round(aika.valmis - aika.aloitettu) + " ms.");
        console.log("--------------------");

    }

    return [tulosteHTMLhead, tulosteHTMLbody, vianhakuHTMLlopullinen];

}

// ********************************************************************************************************************
// Rikos:
// konstruktori rikokselle
// ********************************************************************************************************************

function Rikos(pvm, syytekohta, nimike, tuomionro, konkurrenssiryhmänro, pitkäTekoaika, alkupvm, pvmTeksti,
    pvmEpäselvä) {

    // rikoksen perustiedot: tekopäivä, syytekohta ja rikosnimike
    this.pvm = pvm;
    this.syytekohta = syytekohta;
    this.nimike = nimike;

    // sen tuomion numero, jossa rikos on luettu syyksi
    this.tuomionro = tuomionro;

    // sen konkurrenssiryhmän numero, johon rikos kuuluu
    this.konkurrenssiryhmänro = konkurrenssiryhmänro;

    // onko kyseessä ns. pitkä tekoaika, jolla on erillinen alkupäivämäärä (true/false)
    this.pitkäTekoaika = pitkäTekoaika;

    // pitkän tekoajan alkupäivämäärä
    this.alkupvm = alkupvm;

    // onko kyseessä tulkinnanvarainen tekoaika, esim. "kevät 2005" (true/false)
    this.pvmEpäselvä = pvmEpäselvä;

    // tulkinnanvarainen tekoaika tekstimuodossa
    this.pvmTeksti = pvmTeksti;

}

// ********************************************************************************************************************
// Rikos.tekoaikaTekstinä:
// funktio, joka palauttaa tekoajan tekstimuodossa taulukkona: [pvm tekstinä, tulkinnanvaraisen ajankohdan tarkka pvm]
// ********************************************************************************************************************

Rikos.prototype.tekoaikaTekstinä = function () {

    // jos tekoaika on pitkä (alkupvm:stä pvm:ään), se ei ole tulkinnanvarainen
    if (this.pitkäTekoaika) {
        return [ajanjaksoTekstiksi(this.alkupvm, this.pvm), ""];
    }

    // jos tekoaika on tulkinnanvarainen (esim. "alkuvuosi 2009"), palautetaan sekä tekstimuotoinen pvm
    // että siitä tulkittu tarkka pvm; muussa tapauksessa palautetaan tekstimuotoinen pvm (johon sisältyy
    // tarkka pvm, esim. "10.-11.2.1993" tai "10. ja 11.2.1993 välinen yö") tai toissijaisesti tarkka pvm
    if (this.pvmEpäselvä) {
        return [this.pvmTeksti, pvmTekstiksi(this.pvm)];
    } else if (this.pvmTeksti == undefined || this.pvmTeksti == "") {
        return [pvmTekstiksi(this.pvm), ""];
    } else {
        return [this.pvmTeksti, ""];
    }

}

// ********************************************************************************************************************
// Tuomio:
// konstruktori tuomiolle
// ********************************************************************************************************************

function Tuomio(pvm, tuomioistuin, ratkaisunro, rangaistus, lainvoimaisuus, katkaisevaTuomio,
    pvm1, tuomioistuin1, ratkaisunro1, pvm2, tuomioistuin2, ratkaisunro2, pvm3, tuomioistuin3, ratkaisunro3,
    lainvoimaisuusLisätieto) {

    // tuomion perustiedot
    this.pvm = pvm;
    this.tuomioistuin = tuomioistuin;
    this.ratkaisunro = ratkaisunro;
    this.rangaistus = rangaistus;
    this.lainvoimaisuus = lainvoimaisuus;
    this.lainvoimaisuusLisätieto = lainvoimaisuusLisätieto;

    // tiedot eri oikeusasteiden tuomioista;
    // katkaisevaTuomio osoittaa, onko konkurrenssin kannalta ratkaiseva oikeusaste 1, 2 vai 3;
    // kyseisen oikeusasteen tuomion tiedot ovat myös yllä olevissa pvm-, tuomioistuin- ja ratkaisunro-muuttujissa
    this.katkaisevaTuomio = katkaisevaTuomio;
    this.pvm1 = pvm1;
    this.tuomioistuin1 = tuomioistuin1;
    this.ratkaisunro1 = ratkaisunro1;
    this.pvm2 = pvm2;
    this.tuomioistuin2 = tuomioistuin2;
    this.ratkaisunro2 = ratkaisunro2;
    this.pvm3 = pvm3;
    this.tuomioistuin3 = tuomioistuin3;
    this.ratkaisunro3 = ratkaisunro3;

    // taulukko, jossa on viittaukset rikosten numeroihin
    this.rikokset = [];

    // tieto siitä, onko kyseessä konkurrenssin katkaiseva tuomio (määritetään myöhemmin erikseen)
    this.konkurrenssiryhmänro = null;

    // luettelo tuomiossa edustetuista konkurrenssiryhmistä (määritetään myöhemmin erikseen)
    this.konkurrenssiryhmät = [];

    // luettelot tuomion rikoksista, jotka ovat tiettyä konkurrenssiryhmää
    // (määritetään erikseen; sisältää taulukoita, joiden indeksit tässä taulukossa vastavat edellistä)
    this.konkurrenssiryhmienRikokset = [];

    // luettelo muista tuomioista, jotka ovat tietyn konkurrenssiryhmän huomioon otettavia tuomioita
    // (määritetään erikseen; sisältää taulukoita, joiden indeksit tässä taulukossa vastaavat kahta edellistä)
    this.konkurrenssiryhmienHuomioonOtettavatTuomiot = [];

    // luettelo huomioon otettavista tuomioista (ilman konkurrenssiryhmittäistä erittelyä)
    this.huomioonOtettavatTuomiot = [];

    // luettelo huomioon otettavien tuomioiden rikoksista, jotka ovat samoja konkurrenssiryhmiä kuin tässä tuomiossa
    this.huomioonOtettavanRikokset = [];

}

// ********************************************************************************************************************
// Tuomio.pisinNimi:
// funktio, jonka palauttaman taulukon ensimmäisenä elementtinä [0] on konkurrenssin kannalta merkityksellisen
// oikeusasteen tuomion indeksi ja muina elementteinä (joita on 1, 2 tai 3 kpl) eri oikeusasteiden tuomioiden nimet
// pitkässä muodossa
// ********************************************************************************************************************

Tuomio.prototype.pisinNimi = function() {
    let kokonimi = [];
    kokonimi[0] = this.katkaisevaTuomio;
    kokonimi[1] = this.tuomioistuin1 + " " + pvmTekstiksi(this.pvm1) + " no&nbsp;" + this.ratkaisunro1;
    if (this.tuomioistuin2 != "") {
        kokonimi[2] = this.tuomioistuin2 + " " + pvmTekstiksi(this.pvm2) + " no&nbsp;" + this.ratkaisunro2;
        if (this.tuomioistuin3 != "") {
            kokonimi[3] = this.tuomioistuin3 + " " + pvmTekstiksi(this.pvm3) + " no&nbsp;" + this.ratkaisunro3;
        }
    }
    return kokonimi;
}

// ********************************************************************************************************************
// Tuomio.pidempiNimi:
// funktio, joka palauttaa taulukon, joka vastaa muuten pisinNimi-funktiota,
// mutta tuomioiden nimet on lyhennetty (KO -> käräjäoikeus jne.)
// ********************************************************************************************************************

Tuomio.prototype.pidempiNimi = function() {
    let kokonimi = this.pisinNimi();
    for (let i = 1; i < kokonimi.length; i++) {
        kokonimi[i] = lyhennäTuomionTiedot(kokonimi[i]);
    }
    return kokonimi;
}

// ********************************************************************************************************************
// Tuomio.pitkäNimi:
// funktio, joka palauttaa merkkijonona tuomion nimen, jossa eri oikeusasteet on mainittu;
// jos ensimmäinen argumentti on true, lopussa ilmoitetaan, onko kyseessä ns. riittävä seuraamus -tuomio;
// jos annetaan toinen argumentti eli katkaisupvm, katkaistaan tulostus ko. päivämäärään
// ********************************************************************************************************************

Tuomio.prototype.pitkäNimi = function(onkoRiittavaSeuraamus, katkaisupvm) {

    let kokonimi;

    if (katkaisupvm == undefined) {

        kokonimi = this.tuomioistuin1 + " " + pvmTekstiksi(this.pvm1) + " no&nbsp;" + this.ratkaisunro1;

        if (this.tuomioistuin2 != "") {
            kokonimi += " (";
            kokonimi += this.tuomioistuin2 + " " + pvmTekstiksi(this.pvm2) + " no&nbsp;" + this.ratkaisunro2;
            if (this.tuomioistuin3 != "") {
                kokonimi += ", ";
                kokonimi += this.tuomioistuin3 + " " + pvmTekstiksi(this.pvm3) + " no&nbsp;" + this.ratkaisunro3;
            }
            kokonimi += ")";
        }

    } else {

        if (this.tuomioistuin2 == "") {
            if (this.pvm1 > katkaisupvm) {
                kokonimi = "[tuomio annettu vasta " + pvmTekstiksi(katkaisupvm) + " jälkeen]";
            } else {
                kokonimi = this.tuomioistuin1 + " " + pvmTekstiksi(this.pvm1) + " no&nbsp;" + this.ratkaisunro1;
            }
        } else {
            if (this.tuomioistuin3 == "") {
                if (this.pvm1 > katkaisupvm) {
                    kokonimi = this.tuomioistuin2 + " " + pvmTekstiksi(this.pvm2) + " no&nbsp;" + this.ratkaisunro2;
                } else {
                    kokonimi = this.tuomioistuin1 + " " + pvmTekstiksi(this.pvm1) + " no&nbsp;" + this.ratkaisunro1;
                    kokonimi += " (";
                    kokonimi += this.tuomioistuin2 + " " + pvmTekstiksi(this.pvm2) + " no&nbsp;" + this.ratkaisunro2;
                    kokonimi += ")";
                }
            } else {
                if (this.pvm2 > katkaisupvm) {
                    kokonimi = this.tuomioistuin3 + " " + pvmTekstiksi(this.pvm3) + " no&nbsp;" + this.ratkaisunro3;
                } else {
                    if (this.pvm1 > katkaisupvm) {
                        kokonimi = this.tuomioistuin2 + " " + pvmTekstiksi(this.pvm2) + " no&nbsp;"
                            + this.ratkaisunro2;
                        kokonimi += " (";
                        kokonimi += this.tuomioistuin3 + " " + pvmTekstiksi(this.pvm3) + " no&nbsp;"
                            + this.ratkaisunro3;
                        kokonimi += ")";
                    } else {
                        kokonimi = this.tuomioistuin1 + " " + pvmTekstiksi(this.pvm1) + " no&nbsp;"
                            + this.ratkaisunro1;
                        kokonimi += " (";
                        kokonimi += this.tuomioistuin2 + " " + pvmTekstiksi(this.pvm2) + " no&nbsp;"
                            + this.ratkaisunro2;
                        kokonimi += ", ";
                        kokonimi += this.tuomioistuin3 + " " + pvmTekstiksi(this.pvm3) + " no&nbsp;"
                            + this.ratkaisunro3;
                        kokonimi += ")";
                    }
                }
            }
        }

    }

    if (onkoRiittavaSeuraamus && this.rangaistus == "Riittävä seuraamus") {
        kokonimi += " [riittävä seuraamus -tuomio]";
    }

    return kokonimi;

}

// ********************************************************************************************************************
// Tuomio.lyhytNimi:
// funktio, joka palauttaa merkkijonona lyhyen version tuomion nimestä
// (vain konkurrenssin kannalta merkityksellisen oikeusasteen tuomion tiedot)
// ********************************************************************************************************************

Tuomio.prototype.lyhytNimi = function() {
    // ratkaisunro voi olla 0, jos annetaan varoitus ulkomaisesta tuomiosta
    // (ulkomaisille tuomioille ei välttämättä ole merkitty ratkaisunroa rikosrekisteriin)
    if (this.ratkaisunro != 0) {
        return this.tuomioistuin + " " + pvmTekstiksi(this.pvm) + " no&nbsp;" + this.ratkaisunro;
    } else {
        return this.tuomioistuin + " " + pvmTekstiksi(this.pvm);
    }
}

// ********************************************************************************************************************
// Tuomio.lyhyinNimi:
// funktio, joka palauttaa merkkijonona lyhyimmän version tuomion nimestä
// (kuten lyhytNimi-funktio mutta ilman ratkaisunumeroa)
// ********************************************************************************************************************

Tuomio.prototype.lyhyinNimi = function() {
    return lyhennäTuomionTiedot(this.tuomioistuin + " " + pvmTekstiksi(this.pvm));
}

// ********************************************************************************************************************
// Tuomio.viimeinenPvm:
// funktio, joka palauttaa tuomion viimeisen oikeusasteen ratkaisupäivämäärän
// ********************************************************************************************************************

Tuomio.prototype.viimeinenPvm = function() {
    let viimeinen = new Date(this.pvm1.getTime());
    if (this.tuomioistuin2 != "" && this.pvm2 > viimeinen) {
        viimeinen = new Date(this.pvm2.getTime());
    }
    if (this.tuomioistuin3 != "" && this.pvm3 > viimeinen) {
        viimeinen = new Date(this.pvm3.getTime());
    }
    return viimeinen;
}

// ********************************************************************************************************************
// Konkurrenssiryhmä:
// konstruktori konkurrenssiryhmälle
// ********************************************************************************************************************

function Konkurrenssiryhmä(pvm, tuomionro) {
    this.pvm = pvm;                 // konkurrenssiryhmän päättymispäivä
    this.tuomionro = tuomionro;     // konkurrenssin katkaisevan tuomion numero
    this.kokonaisrangaistus = {     // konkurrenssiryhmän rangaistusten yhteismäärä ja siihen liittyen:
        v: 0, kk: 0, pv: 0,
    };
    this.onkoEriKonkRyhmiä = false; // onko ryhmässä tuomioita, joissa on useiden ryhmien rikoksia
    this.onkoUuttaTuomiota = false; // onko ryhmässä käyttäjän lisäämää uutta tuomiota
    this.onkoElinkautista = false;  // onko ryhmässä elinkautista vankeutta
}


// ********************************************************************************************************************
// lajitteleTuomiot:
// funktio, joka lajittelee tuomiot aikajärjestykseen ennen konkurrenssiryhmien määrittämistä
// ********************************************************************************************************************

function lajitteleTuomiot(tuomiot, rikosluettelo) {

    console.log("Tuomioiden lajittelu aikajärjestykseen alkaa");

    // tuomiot lajitellaan aikajärjestykseen vanhimmasta uusimpaan; lajittelussa on otettava huomioon, että
    // rikosluettelossa olevat viittaukset tuomionumeroihin on myös päivitettävä vastaamaan lajittelun tulosta

    // lajittelun apuvälineenä käytettävä taulukko
    let lajittelu = [];

    for (let i = 0; i < tuomiot.length; i++) {
        lajittelu.push([i, new Date(tuomiot[i].pvm)]);
        // lajittelu[n][0] = tuomion n nro (indeksi); lajittelu[n][1] = tuomion n pvm
    }

    // nyt lajittelu-taulukko vastaa pvm:n osalta tuomiot-taulukkoa ja sisältää tiedon tuomion alkuperäisestä numerosta

    // lajitellaan taulukot

    lajittelu.sort(function(a, b) {return a[1] - b[1]});

    tuomiot.sort(function(a, b) {return a.pvm - b.pvm});

    // korjataan rikosluettelon viittaukset tuomioihin käyttämällä lajittelu-taulukon tietoja

    for (let i = 0; i < rikosluettelo.length; i++) {
        let j = 0;
        let korjattu = false;
        do {
            if (rikosluettelo[i].tuomionro == lajittelu[j][0]) {
                rikosluettelo[i].tuomionro = j;
                korjattu = true;
            }
            j++;
        }
        while (j < lajittelu.length && !korjattu);
    }

    console.log("Tuomioiden lajittelu aikajärjestykseen valmis");

}

// ********************************************************************************************************************
// määritäKonkurrenssiryhmät:
// funktio, joka analysoi rikosrekisterin ja määrittää konkurrenssiryhmät
// ********************************************************************************************************************

function määritäKonkurrenssiryhmät(tuomiot, rikosluettelo, konkurrenssiryhmät, varoitukset) {

    console.log("Rikosrekisterin analysointi ja konkurrenssiryhmien määrittäminen alkaa");

    // käydään läpi tuomiot (tuomiot-taulukko, silmukka i) ja niissä olevat rikokset
    // (tuomiot[i].rikokset-taulukko, silmukka j) ja verrataan rikosten päivämäärää aiempien konkurrenssiryhmien
    // päivämääriin (konkurrenssiryhmät-taulukko, silmukka k)

    for (let i = 0; i < tuomiot.length; i++) { // käydään läpi tuomiot (i)

        // apumuuttuja, jossa tieto siitä, katkaiseeko käsiteltävänä oleva tuomio konkurrenssin
        let tuomioKatkaiseeKonkurrenssin = false;

        // käydään läpi kaikki käsiteltävänä olevan tuomion rikokset (j)

        for (let j = 0; j < tuomiot[i].rikokset.length; j++) {

            // seuraava määrittely on vain koodin luettavuuden parantamiseksi
            let rikos = rikosluettelo[tuomiot[i].rikokset[j]];

            // kunkin rikoksen kohdalla käydään läpi aiemmat konkurrenssiryhmät

            for (let k = 0; k < konkurrenssiryhmät.length; k++) {

                // tarkistetaan, kuuluuko rikos aiempaan konkurrenssiin:
                // jos konkurrenssiryhmä on vielä null, rikos ei ole sopinut aiempiin konkurrenssiryhmiin;
                // kun oikea konkurrenssiryhmä on löytynyt ja merkitty, arvo ei ole enää null eikä ko. ehto voi täyttyä

                if (rikos.konkurrenssiryhmänro == null && rikos.pvm <= konkurrenssiryhmät[k].pvm) {

                    rikos.konkurrenssiryhmänro = k; // jos kuuluu, niin tämä merkitään ko. rikoksen tietoihin

                    // tarkistetaan, onko rikos tehty samana päivänä kuin konkurrenssin katkaiseva tuomio,
                    // ja annetaan tästä varoitus

                    if (rikos.pvm.toDateString() === konkurrenssiryhmät[k].pvm.toDateString()) {

                        // seuraava määritys on vain koodin luettavuuden parantamiseksi
                        let katkaisevanTuomionNro = tuomiot[konkurrenssiryhmät[k].tuomionro];

                        varoitukset.push("Tuomioon <i>" + tuomiot[i].lyhytNimi() + "</i>"
                            + " kuuluva rikos (<i>" + rikos.syytekohta + " " + rikos.nimike + "</i>) on tehty "
                            + pvmTekstiksi(rikos.pvm) + " eli samana päivänä kuin konkurrenssin katkaiseva tuomio "
                            + "<i>" + katkaisevanTuomionNro.tuomioistuin + " no&nbsp;"
                            + katkaisevanTuomionNro.ratkaisunro + "</i> on annettu tai julistettu; tarkista "
                            + "konkurrenssi tältä osin");

                    }

                }

            }

            // uusi konkurrenssiryhmä muodostuu, jos rikosta ei ole merkitty mihinkään aiempaan konkurrenssiryhmään

            if (rikos.konkurrenssiryhmänro == null) {

                tuomioKatkaiseeKonkurrenssin = true;
                rikos.konkurrenssiryhmänro = konkurrenssiryhmät.length;

            }

        }

        // jos kyseessä on konkurrenssin katkaiseva tuomio:

        if (tuomioKatkaiseeKonkurrenssin) {

            // käsiteltävänä olevan tuomion tietoihin merkitään, että se muodostaa uuden konkurrenssiryhmän
            tuomiot[i].konkurrenssiryhmänro = konkurrenssiryhmät.length;

            // lisätään uusi konkurrenssiryhmä, jolla on nyt käsiteltävää tuomiota vastaavat tiedot
            // (pvm, järjestysnro)
            konkurrenssiryhmät.push(new Konkurrenssiryhmä(new Date(tuomiot[i].pvm.getTime()), i));

            // tarkistetaan, onko konkurrenssin katkaisevassa tuomiossa kyse riittävä seuraamus -tuomiosta,
            // ja jos on, annetaan tästä varoitus
            if (tuomiot[i].rangaistus.includes("Riittävä")) {
                varoitukset.push("Tuomio <i>" + tuomiot[i].lyhytNimi() + "</i> on määrittynyt konkurrenssin "
                    + "katkaisevaksi, minkä ei kuitenkaan pitäisi olla mahdollista, sillä kyseessä on "
                    + "ns.&nbsp;riittävä seuraamus -tuomio. Tarkista rikosrekisteri- ja konkurrenssitietojen "
                    + "oikeellisuus.");
            }

        }

    }

    console.log("Rikosrekisterin analysointi ja konkurrenssiryhmien määrittäminen valmis. "
        + "Konkurrenssiryhmien määrä: " + konkurrenssiryhmät.length);

}

// ********************************************************************************************************************
// valmisteleKonkurrenssilausunnot:
// funktio, joka luo tuomiokohtaiset luettelot rikosten konkurrenssiryhmistä konkurrenssilausuntojen luomiseksi
// ********************************************************************************************************************

function valmisteleKonkurrenssilausunnot(tuomiot, rikosluettelo, varoitukset, lausuntoKaikille) {

    console.log("Konkurrenssilausuntojen valmistelu alkaa");

    // tehdään luettelot kunkin tuomion konkurrenssiryhmistä ja siitä, mitä rikoksia niihin kuuluu

    // käydään läpi kaikki tuomiot (i)
    for (let i = 0; i < tuomiot.length; i++) {

        // käydään läpi tuomion kaikki rikokset (j)
        for (let j = 0 ; j < tuomiot[i].rikokset.length; j++) {

            // seuraava määritys on vain koodin luettavuuden parantamiseksi
            let rikos = rikosluettelo[tuomiot[i].rikokset[j]];

            // jos rikoksen konkurrenssiryhmää ei ole vielä konkurrenssiryhmäluettelossa, lisätään se
            // (ja vastaavasti tyhjä taulukko konkurrenssiryhmän rikosten luetteloon)
            if (tuomiot[i].konkurrenssiryhmät.indexOf(rikos.konkurrenssiryhmänro) == -1) {
                tuomiot[i].konkurrenssiryhmät.push(rikos.konkurrenssiryhmänro);
                tuomiot[i].konkurrenssiryhmienRikokset.push([]);
            }

            // lisätään nyt käsiteltävän rikoksen syytekohta (tulostettava tieto) konkurrenssiryhmän
            // rikosten luetteloon konkurrenssiryhmäluetteloa vastaavaan kohtaan
            tuomiot[i].konkurrenssiryhmienRikokset[tuomiot[i].konkurrenssiryhmät
                .indexOf(rikos.konkurrenssiryhmänro)].push(rikos.syytekohta);

        }

    }

    // täydennetään em. luetteloita lisäämällä niihin luettelot tuomioista, joissa on samoja konkurrenssiryhmiä;
    // lähtökohtaisesti käydään läpi aiemmat tuomiot, mutta myös myöhemmät tuomiot on tutkittava,
    // koska ne voivat olla ns. jälkituomioita (KKO 2018:72)

    // käydään läpi kaikki tuomiot (i)
    for (let i = 0; i < tuomiot.length; i++) {

        // käydään jokaisen tuomion kohdalla läpi kaikki siinä olevat konkurrenssiryhmät (j)
        for (let j = 0; j < tuomiot[i].konkurrenssiryhmät.length; j++) {

            // lisätään konkurrenssiryhmienHuomioonOtettavatTuomiot-taulukkoon tyhjä taulukko
            // vastaamaan ao. konkurrenssiryhmää
            tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot.push([]);

            // käydään läpi kaikki muut tuomiot (k)
            for (let k = 0; k < tuomiot.length; k++) {

                // tarkistetaan siis ensin, että tarkasteltava tuomio (k) ei ole nyt läpikäytävä tuomio (i)
                if (k != i) {

                    // tarkasteltava tuomio (k) on mahdollisesti huomioon otettava tuomio, jos:
                    // - tuomio (k) on annettu aiemmin kuin nyt läpikäytävä tuomio (i) TAI
                    // - nyt läpikäytävä tuomio (i) on lainvoimaa vailla (jolloin kaikki olemassa olevat tuomiot
                    //   voidaan ottaa jälkituomioina huomioon) TAI
                    // - tuomio (k) on annettu (konkurrenssin kannalta merkityksellisessä mielessä) viimeistään
                    //   sinä päivänä, jolloin nyt läpikäytävä tuomio (i) on ratkaistu viimeisessä oikeusasteessa
                    //   (viimeksi mainitun päivän jälkeisiä tuomioita ei ole voitu ottaa i:ssä huomioon)

                    if (k < i || !tuomiot[i].lainvoimaisuus || tuomiot[k].pvm <= tuomiot[i].viimeinenPvm()) {

                        // onko muun tuomion (k) konkurrenssiryhmissä nyt käsiteltävää konkurrenssiryhmää (j)?
                        if (tuomiot[k].konkurrenssiryhmät.indexOf(tuomiot[i].konkurrenssiryhmät[j]) != -1) {

                            // jos on, lisätään muu tuomio (k) nyt käsiteltävän konkurrenssiryhmän (j) kohdalle
                            // konkurrenssiryhmienHuomioonOtettavatTuomiot-taulukkoon
                            tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot[j].push(k);

                            // jos asetusten mukaan konkurrenssilausunto laaditaan myös lainvoimaisille tuomioille,
                            // tarkistetaan, onko huomioon otettavassa tuomiossa (k) muutoksenhaku jatkunut
                            // tuomion (i) lainvoimaiseksi tulleen viimeisen oikeusasteen tuomion jälkeen
                            if (lausuntoKaikille && tuomiot[i].lainvoimaisuus &&
                                tuomiot[i].viimeinenPvm() < tuomiot[k].viimeinenPvm()) {
                                let varoitus = ("Lainvoimaisessa tuomiossa <i>" + tuomiot[i].pitkäNimi() + "</i> "
                                    + "on otettava huomioon <i>" + tuomiot[k].lyhytNimi() + "</i>; "
                                    + "ensin mainitun tuomion viimeisen oikeusasteen tuomion antamispäivän "
                                    + pvmTekstiksi(tuomiot[i].viimeinenPvm()) + " jälkeen "
                                    + "on jälkimmäistä tuomiota koskenut muutoksenhaku: "
                                    + "<i>" + tuomiot[k].pitkäNimi() + "</i>");
                                if (varoitukset.indexOf(varoitus) == -1) {
                                    varoitukset.push(varoitus);
                                }
                            }

                        }

                    }

                }

            }

        }

    }

    // laaditaan edellisten tulosten perusteella tiivistetty luettelo lyhyiden konkurrenssilausuntojen tulostamiseksi

    // käydään läpi kaikki tuomiot (i)
    for (let i = 0; i < tuomiot.length; i++) {

        // käydään jokaisen tuomion kohdalla läpi kaikki siinä olevat konkurrenssiryhmät (j)
        for (let j = 0; j < tuomiot[i].konkurrenssiryhmät.length; j++) {

            // käydään tuomion (i) konkurrenssiryhmän (j) huomioon otettavat tuomiot (k) läpi
            for (let k = 0; k < tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot[j].length; k++) {

                // tarkistetaan, onko huomioon otettava tuomio (k) jo tämän tuomion (i) huomioon otettavien luettelossa
                if (tuomiot[i].huomioonOtettavatTuomiot
                        .indexOf(tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot[j][k]) == -1) {

                    // jos ei ole, lisätään se sinne
                    tuomiot[i].huomioonOtettavatTuomiot
                        .push(tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot[j][k]);

                }

            }

        }

    }

    // laaditaan vielä keskipitkiä konkurrenssilausuntoja varten luettelo tuomioittain huomioon otettavista rikoksista

    // käydään läpi kaikki tuomiot (i)
    for (let i = 0; i < tuomiot.length; i++) {

        // käydään jokaisen tuomion kohdalla läpi kaikki siinä huomioon otettavat tuomiot (j)
        for (let j = 0; j < tuomiot[i].huomioonOtettavatTuomiot.length; j++) {

            // tämä on vain selvyyden vuoksi:
            let aiemmanTuomionRikokset = tuomiot[tuomiot[i].huomioonOtettavatTuomiot[j]].rikokset;

            // lisätään tyhjä taulukko, johon tulee lista huomioon otettavan tuomion mainittavista rikoksista
            tuomiot[i].huomioonOtettavanRikokset.push([]);

            // tarkistetaan läpikäytävän huomioon otettavan tuomion (j) kukin rikos (k) läpi
            for (let k = 0; k < aiemmanTuomionRikokset.length; k++) {

                // tarkistetaan, onko rikos (k) läpikäytävän tuomion (i) konkurrenssiryhmien luettelossa
                if (tuomiot[i].konkurrenssiryhmät.
                    indexOf(rikosluettelo[aiemmanTuomionRikokset[k]].konkurrenssiryhmänro) != -1) {

                    // jos on, lisätään rikoksen syytekohta (tulostettava tieto)
                    // huomioon otettavien rikosten luetteloon
                    tuomiot[i].huomioonOtettavanRikokset[j].push(rikosluettelo[aiemmanTuomionRikokset[k]].syytekohta);

                }

            }

        }

    }

    // lopuksi tarkistetaan, miltä osin lyhyt, keskipitkä ja pitkä konkurrenssilausunto ovat samoja

    // käydään läpi kaikki tuomiot (i)
    for (let i = 0; i < tuomiot.length; i++) {

        // tarkistetaan, onko lyhyt lausunto sama kuin keskipitkä lausunto; näin ei ole, jos yhdenkin aikaisemman
        // huomioon otettavan tuomion (j) kohdalla täytyy eritellä, minkä siinä käsiteltyjen rikosten osalta se
        // on otettava huomioon eli jos keskipitkässä lausunnossa mainittavien rikosten määrä ei ole sama kuin
        // kyseisen tuomion rikosten määrä
        tuomiot[i].lyhytOnKeskipitkä = true;
        for (let j = 0; j < tuomiot[i].huomioonOtettavanRikokset.length; j++) {
            if (tuomiot[i].huomioonOtettavanRikokset[j].length !=
                tuomiot[tuomiot[i].huomioonOtettavatTuomiot[j]].rikokset.length) {
                tuomiot[i].lyhytOnKeskipitkä = false;
            }
        }

        // tarkistetaan, onko keskipitkä lausunto sama kuin pitkä lausunto; näin on, jos tuomion (i) kaikki rikokset
        // ovat samaa konkurrenssiryhmää eli jos tuomion konkurrenssiryhmät-taulukon pituus on 1
        if (tuomiot[i].konkurrenssiryhmät.length == 1) {
            tuomiot[i].keskipitkäOnPitkä = true;
        } else {
            tuomiot[i].keskipitkäOnPitkä = false;
        }

        if (tuomiot[i].lyhytOnKeskipitkä && tuomiot[i].keskipitkäOnPitkä) {
            tuomiot[i].lyhytOnPitkä = true;
        } else {
            tuomiot[i].lyhytOnPitkä = false;
        }

    }

    console.log("Konkurrenssilausuntojen valmistelu valmis");

}

// ********************************************************************************************************************
// etsiTuomioidenPäällekkäisyydet:
// funktio, joka tarkistaa, onko rikosrekisterissä useita (ehdottomia) tuomioita konkurrenssiryhmän päättymispäivällä,
// ja lisää varoitukset-taulukkoon niitä koskevat varoitukset
// ********************************************************************************************************************

function etsiTuomioidenPäällekkäisyydet(tuomiot, konkurrenssiryhmät, varoitukset) {

    console.log("Samana päivänä annettujen konkurrenssin katkaisevien tuomioiden etsintä alkaa");

    // muuttuja, johon luodaan yksi varoitus kerrallaan
    let varoitus = "";

    // käydään läpi kaikki konkurrenssiryhmät (i)
    for (let i = 0; i < konkurrenssiryhmät.length; i++) {

        // tarkistetaan kyseistä konkurrenssiryhmää seuraavat tuomiot (j)
        // (määritäKonkurrenssiryhmät-funktio toimii niin, että jos samalla päivällä on useita konkurrenssin
        // katkaisevia tuomioita, niistä ensimmäinen muodostuu katkaisevaksi tuomioksi ja muut eivät)
        let j = konkurrenssiryhmät[i].tuomionro + 1;

        // käydään läpi seuraavat tuomiot yksi kerrallaan (j) seuraavin ehdoin:
        // - rikosrekisterin loppupäätä ei saa ohittaa
        // - tuomion (j) päivämäärän on oltava konkurrenssiryhmän (i) päättymispäivä
        // - tuomiossa on oltava kyseisen konkurrenssiryhmän rikoksia

        while (j < tuomiot.length && konkurrenssiryhmät[i].pvm.toDateString() == tuomiot[j].pvm.toDateString() &&
            tuomiot[j].konkurrenssiryhmät.indexOf(i) != -1) {

            // jos kaikki ehdot täyttyvät, on löytynyt ainakin yksi seuraava tuomio (j);
            // ensimmäisen kohdalla tulostetaan myös varoituksen alkuosa
            if (varoitus == "") {
                varoitus = "Konkurrenssiryhmän <span class='rooma'>" + nroRoomalaiseksi(i + 1) + "</span> "
                    + "päättymispäivänä " + pvmTekstiksi(konkurrenssiryhmät[i].pvm) + " on annettu tai julistettu "
                    + "useampi kuin yksi tuomio, jossa on ko. ryhmän rikoksia &#8211; "
                    + "tarkista tuomioiden keskinäinen järjestys: ";
                varoitus += tuomiot[j - 1].tuomioistuin + " no&nbsp;" + tuomiot[j - 1].ratkaisunro
                    + " (katsottu tässä konkurrenssin katkaisevaksi)";
            }

            varoitus += ", " + tuomiot[j].tuomioistuin + " no&nbsp;" + tuomiot[j].ratkaisunro;

            j++;

        }

        if (varoitus != "") {
            varoitukset.push(varoitus);
            varoitus = "";
        }

    }

    console.log("Samana päivänä annettujen konkurrenssin katkaisevien tuomioiden etsintä valmis");

}


// ********************************************************************************************************************
// laskeKokonaisrangaistukset:
// funktio, joka laskee konkurrenssiryhmittäiset kokonaisrangaistukset
// ********************************************************************************************************************

function laskeKokonaisrangaistukset(tuomiot, konkurrenssiryhmät, varoitukset) {

    // säännölliset lausekkeet vuoden, päivän ja kuukauden tunnistamiseksi
    const vLauseke = /(\d{1,3})\sv/
    const kkLauseke = /(\d{1,3})\skk/
    const pvLauseke = /(\d{1,3})\spv/

    // käydään läpi kaikki konkurrenssiryhmät

    for (let i = 0; i < konkurrenssiryhmät.length; i++) {

        // muuttujat kokonaisrangaistukselle
        let v = 0;
        let kk = 0;
        let pv = 0;

        // montako tuomiota konkurrenssiryhmässä on (jos on vain 1, kokonaisrangaistusta ei tarvitse laskea)
        let tuomiomäärä = 0;

        // käydään läpi kaikki tuomiot
        for (let j = 0; j < tuomiot.length; j++) {

            // jos tuomio sisältää läpikäytävän konkurrenssiryhmän rikoksia, lisätään rangaistus kokonaisrangaistukseen
            if (tuomiot[j].konkurrenssiryhmät.indexOf(i) != -1) {

                tuomiomäärä++;

                let rangaistus = tuomiot[j].rangaistus.split(" vankeutta")[0].replaceAll("&nbsp;", " ");

                let vOsuma = rangaistus.match(vLauseke);
                let kkOsuma = rangaistus.match(kkLauseke);
                let pvOsuma = rangaistus.match(pvLauseke);

                if (vOsuma != null) v += parseInt(vOsuma[1]);
                if (kkOsuma != null) kk += parseInt(kkOsuma[1]);
                if (pvOsuma != null) pv += parseInt(pvOsuma[1]);

                // onko tuomiossa muiden konkurrenssiryhmien rikoksia, jolloin tulosteessa ilmoitetaan, että
                // kokonaisrangaistuksessa on kyse konkurrenssiryhmän rangaistusten summan ylärajasta (edellyttäen,
                // että tuomion rangaistuksena ei ole "Riittävä seuraamus")
                if (tuomiot[j].konkurrenssiryhmät.length > 1 && !tuomiot[j].rangaistus.includes("Riittävä")) {
                    konkurrenssiryhmät[i].onkoEriKonkRyhmiä = true;
                }

                // onko uusi tuomio
                if (tuomiot[j].tuomioistuin.includes("UUSI TUOMIO")) {
                    konkurrenssiryhmät[i].onkoUuttaTuomiota = true;
                }

                // onko elinkautinen (jos on, niin kokonaisrangaistusten summa voi olla nolla)
                if (tuomiot[j].rangaistus.includes("Elinkau")) {
                    konkurrenssiryhmät[i].onkoElinkautista = true;
                }

            }

        }

        // lisätään kokonaisrangaistus konkurrenssiryhmän tietoihin, jos tuomioita on ollut useampia,
        // ja on rangaistusten summa on nollaa suurempi
        if (tuomiomäärä > 1 && (v > 0 || kk > 0 || pv > 0)) {

            // vuoteen lasketaan 365 päivää (RL 2c:3)
            if (pv > 364) {
                v += Math.floor(pv / 365);
                pv = pv % 365;
            }

            // kuukauteen lasketaan 30 päivää (RL 2c:3)
            if (pv > 29) {
                kk += Math.floor(pv / 30);
                pv = pv % 30;
            }

            // vuoteen lasketaan 12 kuukautta
            if (kk > 11) {
                v += Math.floor(kk / 12);
                kk = kk % 12;
            }

            // kolmea kuukautta lyhyempi rangaistus päivinä (RL 2c:3)
            if (v == 0 && kk < 3) {
                pv += kk * 30;
                kk = 0;
            }

            konkurrenssiryhmät[i].kokonaisrangaistus.v = v;
            konkurrenssiryhmät[i].kokonaisrangaistus.kk = kk;
            konkurrenssiryhmät[i].kokonaisrangaistus.pv = pv;

        }

        // varoitus tilanteista, joissa kokonaisrangaistusta ei pystytä laskemaan (yleensä selittyy käyttäjän
        // lisäämällä uudella tuomiolla tai elinkautisella; näissä tilanteissa varoitusta ei anneta)

        if (tuomiomäärä > 1 && v == 0 && kk == 0 && pv == 0 && !konkurrenssiryhmät[i].onkoUuttaTuomiota &&
            !konkurrenssiryhmät[i].onkoElinkautista) {

            let onUlkomainen = false;
            for (let j = 0; j < varoitukset.length; j++) {
                if (varoitukset[j].includes("Ote saattaa sisältää ulkomaisen tuomion")) {
                    onUlkomainen = true;
                }
            }

            let varoitus = "Konkurrenssiryhmälle <span class='rooma'>" + nroRoomalaiseksi(i + 1) + "</span> "
                + "ei pystytty laskemaan kokonaisrangaistusta. Yleensä tämä johtuu siitä, että konkurrenssiryhmässä "
                + "on pelkkiä riittävä seuraamus -tuomioita, minkä ei pitäisi olla mahdollista. ";

            if (onUlkomainen) {
                varoitus += "Tässä tapauksessa asia saattaa kuitenkin selittyä rikosrekisteriotteeseen mahdollisesti "
                    + "sisältyvällä ulkomaisella tuomiolla, sillä konkurrenssikone ei pysty tulkitsemaan "
                    + "otteessa olevia ulkomaisia tuomioita. ";
                varoitus += "Tarkista rikosrekisteri- ja konkurrenssitietojen oikeellisuus ja mahdollisen ulkomaisen "
                    + "tuomion vaikutus. ";
            } else {
                varoitus += "Tarkista rikosrekisteri- ja konkurrenssitietojen oikeellisuus.";
            }

            varoitukset.push(varoitus);

        }

    }

}

// ********************************************************************************************************************
// listaaSyytekohdat:
// funktio, joka palauttaa merkkijonona oikein muotoillun luettelon syytekohdista,
// esim. [1, "3.", 4, 5, "6.1", "6.2", 7] => "1, 3-5, 6.1, 6.2 ja 7"
// ********************************************************************************************************************

function listaaSyytekohdat(syytekohdat) {

    // vaihe 1/3: käydään läpi syytekohdat, stilisoidaan numerot ja merkitään pelkkäNro-taulukkoon (true/false),
    // onko kunkin syytekohdan numero pelkkä numero (eli ei esim. "12.1")

    let pelkkäNro = [];

    for (let i = 0; i < syytekohdat.length; i++) {
        if (typeof syytekohdat[i] == "number") {
            syytekohdat[i] = syytekohdat[i].toString();
            pelkkäNro.push(true);
        } else {
            if (syytekohdat[i][syytekohdat[i].length - 1] == "." || syytekohdat[i][syytekohdat[i].length - 1] == ")") {
                syytekohdat[i] = syytekohdat[i].slice(0, -1); // poistetaan piste tai sulku lopusta
            }
            let numerot = syytekohdat[i].replace(/[^0-9]/g, ""); // karsitaan kaikki paitsi numerot 0-9
            let alkuosa = parseInt(syytekohdat[i]); // ensimmäinen kokonaisluku
            if (numerot == alkuosa) { // onko nro esim. mallia "12.1" eli kaikki nrot eivät ole alkuosassa?
                pelkkäNro.push(true);
            } else {
                pelkkäNro.push(false);
            }
        }
    }

    // vaihe 2/3: ryhmitellään syytekohdat numerokokonaisuuksiksi (nroRyhmät)

    let nroRyhmät = [];

    {
        let i = 0;
        let j = 0;
        do {
            if (i < syytekohdat.length && pelkkäNro[i]) {
                do {
                    j++;
                    if (j == syytekohdat.length) {
                        break;
                    }
                } while (pelkkäNro[j] && parseInt(syytekohdat[j]) - parseInt(syytekohdat[j - 1]) == 1)
                j--;
                if (j > i + 1) {
                    nroRyhmät.push(syytekohdat[i] + "&#8211;" + syytekohdat[j]);
                    i = j;
                } else {
                    nroRyhmät.push(syytekohdat[i].toString());
                    j = i;
                }
            } else {
                nroRyhmät.push(syytekohdat[i]);
            }
            i++;
            j++;
        } while (i < syytekohdat.length)
    }

    // vaihe 3/3: yhdistetään numerokokonaisuudet yhdeksi merkkijonoksi (syytekohtaLista), jonka funktio palauttaa

    let syytekohtaLista = "";

    for (let i = 0; i < nroRyhmät.length; i++) {
        syytekohtaLista += nroRyhmät[i];
        if (i >= 0 && i < nroRyhmät.length - 2) {
            syytekohtaLista += ", ";
        }
        if (i >= 0 && i == nroRyhmät.length - 2) {
            syytekohtaLista += " ja&nbsp;";
        }
    }

    return syytekohtaLista;

}

// ********************************************************************************************************************
// pvmTekstiksi:
// funktio, joka palauttaa päivämäärän oikein muotoiltuna
// ********************************************************************************************************************

function pvmTekstiksi(pvm) {
    return pvm.getDate() + "." + (pvm.getMonth() + 1) + "." + pvm.getFullYear();
}

// ********************************************************************************************************************
// ajankohtaTekstiksi:
// funktio, joka palauttaa päivämäärän ja kellonajan oikein muotoiltuna
// ********************************************************************************************************************

function ajankohtaTekstiksi(ajankohta) {
    return pvmTekstiksi(ajankohta)
        + " klo " + ("0" + ajankohta.getHours()).slice(-2)
        + "." + ("0" + ajankohta.getMinutes()).slice(-2)
        + "." + ("0" + ajankohta.getSeconds()).slice(-2);
}

// ********************************************************************************************************************
// ajanjaksoTekstiksi:
// funktio, joka palauttaa kahden päivämäärän välin oikein muotoiltuna
// ********************************************************************************************************************

function ajanjaksoTekstiksi(alkupvm, loppupvm) {

    let ajanjakso = "";

    if (alkupvm != loppupvm) {
        ajanjakso += alkupvm.getDate();
        ajanjakso += ".";
        if (alkupvm.getMonth() != loppupvm.getMonth() || alkupvm.getFullYear() != loppupvm.getFullYear()) {
            ajanjakso += (alkupvm.getMonth() + 1);
            ajanjakso += ".";
        }
        if (alkupvm.getFullYear() != loppupvm.getFullYear()) {
            ajanjakso += alkupvm.getFullYear();
        }
        ajanjakso += "&#8211;";
    }

    ajanjakso += pvmTekstiksi(loppupvm);

    return ajanjakso;

}

// ********************************************************************************************************************
// lyhennäTuomionTiedot:
// funktio, joka palauttaa tuomion nimen sisältävän merkkijonon lyhennettynä (käräjäoikeus -> KO jne.)
// ********************************************************************************************************************

function lyhennäTuomionTiedot(tuomionTiedot) {
    return tuomionTiedot
        .replaceAll("käräjäoikeus", "KO")
        .replaceAll("hovioikeus", "HO")
        .replaceAll("Korkein oikeus", "KKO")
        .replaceAll("tingsrätt", "TR")
        .replaceAll("hovrätt", "HovR")
        .replaceAll("Högsta domstolen", "HD")
        .replaceAll("raastuvanoikeus", "RO")
        .replaceAll("kihlakunnanoikeus", "KO")
        .replaceAll("tuomiokunta", "TK")
        .replaceAll("rådstuvurätt", "RR")
        .replaceAll("häradsrätt", "HR")
        .replaceAll("rådhusrätt", "RR")
        .replaceAll("domsaga", "DS");
}

// ********************************************************************************************************************
// nroRoomalaiseksi:
// funktio, joka palauttaa annetun numeron roomalaisena numerona
// ********************************************************************************************************************

function nroRoomalaiseksi(numero) {

    const luvut = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1];
    const roomalaiset = ["M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"];
    let vastaus = "";

    for (let i = 0; i <= luvut.length; i++) {
        while (numero % luvut[i] < numero) {
            vastaus += roomalaiset[i];
            numero -= luvut[i];
        }
    }

    return vastaus;

}

// ********************************************************************************************************************
// tulostaJohdanto:
// funktio, joka luo konkurrenssikoneen tulosteen alkuosan
// ********************************************************************************************************************

function tulostaJohdanto(kyselytiedot, asetukset, kesto, tulosteHTML, tulosteHTMLheader) {

    console.log("Konkurrenssikoneen tulosteen luominen alkaa");
    console.log("Johdantotekstien tulostaminen alkaa");

    let nyt = ajankohtaTekstiksi(new Date());

    tulosteHTMLheader.push("<meta charset='utf-8'>\n\n");

    let js = "script";

    tulosteHTMLheader.push("<" + js + ">throw new Error('JS pois');</" + js + ">\n\n");

    tulosteHTMLheader.push("<title>");
    if (tuomioistuinkäyttö && !asetukset.esittely) {
        tulosteHTMLheader.push("Konkurrenssikoneen tuloste tuomioistuimen käyttöön " + nyt);
    } else {
        if (!asetukset.esittely) {
            tulosteHTMLheader.push("Konkurrenssikoneen tuloste " + nyt);
        } else {
            tulosteHTMLheader.push("Konkurrenssikoneen mallituloste " + nyt);
        }
    }
    tulosteHTMLheader.push("</title>\n\n");

    // css-tyylipohja

    tulosteHTMLheader.push("<style>\n"
        + "body {\n"
        + "  margin: 25px auto 5px auto; width: 900px;\n"
        + "  font-size: 12pt;\n"
        + "  font-family: system-ui, Calibri, Helvetica, Arial, sans-serif;\n"
        + "  font-weight: normal;\n"
        + "}\n"
        + "hr { border-top: 1px solid #888; margin: 25px auto; }\n"
        + "svg { display: block; margin: auto; }\n"
        + "h1 { font-size: 20pt; text-align: center; margin: 3em 0; }\n"
        + "h2 { font-size: 16pt; text-align: center; margin: 3em 0; }\n"
        + "table { width: 900px; border-spacing: 0; border-collapse: collapse; }\n"
        + "th, td {\n"
        + " border-top: 1px solid #888;\n"
        + " border-bottom: 1px solid #888;\n"
        + " margin: 0; padding: 8px;\n"
        + " vertical-align: top;"
        + "}\n"
        + "th {\n"
        + "  border-bottom: 3px double #888;\n"
        + "  padding-top: 1.5em; padding-bottom: 1.5em; background: #f5f5f5;\n"
        + "}\n"
        + "td p { margin-top: 0; margin-bottom: 0.3em }\n"
        + "th, tr:first-child td { border-top: 0 }\n"
        + "tr:last-child td { border-bottom: 0 }\n"
        + "th, td:first-child { border-left: 0 }\n"
        + "th, td:last-child { border-right: 0 }\n"
        + "ul { list-style-type: none; padding-left: 1em; }\n"
        + "ul li:before { content: '–'; position: absolute; margin-left: -1em; }\n"
        + "dd { margin-bottom: 5px }\n"
        + ".lausunnot {\n"                                  // konkurrenssilausuntojen osio
        + "  background: #f5f5f5;\n"
        + "  padding: 10px 30px 10px 30px;\n"
        + "  border-radius: 20px;\n"
        + "}\n"
        + ".rooma {\n"                                      // roomalainen nro
        + "  font-family: 'Palatino Linotype', Georgia,\n"
        + "  'Times New Roman', Times, serif;\n"
        + "}\n"
        + ".konkurrenssinro {\n"                            // laatikko konkurrenssiryhmän numerolle
        + "  float: right;\n"
        + "  padding: 0.7em;\n"
        + "  font-size: 16pt;\n"
        + "  border: 3px solid red;\n"
        + "  border-radius: 13px;\n"
        + "  text-align: center;\n"
        + "  color: red;\n"
        + "}\n"
        + ".eikatkaise {\n"                                 // laatikko, jossa lukee "Ei katkaiseva"
        + "  float: right;\n"
        + "  padding: 0.5em;\n"
        + "  border: 2px solid #888;\n"
        + "  border-radius: 8px;\n"
        + "  text-align: center;\n"
        + "  color: #888;\n"
        + "}\n"
        + "p.alku { margin: 1em auto; }\n"                   // tulosteen aloitusfraasi
        + "table.johdanto { font-size: 10pt; }\n"            // tulosteen johdanto
        + "p.johtolause { margin-bottom: 0; }\n"             // konkurrenssilausunnon johtolause
        + "ul.huomioonotettavat { margin-top: 0 }\n"         // konkurrenssilausunnon luettelo
        + ".kaavio { margin: 60px auto 0 0; }\n"             // konkurrenssikaavio-SVG:n ympärillä oleva elementti
        + ".varoitus { color: red; }\n"                      // varoitukset
        + ".eilainvoimainen { color: red; }\n"               // lainvoimaa vailla olevan tuomion lainvoimaisuustieto
        + ".konkurrenssinkatkaiseva { color: red; }\n"       // tieto konkurrenssin katkaisevasta tuomiosta
        + ".konkurrenssitieto { color: #888; }\n"            // tieto rikoksen konk.ryhmästä/ei-katkaisevasta tuomiosta
        + ".erikonkurrenssi {\n"                             // eri konkurrenssin rikokset (yliviivattuna)
        + "  color: #888;\n"
        + "  text-decoration: line-through;\n"
        + "}\n"
        + ".summa { text-align: right; padding-right: 0 }\n" // konkurrenssiryhmän kokonaisrangaistusrivin selite
        + ".jälkituomio { color: red; }\n"                   // tieto siitä, että kyseessä on jälkituomio
        + ".pvmtieto { color: #888; }\n"                     // tieto tulkinnanvaraisen päivämäärän tulkinnasta
        + "</style>\n\n");                                  

    if (tuomioistuinkäyttö && !asetukset.esittely) {
        tulosteHTML.push("<h1>Konkurrenssikoneen tuloste tuomioistuimen käyttöön</h1>\n\n");
    } else {
        if (!asetukset.esittely) {
            tulosteHTML.push("<h1>Konkurrenssikoneen tuloste</h1>\n\n");
        } else {
            tulosteHTML.push("<h1>Konkurrenssikoneen mallituloste</h1>\n\n");
        }
    }

    if (!asetukset.esittely) {
        tulosteHTML.push("<p class='alku'><b>SALASSA PIDETTÄVÄ. Ks. rikosrekisterilaki 3 ja 11&nbsp;§, "
            + "laki oikeudenkäynnin julkisuudesta yleisissä tuomioistuimissa 9&nbsp;§ 1&nbsp;mom. 4&nbsp;kohta "
            + "sekä laki viranomaisten toiminnan julkisuudesta 24&nbsp;§ 1&nbsp;mom. 28&nbsp;kohta.");
        if (tuomioistuinkäyttö) {
            tulosteHTML.push(" Asianosaisjulkisuudesta päättää tuomioistuin.");
        }
        tulosteHTML.push("</b></p>\n\n");
    } else {
        tulosteHTML.push("<p class='alku'><b>Tämä on mallituloste, joka ei perustu todellisen rikosrekisteriotteen "
            + "tietoihin vaan fiktiiviseen esimerkkiaineistoon, jonka konkurrenssikone on luonut käyttäjän "
            + "määrittämien asetusten mukaisesti.</b></p>\n\n");
    }

    tulosteHTML.push("<table class='johdanto'>\n");

    tulosteHTML.push("<tr><td><b>Konkurrenssikoneen&nbsp;versio:</b></td><td>" + versio);
    if (tuomioistuinkäyttö) {
        tulosteHTML.push(" (vain tuomioistuinkäyttöön tarkoitettu versio)");
    } else {
        tulosteHTML.push(" (julkinen versio)");
    }
    tulosteHTML.push("</td></tr>\n");

    tulosteHTML.push("<tr><td><b>Käyttöajankohta:</b></td><td>" + nyt + "</td></tr>\n");

    if (!asetukset.esittely && !tuomioistuinkäyttö) {
        tulosteHTML.push("<tr><td><b>Käyttöehtojen hyväksymisajankohta:</b></td><td>"
            + asetukset.käyttöehtojenAjankohta + "</td></tr>\n");
    }

    tulosteHTML.push("<tr><td><b>Selaimen tunnistetiedot:</b></td><td>" + navigator.userAgent + "</td></tr>\n");

    if (kyselytiedot[1] != "") {
        tulosteHTML.push("<tr><td><b>Rikosrekisteriotteen ajankohta:</b></td><td>" + kyselytiedot[1]);
        if (kyselytiedot[0] != "") {
            tulosteHTML.push(" (" + kyselytiedot[0] + ")");
        }
        tulosteHTML.push("</td></tr>\n");
    }

    // jos kesto == -1, tietoa ei tulosteta (ei ehdottomia tuomioita)
    if (kesto > 0) {
        tulosteHTML.push("<tr><td><b>Konkurrenssiryhmien määrittämisen kesto:</b></td><td>"
            + (kesto/1000).toLocaleString("fi-FI") + " sekuntia</td></tr>\n");
    } else if (kesto == 0) {
        tulosteHTML.push("<tr><td><b>Konkurrenssiryhmien määrittämisen kesto:</b></td><td>alle 0,001 sekuntia</td></tr>\n");
    }

    if (asetukset.tiivisteet && !asetukset.esittely) {
        tulosteHTML.push("<tr><td><b>Tiivisteet:</td><td>[[tiivisteet]]</td></tr>");
    }

    tulosteHTML.push("<tr><td><b>Asetukset:</b></td><td>");
    if (!asetukset.lausuntoLyhyt && !asetukset.lausuntoKeskipitkä && !asetukset.lausuntoPitkä) {
        tulosteHTML.push("Konkurrenssilausuntoja ei tulosteta lainkaan");
    } else {
        if (asetukset.lausuntoKaikille) {
            tulosteHTML.push("Konkurrenssilausunnot myös lainvoimaisille tuomioille, ");
        } else {
            tulosteHTML.push("Konkurrenssilausunnot vain lainvoimaa vailla oleville tuomioille, ");
        }
        if (asetukset.lausuntoLyhyt) {
            tulosteHTML.push("lyhyt");
        }
        if (asetukset.lausuntoKeskipitkä) {
            if (asetukset.lausuntoLyhyt && asetukset.lausuntoPitkä) {
                tulosteHTML.push(", ");
            } else if (asetukset.lausuntoLyhyt && !asetukset.lausuntoPitkä) {
                tulosteHTML.push(" ja ");
            }
            tulosteHTML.push("keskipitkä");
        }
        if (asetukset.lausuntoPitkä) {
            if (asetukset.lausuntoLyhyt || asetukset.lausuntoKeskipitkä) {
                tulosteHTML.push(" ja ");
            }
            tulosteHTML.push("pitkä");
        }
        tulosteHTML.push(" malli");
    }
    tulosteHTML.push("<br>");
    if (asetukset.värillinenKaavio) {
        tulosteHTML.push("Konkurrenssikaavio värillisenä ");
    } else {
        tulosteHTML.push("Konkurrenssikaavio mustavalkoisena" );
    }
    if (asetukset.mhKaaviossa) {
        tulosteHTML.push("sisältäen muutoksenhaut");
        if (asetukset.ehdollisetKaaviossa) {
            tulosteHTML.push(" sekä mahdolliset ehdolliset tuomiot ja nuorisorangaistukset");
        } else {
            tulosteHTML.push(" mutta ilman mahdollisia ehdollisia tuomioita tai nuorisorangaistuksia");
        }
    } else {
        tulosteHTML.push("ilman muutoksenhakuja");
        if (asetukset.ehdollisetKaaviossa) {
            tulosteHTML.push(" mutta sisältäen mahdolliset ehdolliset tuomiot ja nuorisorangaistukset");
        } else {
            tulosteHTML.push(", mahdollisia ehdollisia tuomioita tai nuorisorangaistuksia");
        }
    }
    if (asetukset.isoKaavio) {
        tulosteHTML.push(", kaksinkertainen mittakaava aika-akselilla");
    } else {
        tulosteHTML.push(", mittakaava normaali");
    }
    tulosteHTML.push("</td></tr>\n");

    if (asetukset.esittely) {
        tulosteHTML.push("<tr><td><b>Mallitulosteen luonnin asetukset:</b></td><td>"
            + "Ehdottomia tuomioita " + asetukset.esittely_ehdottomienMäärä + "&nbsp;kpl, "
            + "ehdollisia tuomioita " + asetukset.esittely_ehdollistenMäärä + "&nbsp;kpl, "
            + "rikoksia tuomiossa enintään " + asetukset.esittely_rikostenEnimmäismäärä + "&nbsp;kpl, "
            + "tuomioiden&nbsp;väli enintään " + asetukset.esittely_tuomioidenVäliMax + "&nbsp;pv, "
            + "rikosten&nbsp;väli enintään " + asetukset.esittely_rikostenVäliMax + "&nbsp;pv, "
            + "muutoksenhaun todennäköisyys " + Math.round(asetukset.esittely_mhTodennäköisyys * 100) + "&nbsp;%, "
            + "eri&nbsp;oikeusasteiden tuomioiden väli enintään " + asetukset.esittely_mhVäliMax + "&nbsp;pv");
        tulosteHTML.push("</td></tr>\n");
    }

    tulosteHTML.push("</table>\n\n");

    console.log("Johdantotekstien tulostaminen valmis");

}

// ********************************************************************************************************************
// tulostaMuutoksetJaVaroitukset:
// funktio, joka tulostaa tiedot liittyen käyttäjän tekemiin rikosrekisterin muutoksiin
// sekä rikosrekisterin lukemiseen ja analysointiin liittyvät varoitukset
// ********************************************************************************************************************

function tulostaMuutoksetJaVaroitukset(muutokset, varoitukset, tulosteHTML) {

    if (muutokset.length > 0) {
        console.log("Rikrekin muutostietojen tulostaminen alkaa. Määrä: " + muutokset.length);
        tulosteHTML.push("<p class='varoitus'>"
            + "<b><u>Käyttäjä on tehnyt rikosrekisteriotteeseen seuraavat muutokset. "
            + "Tarkista muutosten oikeellisuus tulosteessa:</u></b></p>\n\n<ul>\n");
    } else {
        console.log("Ei rikrekin muutostietoja");
    }

    for (let i = 0; i < muutokset.length; i++) {
        tulosteHTML.push("<li>" + muutokset[i] + "</li>\n");
    }

    if (muutokset.length > 0) {
        tulosteHTML.push("</ul>\n\n");
        tulosteHTML.push("<hr>\n\n");
        console.log("Rikrekin muutostietojen tulostaminen valmis");
    }

    if (varoitukset.length > 0) {
        console.log("Varoitusten tulostaminen alkaa. Varoitusten määrä: " + varoitukset.length);
        tulosteHTML.push("<p class='varoitus'>"
            + "<b><u>Huom! Konkurrenssikone havaitsi seuraavat epäselvyydet rikosrekisterissä:</u></b></p>\n\n<ul>\n");
    } else {
        console.log("Ei varoituksia");
    }

    for (let i = 0; i < varoitukset.length; i++) {
        if (varoitukset[i].startsWith("VIRHETILANNE")) {
            tulosteHTML.push("<li class='varoitus'>");
        } else {
            tulosteHTML.push("<li>");
        }
        tulosteHTML.push(varoitukset[i]);
        tulosteHTML.push("</li>\n");
    }

    if (varoitukset.length > 0) {
        tulosteHTML.push("</ul>\n\n");
        tulosteHTML.push("<hr>\n\n");
        console.log("Varoitusten tulostaminen valmis");
    }

}

// ********************************************************************************************************************
// tulostaEhdottomatTuomiot:
// funktio, joka tulostaa rikosrekisterin ehdottomat tuomiot konkurrenssimerkinnöin
// ********************************************************************************************************************

function tulostaEhdottomatTuomiot(tuomiot, rikosluettelo, lyhyt, keskipitkä, pitkä, lausuntoKaikille, tulosteHTML) {

    console.log("Rikosrekisterin tulostaminen alkaa");

    tulosteHTML.push("<h2>Ehdottomat tuomiot konkurrenssimerkinnöin</h2>\n\n");

    // tulostetaan kaikki tuomiot käänteisessä järjestyksessä eli uusimmat ensin

    for (let i = tuomiot.length - 1; i >= 0; i--) {

        // tulostetaan käsiteltävänä olevan tuomion tiedot (tuomioistuin, päivämäärä ja ratkaisunumero);
        // eri oikeusasteiden tuomioita voi olla enintään kolme; jos oikeusasteita on useampi kuin yksi,
        // niistä alleviivataan konkurrenssin kannalta merkityksellinen; jos merkityksellinen oikeusaste
        // on poikkeuksellisesti muu kuin ensimmäinen oikeusaste, tästä lisätään punaisella huomautus

        // tulostetaan ensin oikeaan reunaan isompana näkyvä tieto siitä, onko kyseessä konkurrenssin
        // katkaiseva tuomio ja jos on, minkä konkurrenssiryhmän tuomiosta on kyse

        if (tuomiot[i].konkurrenssiryhmänro == null) {
            tulosteHTML.push("<div class='eikatkaise'>Ei&nbsp;katkaiseva</div>");
        } else {
            tulosteHTML.push("<div class='konkurrenssinro'><b class='rooma'>"
                + nroRoomalaiseksi(tuomiot[i].konkurrenssiryhmänro + 1) + "</b></div>\n");
        }

        tulosteHTML.push("<h3>");

        let tuomionNimi = tuomiot[i].pisinNimi();

        for (let j = 1; j < tuomionNimi.length; j++) {
            if (j > 1) {
                tulosteHTML.push("<br>\n");
            }
            if (j == tuomionNimi[0] && tuomionNimi.length > 2) {
                tulosteHTML.push("<u>");
            }
            if (tuomionNimi[j].includes("UUSI TUOMIO")) {
                tulosteHTML.push("<span style='color: red'>" + tuomionNimi[j] + "</span>");
            } else {
                tulosteHTML.push(tuomionNimi[j]);
            }
            if (j == tuomionNimi[0] && tuomionNimi.length > 2) {
                tulosteHTML.push("</u>");
            }
            if (j == tuomionNimi[0] && tuomionNimi.length > 2) {
                if (tuomionNimi[0] == 1 || (tuomionNimi[0] == 2 && tuomionNimi.length == 4)) {
                    tulosteHTML.push("<span style='color: red'>&nbsp;&#11013;&nbsp;ratkaiseva "
                        + "pvm (ks.&nbsp;rikosrek.)</span>");
                }
            }
        }

        tulosteHTML.push("</h3>\n\n");

        // tulostetaan tuomiossa olevat rikokset

        tulosteHTML.push("<dl>\n");

        // käydään läpi kaikki tuomion (i) rikokset (j)
        for (let j = 0; j < tuomiot[i].rikokset.length; j++) {

            // seuraava määritys on vain koodin luettavuuden parantamiseksi
            let rikos = rikosluettelo[tuomiot[i].rikokset[j]];

            // tulostetaan rikoksen syytekohta ja nimike
            tulosteHTML.push("<dt>" + rikos.syytekohta + "&nbsp;" + rikos.nimike + "</dt>\n");

            tulosteHTML.push("<dd>");

            // tulostetaan rikoksen tekoaika
            let rikoksenPvmTiedot = rikos.tekoaikaTekstinä();
            tulosteHTML.push(rikoksenPvmTiedot[0]);
            if (rikoksenPvmTiedot[1] != "") {
                tulosteHTML.push(" <span class='konkurrenssitieto'>[=&nbsp;" + rikoksenPvmTiedot[1] + "]</span>");
            }

            // tulostetaan tieto rikoksen konkurrenssiryhmästä (ja sen yhteyteen joko nuoli tai yhtäsuuruusmerkki
            // riippuen siitä, kuuluuko rikos aiempaan konkurrenssiryhmään vai onko kyse uuden konkurrenssiryhmän
            // rikoksesta konkurrenssin katkaisevassa tuomiossa)
            tulosteHTML.push(" <span class='konkurrenssitieto'>(");
            if (rikos.konkurrenssiryhmänro != tuomiot[i].konkurrenssiryhmänro) {
                tulosteHTML.push("&#8594;");
            } else {
                tulosteHTML.push("=");
            }
            tulosteHTML.push("&nbsp;<b class='rooma'>" + nroRoomalaiseksi(rikos.konkurrenssiryhmänro + 1)
                + "</b>)</span>");

            tulosteHTML.push("</dd>\n");

        }

        tulosteHTML.push("</dl>\n\n");

        // tulostetaan tieto rangaistuksesta

        tulosteHTML.push("<p><i>" + tuomiot[i].rangaistus + "</i></p>\n\n");

        // ei ilmoiteta muita tietoja, jos käyttäjä haluaa konkurrenssilausunnon
        // vain lainvoimaa vailla oleville tuomioille ja tuomio on lainvoimainen

        if (!lausuntoKaikille && tuomiot[i].lainvoimaisuus) {

            tulosteHTML.push("<p><b>Tuomio on lainvoimainen.</b></p>\n\n");

        } else {

            // muussa tapauksessa laaditaan ehdotus konkurrenssilausunnoksi

            tulosteHTML.push("<div class='lausunnot'>\n");

            // ilmoitetaan ensin tuomion lainvoimaisuus

            if (!tuomiot[i].lainvoimaisuus) {
                if (!tuomiot[i].tuomioistuin.includes("UUSI TUOMIO")) {
                    if (tuomiot[i].lainvoimaisuusLisätieto == "Täytäntöönpanokelpoinen") {
                        tulosteHTML.push("<p><b class='eilainvoimainen'>Tuomio on täytäntöönpanokelpoinen "
                            + "mutta ei lainvoimainen.");
                    } else if (tuomiot[i].lainvoimaisuusLisätieto == "Lainvoimaisuus määrittämätön") {
                        tulosteHTML.push("<p><b class='eilainvoimainen'>Rikosrekisteriotteen mukaan tuomion "
                            + "lainvoimaisuus on &#8221;määrittämätön&#8221;. Konkurrenssikone olettaa siten, "
                            + "että tuomio ei ole lainvoimainen.");
                    } else {
                        tulosteHTML.push("<p><b class='eilainvoimainen'>Tuomio ei ole lainvoimainen.");
                    }
                } else {
                    tulosteHTML.push("<p><b class='eilainvoimainen'>Kyseessä on uusi tuomio, jota ei vielä ole annettu.");
                }
            } else {
                 tulosteHTML.push("<p><b>Tuomio on lainvoimainen.");
            }

            // sen jälkeen tulostetaan konkurrenssilausunto

            // jos huomioon otettavia tuomioita ei ole, lausunto on "tyhjä"

            if (tuomiot[i].huomioonOtettavatTuomiot.length == 0) {

                if (lyhyt || keskipitkä || pitkä) {
                    tulosteHTML.push("</b> Aiempia huomioon otettavia rangaistuksia ei ole.</p>\n");
                } else {
                    tulosteHTML.push("</b></p>\n");
                }

            } else {

                tulosteHTML.push("</b></p>\n")

                // jos huomioon otettavia tuomioita on, konkurrenssilausunto on käyttäjän valinnan mukaan
                // lyhyen, keskipitkän ja/tai pitkän mallin mukainen

                // tulostetaan tuomiolle lyhyen tai keskipitkän mallin mukainen konkurrenssilausunto
                // huom. koodi on pääosin sama, koska keskipitkän mallin rakenne perustuu lyhyeen malliin,
                // joten sama tulostusrutiini toistetaan tarvittaessa kahdesti
                // (for-silmukan ja switch-rakenteen malli-muuttuja: 0 = lyhyt, 1 = keskipitkä)

                if (lyhyt || keskipitkä) {

                    for (let malli = 0; malli < 2; malli++) {

                        // hypätään tarvittaessa seuraavalle kierrokselle sen mukaan, tulostetaanko lyhyen
                        // vai keskipitkän mallin konkurrenssilausunto
                        if (malli == 0 && !lyhyt) {
                            continue;
                        }
                        if (malli == 1 && !keskipitkä) {
                            continue;
                        }

                        let tulostettavatMallit = "";

                        switch (malli) {

                            case 0:
                                if (tuomiot[i].lyhytOnPitkä) {
                                    if (keskipitkä && pitkä) {
                                        tulostettavatMallit = "lyhyt, keskipitkä ja pitkä malli";
                                    } else if (keskipitkä && !pitkä) {
                                        tulostettavatMallit = "lyhyt ja keskipitkä malli";
                                    } else if (!keskipitkä && pitkä) {
                                        tulostettavatMallit = "lyhyt ja pitkä malli";
                                    } else if (!keskipitkä && !pitkä) {
                                        tulostettavatMallit = "lyhyt malli";
                                    }
                                } else if (tuomiot[i].lyhytOnKeskipitkä) {
                                    if (keskipitkä) {
                                        tulostettavatMallit = "lyhyt ja keskipitkä malli";
                                    } else {
                                        tulostettavatMallit = "lyhyt malli";
                                    }
                                } else {
                                    tulostettavatMallit = "lyhyt malli";
                                }
                                break;

                            case 1:
                                if (tuomiot[i].lyhytOnPitkä) {
                                    if (!lyhyt && pitkä) {
                                        tulostettavatMallit = "keskipitkä ja pitkä malli";
                                    } else if (!lyhyt && !pitkä) {
                                        tulostettavatMallit = "keskipitkä malli";
                                    } else {
                                        continue; // hypätään pois for-silmukasta
                                    }
                                } else if (tuomiot[i].lyhytOnKeskipitkä) {
                                    if (!lyhyt) {
                                        tulostettavatMallit = "keskipitkä malli";
                                    } else {
                                        continue; // hypätään pois for-silmukasta
                                    }
                                } else if (tuomiot[i].keskipitkäOnPitkä && pitkä) {
                                    tulostettavatMallit = "keskipitkä ja pitkä malli";
                                } else {
                                    tulostettavatMallit = "keskipitkä malli";
                                }
                                break;

                        }

                        tulosteHTML.push("<p><b>Ehdotus tuomiolauselman kohtuullistamislausunnoksi ");
                        tulosteHTML.push("(" + tulostettavatMallit + "):</b></p>\n");

                        if (tuomiot[i].huomioonOtettavatTuomiot.length == 1) {
                            tulosteHTML.push("<p class='johtolause'>Rangaistusta alentavana on otettu huomioon "
                                + "seuraava aikaisempi rangaistus:");
                        }

                        if (tuomiot[i].huomioonOtettavatTuomiot.length > 1) {
                            tulosteHTML.push("<p class='johtolause'>Rangaistusta alentavana on otettu huomioon "
                                + "seuraavat aikaisemmat rangaistukset:");
                        }

                        tulosteHTML.push("<ul class='huomioonotettavat'>\n");

                        // käydään läpi kaikki huomioon otettavat tuomiot
                        for (let n = 0; n < tuomiot[i].huomioonOtettavatTuomiot.length; n++) {

                            tulosteHTML.push("<li>");

                            // seuraava määritys on vain koodin luettavuuden parantamiseksi
                            let huomioonOtettavanTuomionNro = tuomiot[i].huomioonOtettavatTuomiot[n];

                            // tulostetaan huomioon otettavan tuomion nimi;
                            // argumentti 0 (true/false): mainitaan tarvittaessa, onko kyseessä riittävä seuraamus
                            // argumentti 1: tuomion (i) viimeinen päivämäärä, johon tulostus katkaistaan
                            // (jos tällä on vaikutusta, siitä tulostetaan jäljempänä huomautus)
                            // huom. tämä koskee vain lainvoimaisille tuomioille tehtäviä konkurrenssilausuntoja
                            if (tuomiot[i].lainvoimaisuus) {
                                tulosteHTML.push(tuomiot[huomioonOtettavanTuomionNro]
                                    .pitkäNimi(true, tuomiot[i].viimeinenPvm()));
                            } else {
                                tulosteHTML.push(tuomiot[huomioonOtettavanTuomionNro]
                                    .pitkäNimi(true));
                            }

                            // lisätään ilmoitus jälkituomiosta
                            if (huomioonOtettavanTuomionNro > i) {
                                tulosteHTML.push(" <span class='jälkituomio'>[jälkituomio]</span>");
                            }

                            // keskipitkä lausunto (malli == 1) eroaa lyhyestä niin, että kunkin tuomion kohdalla
                            // ilmoitetaan, mitkä huomioon otettavan tuomion rikoksista kuuluvat ao.
                            // konkurrenssiryhmiin; tätä erittelyä ei kuitenkaan tulosteta, jos kaikki
                            // tuomion rikokset kuuluvat siihen (length-vertailu alussa)
                            if (malli == 1 && tuomiot[i].huomioonOtettavanRikokset[n].length !=
                                tuomiot[huomioonOtettavanTuomionNro].rikokset.length) {
                                if (tuomiot[i].huomioonOtettavanRikokset[n].length == 1) {
                                    tulosteHTML.push(" sen kohdan ");
                                } else {
                                    tulosteHTML.push(" sen kohtien ");
                                }
                                tulosteHTML.push(listaaSyytekohdat(tuomiot[i].huomioonOtettavanRikokset[n]));
                                tulosteHTML.push(" osalta");
                            }

                            // lainvoimaisessa tuomiossa huomioon otettavaa tuomiota on voinut koskea
                            // myöhempi muutoksenhaku; jos näin on, lisätään ilmoitus siitä
                            if (tuomiot[i].lainvoimaisuus && tuomiot[i].viimeinenPvm() <
                                tuomiot[huomioonOtettavanTuomionNro].viimeinenPvm()) {
                                tulosteHTML.push(" <span class='varoitus'>[huom. ko. tuomiossa muutoksenhaku "
                                    + pvmTekstiksi(tuomiot[i].viimeinenPvm()) + " jälkeen]</span>");
                            }

                            tulosteHTML.push("</li>\n");

                        }

                        tulosteHTML.push("</ul>\n");

                    }

                }

                // tulostetaan tuomiolle pitkän mallin mukainen konkurrenssilausunto

                if (pitkä && !(lyhyt && tuomiot[i].lyhytOnPitkä) && !(keskipitkä && tuomiot[i].keskipitkäOnPitkä)) {

                    tulosteHTML.push("<p><b>Ehdotus tuomiolauselman kohtuullistamislausunnoksi (pitkä malli):</b></p>\n");

                    tulosteHTML.push("<p class='johtolause'>Rangaistusta alentavana on otettu huomioon:</p>\n");

                    // lasketaan, montako konkurrenssiryhmää tuomiosta mainitaan
                    // (määrä selviää vasta läpikäynnin yhteydessä)
                    let mainitutKonkurrenssiryhmät = 0;
                    let viimeisimmänKonkryhmätEritelty = false;
                    let poistettavatElementit = [];

                    tulosteHTML.push("<ul class='huomioonotettavat'>\n");
                    poistettavatElementit.push(tulosteHTML.length - 1);

                    // käydään läpi kaikki tuomion konkurrenssiryhmät (pitkä malli muodostuu konkurrenssiryhmittäin)
                    for (let n = 0; n < tuomiot[i].konkurrenssiryhmät.length; n++) {

                        // konkurrenssiryhmästä ei mainita mitään, jos siinä ei ole huomioon otettavia tuomioita
                        if (tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot[n].length > 0) {

                            mainitutKonkurrenssiryhmät++;

                            tulosteHTML.push("<li>\n");
                            poistettavatElementit.push(tulosteHTML.length - 1);

                            // eritellään, missä kohdissa on kyse ao. konkurrenssiryhmästä;
                            // erittelylle ei kuitenkaan ole tarvetta, jos tuomion kaikki rikokset ovat
                            // samaa konkurrenssiryhmää
                            if (tuomiot[i].konkurrenssiryhmienRikokset[n].length != tuomiot[i].rikokset.length) {

                                viimeisimmänKonkryhmätEritelty = true;

                                if (tuomiot[i].konkurrenssiryhmienRikokset[n].length == 1) {
                                    tulosteHTML.push("kohdassa ");
                                } else {
                                    tulosteHTML.push("kohdissa ");
                                }

                                // tulostetaan konkurrenssiryhmän rikosten syytekohtien numerot
                                tulosteHTML.push(listaaSyytekohdat(tuomiot[i].konkurrenssiryhmienRikokset[n]));

                                // konkurrenssiryhmän roomalainen numero mainitaan kohtien jälkeen hakasulkeissa
                                tulosteHTML.push(" <span class='konkurrenssitieto'>[=&nbsp;<b class='rooma'>"
                                    + nroRoomalaiseksi(tuomiot[i].konkurrenssiryhmät[n] + 1) + "</b>]</span>");

                            } else {

                                viimeisimmänKonkryhmätEritelty = false;

                            }

                            tulosteHTML.push("<ul class='huomioonotettavat'>\n");

                            // käydään läpi kaikki ao. konkurrenssiryhmän huomioon otettavat tuomiot
                            for (let o = 0; o < tuomiot[i].konkurrenssiryhmienHuomioonOtettavatTuomiot[n].length;
                                o++) {

                                tulosteHTML.push("<li>");

                                // seuraavat kolme määrittelyä ovat vain koodin luettavuuden parantamiseksi

                                let huomioonOtettavanTuomionNro = tuomiot[i]
                                    .konkurrenssiryhmienHuomioonOtettavatTuomiot[n][o];

                                let huomioonOtettavanTuomionKonkryhmäViittaus = tuomiot[huomioonOtettavanTuomionNro]
                                    .konkurrenssiryhmät.indexOf(tuomiot[i].konkurrenssiryhmät[n]);

                                let huomioonOtettavanTuomionKonkryhmänRikokset = tuomiot[huomioonOtettavanTuomionNro]
                                    .konkurrenssiryhmienRikokset[huomioonOtettavanTuomionKonkryhmäViittaus];

                                // tulostetaan huomioon otettavan tuomion nimi;
                                // argumentti 0 == true: mainitaan tarvittaessa, onko kyseessä riittävä seuraamus
                                // argumentti 1: tuomion (i) viimeinen päivämäärä, johon tulostus katkaistaan
                                // (jos tällä on vaikutusta, siitä tulostetaan jäljempänä huomautus);
                                // huom. tämä koskee vain lainvoimaisille tuomioille tehtäviä konkurrenssilausuntoja

                                if (tuomiot[i].lainvoimaisuus) {
                                    tulosteHTML.push(tuomiot[huomioonOtettavanTuomionNro]
                                        .pitkäNimi(true, tuomiot[i].viimeinenPvm()));
                                } else {
                                    tulosteHTML.push(tuomiot[huomioonOtettavanTuomionNro]
                                        .pitkäNimi(true));
                                }

                                if (huomioonOtettavanTuomionNro > i) {
                                    tulosteHTML.push(" <span class='jälkituomio'>[jälkituomio]</span>");
                                }

                                // eritellään, missä huomioon otettavan tuomion kohdissa on kyse
                                // ao. konkurrenssiryhmästä; erittelylle ei kuitenkaan ole tarvetta,
                                // jos huomioon otettavan tuomion kaikki rikokset ovat samaa konkurrenssiryhmää
                                if (huomioonOtettavanTuomionKonkryhmänRikokset.length !=
                                    tuomiot[huomioonOtettavanTuomionNro].rikokset.length) {

                                    if (huomioonOtettavanTuomionKonkryhmänRikokset.length == 1) {
                                        tulosteHTML.push(" sen&nbsp;kohdan&nbsp;");
                                    } else {
                                        tulosteHTML.push(" sen&nbsp;kohtien&nbsp;");
                                    }

                                    // tulostetaan huomioon otettavan tuomion niiden rikosten syytekohtien numerot,
                                    // jotka ovat ao. konkurrenssiryhmää
                                    tulosteHTML.push(listaaSyytekohdat(huomioonOtettavanTuomionKonkryhmänRikokset));

                                    tulosteHTML.push("&nbsp;osalta");

                                }

                                // lainvoimaisessa tuomiossa huomioon otettavaa tuomiota on voinut koskea
                                // myöhempi muutoksenhaku; jos näin on, lisätään ilmoitus siitä
                                if (tuomiot[i].lainvoimaisuus && tuomiot[i].viimeinenPvm() <
                                    tuomiot[huomioonOtettavanTuomionNro].viimeinenPvm()) {
                                    tulosteHTML.push("<br><span class='varoitus'>[huom. ko. tuomiossa muutoksenhaku "
                                        + pvmTekstiksi(tuomiot[i].viimeinenPvm()) + " jälkeen]</span>");
                                }

                                tulosteHTML.push("</li>\n");

                            }

                            tulosteHTML.push("</ul>\n");

                            tulosteHTML.push("</li>\n");
                            poistettavatElementit.push(tulosteHTML.length - 1);

                        }

                    }

                    tulosteHTML.push("</ul>\n");
                    poistettavatElementit.push(tulosteHTML.length - 1);

                    // poistetaan lopuksi tarpeettomat HTML-elementit, jos konkurrenssiryhmiä on mainittu vain 1
                    // (tällöin vältytään ylimääräiseltä luettelon sisennykseltä)

                    if (mainitutKonkurrenssiryhmät == 1 && !viimeisimmänKonkryhmätEritelty) {
                        for (let n = 0; n < poistettavatElementit.length; n++) {
                            tulosteHTML[poistettavatElementit[n]] = "";
                        }
                    }

                }

                // tulostetaan lopuksi ilmoitus samojen konkurrenssiryhmien tuomioista, joissa vapaudenmenetys
                // on katsottu rangaistuksen täydeksi suoritukseksi (ks. KKO 2018:72)

                let täysiSuoritusTuomiot = [];

                for (let x = 0; x < tuomiot[i].huomioonOtettavatTuomiot.length; x++) {
                    if (tuomiot[tuomiot[i].huomioonOtettavatTuomiot[x]].rangaistus.includes("katsotaan täydeksi")) {
                        täysiSuoritusTuomiot.push(tuomiot[i].huomioonOtettavatTuomiot[x]);
                    }
                }

                if (täysiSuoritusTuomiot.length > 1) {

                    let täysiSuoritusTuomiotLuettelo = "";
                    for (let x = 0; x < täysiSuoritusTuomiot.length; x++) {
                        täysiSuoritusTuomiotLuettelo += tuomiot[täysiSuoritusTuomiot[x]].pitkäNimi();
                        if (x < täysiSuoritusTuomiot.length - 2) {
                            täysiSuoritusTuomiotLuettelo += ", ";
                        }
                        if (x == täysiSuoritusTuomiot.length - 2) {
                            täysiSuoritusTuomiotLuettelo += " ja ";
                        }
                    }

                    if (!tuomiot[i].lainvoimaisuus) {
                        tulosteHTML.push("<p class='varoitus'>Huom! Huomioon otettavissa aikaisemmissa tuomioissa "
                            + täysiSuoritusTuomiotLuettelo + " vapaudenmenetys on katsottu "
                            + "rangaistuksen täydeksi suoritukseksi. Kyseinen vapaudenmenetys tulee siten "
                            + "vähentää tässä asiassa tuomittavasta rangaistuksesta (ks.&nbsp;KKO&nbsp;2018:72).</p>");
                    } else {
                        tulosteHTML.push("<p>Huom! Huomioon otettavissa aikaisemmissa tuomioissa "
                            + täysiSuoritusTuomiotLuettelo + " vapaudenmenetys on katsottu "
                            + "rangaistuksen täydeksi suoritukseksi. Kyseinen vapaudenmenetys on siten tullut "
                            + "vähentää tässä asiassa tuomittavasta rangaistuksesta (ks.&nbsp;KKO&nbsp;2018:72).</p>");
                    }

                } else if (täysiSuoritusTuomiot.length == 1) {

                    let täysiSuoritusTuomionNimi = "";
                    if (tuomiot[i].huomioonOtettavatTuomiot.length > 1) {
                        täysiSuoritusTuomionNimi = tuomiot[täysiSuoritusTuomiot[0]].pitkäNimi() + " ";
                    }
                    if (!tuomiot[i].lainvoimaisuus) {
                        tulosteHTML.push("<p class='varoitus'>Huom! Huomioon otettavassa aikaisemmassa tuomiossa "
                            + täysiSuoritusTuomionNimi + "vapaudenmenetys on katsottu "
                            + "rangaistuksen täydeksi suoritukseksi. Kyseinen vapaudenmenetys tulee siten "
                            + "vähentää tässä asiassa tuomittavasta rangaistuksesta (ks.&nbsp;KKO&nbsp;2018:72).</p>");
                    } else {
                        tulosteHTML.push("<p>Huom! Huomioon otettavassa aikaisemmassa tuomiossa "
                            + täysiSuoritusTuomionNimi + "vapaudenmenetys on katsottu "
                            + "rangaistuksen täydeksi suoritukseksi. Kyseinen vapaudenmenetys on siten tullut "
                            + "vähentää tässä asiassa tuomittavasta rangaistuksesta (ks.&nbsp;KKO&nbsp;2018:72).</p>");
                    }

                }

            }

            tulosteHTML.push("</div>\n\n");

        }

        tulosteHTML.push("<hr>\n\n");

    }

    console.log("Rikosrekisterin tulostaminen valmis");

}

// ********************************************************************************************************************
// tulostaKonkurrenssiryhmät:
// funktio, joka tulostaa luettelon konkurrenssiryhmistä ja niihin liittyvistä tuomioista
// ********************************************************************************************************************

function tulostaKonkurrenssiryhmät(tuomiot, rikosluettelo, konkurrenssiryhmät, tulosteHTML) {

    console.log("Konkurrenssiryhmien tulostaminen alkaa");

    tulosteHTML.push("<h2>Ehdottomat tuomiot konkurrenssiryhmittäin lajiteltuna</h2>\n\n");

    tulosteHTML.push("<table>\n\n");

    // käydään läpi kaikki konkurrenssiryhmät (i)
    for (let i = 0; i < konkurrenssiryhmät.length; i++) {

        // tulostetaan konkurrenssiryhmän otsikko ja päivämääräjakso (jos ryhmä I eli i = 0, vain loppupvm eli i:n pvm)
        tulosteHTML.push("<tr>\n<th colspan='3'><b>");
        tulosteHTML.push("Konkurrenssiryhmä <span class='rooma'>" + nroRoomalaiseksi(i + 1) + "</span><br>");
        if (i == 0) {
            tulosteHTML.push("&#8594;&nbsp;");
            tulosteHTML.push(pvmTekstiksi(konkurrenssiryhmät[i].pvm));
        } else {
            // konkurrenssiryhmä alkaa edellisen konkurrenssiryhmän päättymispäivää seuraavasta päivästä
            let edellisenKonkurrenssiryhmänPvm = new Date(konkurrenssiryhmät[i - 1].pvm.getTime());
            edellisenKonkurrenssiryhmänPvm.setDate(edellisenKonkurrenssiryhmänPvm.getDate() + 1);
            tulosteHTML.push(ajanjaksoTekstiksi(edellisenKonkurrenssiryhmänPvm, konkurrenssiryhmät[i].pvm));
        }
        tulosteHTML.push("</b></th>\n</tr>\n\n");

        // käydään läpi kaikki rikosrekisterin tuomiot (j)
        for (let j = 0; j < tuomiot.length; j++) {

            // tulostetaan tuomioista ne, joissa on ko. konkurrenssiryhmän (i) rikoksia
            if (tuomiot[j].konkurrenssiryhmät.indexOf(i) != -1) {

                tulosteHTML.push("<tr>\n<td>");

                // tulostetaan sarake 1/3: tuomion tiedot

                // luodaan taulukko, jossa on eri oikeusasteiden tiedot
                let tuomionNimi = tuomiot[j].pidempiNimi();

                // tulostetaan eri oikeusasteiden tiedot taulukon elementistä [1] alkaen;
                // elementti [0] sisältää tiedon konkurrenssin kannalta ratkaisevan oikeusasteen
                // tuomiosta (alleviivataan); tuomion nimi katkaistaan rivinvaihdolla (<br>) ennen numeroa
                for (let k = 1; k < tuomionNimi.length; k++) {
                    tulosteHTML.push("<p>");
                    if (k == tuomionNimi[0] && tuomionNimi.length > 2) {
                        tulosteHTML.push("<u>");
                    }
                    if (tuomionNimi[k].includes("UUSI TUOMIO")) {
                        tulosteHTML.push("<span style='color: red'>");
                    }
                    tulosteHTML.push(tuomionNimi[k]
                        .replace(/ (\d\.)/, "<br>$1")
                        .replace(/ (\d\d\.)/, "<br>$1")
                        .replace(" no ", "&nbsp;no&nbsp;")
                        .replace(" no&nbsp;", "&nbsp;no&nbsp;"));
                    if (tuomionNimi[k].includes("UUSI TUOMIO")) {
                        tulosteHTML.push("</span>");
                    }
                    if (k == tuomionNimi[0] && tuomionNimi.length > 2) {
                        tulosteHTML.push("</u>");
                    }
                    tulosteHTML.push("</p>");
                }

                if (tuomiot[j].konkurrenssiryhmänro == i || !tuomiot[j].lainvoimaisuus) {
                    tulosteHTML.push("<p><i>(");
                }
                if (tuomiot[j].konkurrenssiryhmänro == i) {
                    tulosteHTML.push("katkaiseva tuomio");
                    if (!tuomiot[j].lainvoimaisuus) {
                        tulosteHTML.push(",<br>");
                    } else {
                        tulosteHTML.push(")</i>");
                    }
                }
                if (!tuomiot[j].lainvoimaisuus) {
                    tulosteHTML.push("<span class='eilainvoimainen'>ei&nbsp;lainvoimainen</span>)</i></p>");
                }

                tulosteHTML.push("</td>\n<td>\n");

                // tulostetaan sarake 2/3: tuomion rikokset

                // käydään läpi kaikki tuomion (j) rikokset (k)
                for (let k = 0; k < tuomiot[j].rikokset.length; k++) {

                    // seuraava määrittely on vain koodin luettavuuden parantamiseksi
                    let rikos = rikosluettelo[tuomiot[j].rikokset[k]];

                    if (rikos.konkurrenssiryhmänro != i) {
                        tulosteHTML.push("<span class='erikonkurrenssi'>");
                    }

                    // tulostetaan rikoksen syytekohta ja nimike
                    tulosteHTML.push(rikos.syytekohta + "&nbsp;" + rikos.nimike);

                    // tulostetaan rikoksen tekoaika
                    let rikoksenPvmTiedot = rikos.tekoaikaTekstinä();
                    if (rikoksenPvmTiedot[1] != "") {
                        tulosteHTML.push(", ");
                    } else {
                        tulosteHTML.push(" ");
                    }
                    tulosteHTML.push(rikoksenPvmTiedot[0]);
                    if (rikoksenPvmTiedot[1] != "") {
                        tulosteHTML.push(" <span class='konkurrenssitieto'>[=&nbsp;" + rikoksenPvmTiedot[1]
                            + "]</span>");
                    }

                    if (rikos.konkurrenssiryhmänro != i) {
                        tulosteHTML.push("</span>");
                    }

                    // tulostetaan tieto rikoksen konkurrenssiryhmästä (tämän yhteydessä tulostetaan joko nuoli,
                    // jos kyse on aiemman konkurrenssiryhmän rikoksesta, tai vaihtoehtoisesti yhtäsuuruusmerkki,
                    // jos kyse on uuden konkurrenssiryhmän (i) rikoksesta konkurrenssin katkaisevassa tuomiossa)
                    tulosteHTML.push(" <span class='konkurrenssitieto'>(");
                    if (rikos.konkurrenssiryhmänro != tuomiot[j].konkurrenssiryhmänro) {
                        tulosteHTML.push("&#8594;");
                    } else {
                        tulosteHTML.push("=");
                    }
                    tulosteHTML.push("&nbsp;<span class='rooma'>" + nroRoomalaiseksi(rikos.konkurrenssiryhmänro + 1)
                        + "</span>)</span>");

                    if (k != tuomiot[j].rikokset.length - 1) {
                        tulosteHTML.push("<br>\n");
                    }

                }

                tulosteHTML.push("\n</td>\n<td>");

                // tulostetaan sarake 3/3: rangaistus (tiivistettynä ja sitovilla välilyönneillä)

                tulosteHTML.push(tuomiot[j].rangaistus
                    .replaceAll(" vankeutta", "&nbsp;vank.")
                    .replaceAll(" v", "&nbsp;v")
                    .replaceAll("v ", "v&nbsp;")
                    .replaceAll(" kk", "&nbsp;kk")
                    .replaceAll("kk ", "kk&nbsp;")
                    .replaceAll(" pv", "&nbsp;pv")
                    .replaceAll("pv ", "pv&nbsp;")
                    .replaceAll(" h ", "&nbsp;h&nbsp;")
                    .replaceAll("valvontarang.", "valv.rang.")
                    .replaceAll("yhdistelmärang.", "yhd.rang.")
                    .replaceAll("jäännösrangaistus", "jäänn.rang.")
                    .replaceAll("ehdollisen&nbsp;täyt.pano", "ehdoll.&nbsp;tp.")
                    .replaceAll("tus ja ehdoll", "stus + ehdoll")
                    .replaceAll("vap.men.aika katsotaan täydeksi suoritukseksi", "täysi&nbsp;suor.")
                    .replaceAll(" +&nbsp;viraltapano", "<br>+&nbsp;viraltapano")
                    .replaceAll(" (", "<br>(")
                    .replaceAll(" &#8658;", "<br>&#8658;")
                    .replaceAll("Riittävä seuraamus", "Riittävä seur."));

                tulosteHTML.push("</td>\n</tr>\n");

            }

        }

        // tulostetaan kokonaisrangaistus, jos sellainen on laskettu (ks. laskeKokonaisrangaistukset-funtkio)

        if (konkurrenssiryhmät[i].kokonaisrangaistus.v + konkurrenssiryhmät[i].kokonaisrangaistus.kk
            + konkurrenssiryhmät[i].kokonaisrangaistus.pv > 0) {

            let rangaistus = "";
 
            if (konkurrenssiryhmät[i].onkoElinkautista) {
                rangaistus += "Elinkautinen<br>+&nbsp;";
            }

            if (konkurrenssiryhmät[i].kokonaisrangaistus.v > 0) {
                rangaistus += konkurrenssiryhmät[i].kokonaisrangaistus.v + "&nbsp;v&nbsp;";
            }

            if (konkurrenssiryhmät[i].kokonaisrangaistus.kk > 0) {
                rangaistus += konkurrenssiryhmät[i].kokonaisrangaistus.kk + "&nbsp;kk&nbsp;";
            }

            if (konkurrenssiryhmät[i].kokonaisrangaistus.pv > 0) {
                rangaistus += konkurrenssiryhmät[i].kokonaisrangaistus.pv + "&nbsp;pv&nbsp;";
            }
            if (rangaistus.endsWith("&nbsp;")) {
                rangaistus = rangaistus.slice(0, -6);
            }
            if (konkurrenssiryhmät[i].onkoUuttaTuomiota) {
                if ((konkurrenssiryhmät[i].kokonaisrangaistus.v + konkurrenssiryhmät[i].kokonaisrangaistus.kk == 0) ||
                    (konkurrenssiryhmät[i].kokonaisrangaistus.v + konkurrenssiryhmät[i].kokonaisrangaistus.pv == 0) ||
                    (konkurrenssiryhmät[i].kokonaisrangaistus.kk + konkurrenssiryhmät[i].kokonaisrangaistus.pv == 0)) {
                    rangaistus += "&nbsp;"; // ei rivinvaihtoa, jos on vain yksi aikayksikkö (pv / kk / v)
                } else {
                    rangaistus += "<br>";   // muutoin rivinvaihto
                }
                rangaistus += "+&nbsp;uusi&nbsp;tuomio";
            }

            tulosteHTML.push("<tr>\n");
            tulosteHTML.push("<td colspan='2' class='summa'><i>Konkurrenssiryhmän&nbsp;"
                + "<span class='rooma'>" + nroRoomalaiseksi(i + 1) + "</span>&nbsp;rikoksista&nbsp;");
            if (konkurrenssiryhmät[i].onkoUuttaTuomiota) {
                tulosteHTML.push("tuomittava&nbsp;")
            } else {
                tulosteHTML.push("tuomittu&nbsp;")
            }
            tulosteHTML.push("kokonaisrangaistus");
            if (konkurrenssiryhmät[i].onkoEriKonkRyhmiä) {
                tulosteHTML.push("&nbsp;<u>enintään</u>");
            }
            tulosteHTML.push("</i></td>\n");
            tulosteHTML.push("<td><b>");
            tulosteHTML.push(rangaistus);
            tulosteHTML.push("</b></td>\n");
            tulosteHTML.push("</tr>\n");
        }

        tulosteHTML.push("\n");

    }

    tulosteHTML.push("</table>\n\n");

    console.log("Konkurrenssiryhmien tulostaminen valmis");

}

// ********************************************************************************************************************
// tulostaKonkurrenssikaavio:
// funktio, joka luo SVG-muotoisen konkurrenssikaavion eli "tikapuut"
// ********************************************************************************************************************

function tulostaKonkurrenssikaavio(ehdottomatTuomiot, rikosluetteloEhdottomat, ehdollisetTuomiot,
    rikosluetteloEhdolliset, mhKaaviossa, värillinenKaavio, kaavionKoko, tulosteHTML) {

    console.log("Konkurrenssikaavion tulostaminen alkaa");

    // konkurrenssiryhmien värivaihtoehdot
    // (toinen vaihtoehto avainsanoilla: "red", "olive", "orange", "gray", "purple", "teal")
    const värivalikoima = ["#498ce3", "#f19330", "#7dc379", "#be34c0"];

    let kaavionKorkeus = 0;     // kaavion korkeus pikseleinä, lasketaan myöhemmin
    const kaavionLeveys = 900;  // kaavion leveys pikseleinä
    const pystymarginaali = 50; // kaavion pystysuuntainen marginaali pikseleinä

    const rikoksetX = 100;      // "rikosakselin" sijainti (X-koordinaatti)
    const tuomiotX = 350;       // "tuomioakselin" sijainti (X-koordinaatti)
    const tuomioseliteX = 410;  // tuomioiden selitteiden sijainti (X-koordinaatti)

    let väliviivaPvm;           // kaavion vaakaviivan pvm
    let väliviivaY = 0;         // kaavion vaakaviivan sijainti (Y-koordinaatti)

    let alkupvmY = 0;           // kaavion ensimmäinen pvm (Y-koordinaatti)
    let loppupvmY = 0;          // kaavion viimeinen pvm (Y-koordinaatti)

    // luodaan taulukko, joka sisältää sekä ehdottomat että ehdolliset tuomiot päivämäärineen ja mahdolliset
    // muutoksenhaut omina tuomioinaan; yhteinen taulukko kaikille on tarpeen, koska tuomiot vaikuttavat toistensa
    // asetteluun; kukin taulukon elementti on oma taulukkonsa, jossa on seuraavat elementit:
    // [0]: onko tuomio ehdoton (true/false)
    // [1]: tuomion järjestysnumero ehdottomien/ehdollisten joukossa
    // [2]: tuomion pvm
    // [3]: mahdollisen seuraavan oikeusasteen tuomion pvm, johon piirretään viiva (jos tällaista ei ole, arvo on null)
    // [4]: tieto siitä, mikä oikeusaste on kyseessä (1, 2 tai 3, oletusarvona 1; käytetään tuomion muiden tietojen
    //      kuin pvm:n hakemiseen)
    let kaikkiTuomiot = [];

    // lisäksi luodaan taulukko, johon kerätään konkurrenssin katkaisevien tuomioiden tiedot niin, että niitä
    // osoittavat ympyrät voidaan piirtää viimeiseksi
    let katkaisevienYmpyrät = [];

    // jos asetuksissa on määritetty, että muutoksenhaut esitetään kaaviossa, kaikkiTuomiot-taulukkoon
    // tulee kaikki em. tiedot, muussa tapauksessa ainoastaan konkurrenssin kannalta merkityksellisen
    // oikeusasteen tiedot kunkin tuomion kohdalta

    if (mhKaaviossa) {

        // lisätään ehdottomat tuomiot kaikkiTuomiot-taulukkoon (eri oikeusasteet sikäli kuin niitä on)
        for (let i = 0; i < ehdottomatTuomiot.length; i++) {
            if (ehdottomatTuomiot[i].tuomioistuin3 != "") {
                kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm3),
                    new Date(ehdottomatTuomiot[i].pvm2), 3]);
                kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm2),
                    new Date(ehdottomatTuomiot[i].pvm1), 2]);
                kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm1),
                    null, 1]);
            } else if (ehdottomatTuomiot[i].tuomioistuin2 != "") {
                kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm2),
                    new Date(ehdottomatTuomiot[i].pvm1), 2]);
                kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm1),
                    null, 1]);
            } else {
                kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm1),
                    null, 1]);
            }
        }

        // lisätään vastaavasti ehdolliset tuomiot kaikkiTuomiot-taulukkoon (eri oikeusasteet sikäli kuin niitä on)
        for (let i = 0; i < ehdollisetTuomiot.length; i++) {
            if (ehdollisetTuomiot[i].tuomioistuin3 != "") {
                kaikkiTuomiot.push([false, i, new Date(ehdollisetTuomiot[i].pvm3),
                    new Date(ehdollisetTuomiot[i].pvm2), 3]);
                kaikkiTuomiot.push([false, i, new Date(ehdollisetTuomiot[i].pvm2),
                    new Date(ehdollisetTuomiot[i].pvm1), 2]);
                kaikkiTuomiot.push([false, i, new Date(ehdollisetTuomiot[i].pvm1),
                    null, 1]);
            } else if (ehdollisetTuomiot[i].tuomioistuin2 != "") {
                kaikkiTuomiot.push([false, i, new Date(ehdollisetTuomiot[i].pvm2),
                    new Date(ehdollisetTuomiot[i].pvm1), 2]);
                kaikkiTuomiot.push([false, i, new Date(ehdollisetTuomiot[i].pvm1),
                    null, 1]);
            } else {
                kaikkiTuomiot.push([false, i, new Date(ehdollisetTuomiot[i].pvm1),
                    null, 1]);
            }
        }

    } else {

        // jos muutoksenhakuja ei esitetä kaaviossa (ks. lähemmin yllä)

        for (let i = 0; i < ehdottomatTuomiot.length; i++) {
            kaikkiTuomiot.push([true, i, new Date(ehdottomatTuomiot[i].pvm), null,
                ehdottomatTuomiot[i].katkaisevaTuomio]);
        }

        // ehdollisissa tuomioissa merkitykselliseksi oikeusasteeksi merkitään ensimmäinen oikeusaste
        for (let i = 0; i < ehdollisetTuomiot.length; i++) {
            kaikkiTuomiot.push([true, i, new Date(ehdollisetTuomiot[i].pvm1), null, 1]);
            if (ehdollisetTuomiot[i].tuomioistuin2 != "") {
                kaikkiTuomiot[kaikkiTuomiot.length - 1][4] = 2;
                if (ehdollisetTuomiot[i].tuomioistuin3 != "") {
                    kaikkiTuomiot[kaikkiTuomiot.length - 1][4] = 3;
                }
            }
        }

    }

    // lajitellaan kaikkiTuomiot-taulukko aikajärjestykseen
    kaikkiTuomiot.sort(function(a, b) {return a[2] - b[2]});

    // ajallisesti viimeisen tuomion pvm on myöhäisin kaaviossa näkyvä pvm
    // kaavio ei pääty seuraavan kk:n vaan sitä seuraavan kk:n alkuun
    väliviivaPvm = new Date(kaikkiTuomiot[kaikkiTuomiot.length - 1][2].getFullYear(),
        kaikkiTuomiot[kaikkiTuomiot.length - 1][2].getMonth() + 2, 1);

    // asetetaan em. ajankohta kaavion alareunan rajaksi
    loppupvmY = pvmY(väliviivaPvm);

    // siihen verrataan, kun etsitään seuraavaksi varhaisin kaaviossa näkyvä pvm
    alkupvmY = loppupvmY;

    // seuraavaksi etsitään ajallisesti varhaisin rikos, jonka pvm on varhaisin kaaviossa näkyvä pvm
    // ensin ehdottomien tuomioiden osalta
    for (let i = 0; i < rikosluetteloEhdottomat.length; i++) {
        if (pvmY(rikosluetteloEhdottomat[i].pvm) < alkupvmY) {
            // aloitetaan edellisen kuukauden alusta
            väliviivaPvm = new Date(rikosluetteloEhdottomat[i].pvm.getFullYear(),
                rikosluetteloEhdottomat[i].pvm.getMonth() - 1, 1);
            // kaavion vaakaviivan sijainti
            väliviivaY = pvmY(väliviivaPvm);
            // kaavion yläraja
            alkupvmY = väliviivaY;
        }
    }

    // sitten vastaavasti ehdollisten tuomioiden osalta
    for (let i = 0; i < rikosluetteloEhdolliset.length; i++) {
        if (pvmY(rikosluetteloEhdolliset[i].pvm) < alkupvmY) {
            // aloitetaan edellisen kuukauden alusta
            väliviivaPvm = new Date(rikosluetteloEhdolliset[i].pvm.getFullYear(),
                rikosluetteloEhdolliset[i].pvm.getMonth() - 1, 1);
            // kaavion vaakaviivan sijainti
            väliviivaY = pvmY(väliviivaPvm);
            // kaavion yläraja
            alkupvmY = väliviivaY;
        }
    }

    // aloitetaan SVG-osio; kaavion korkeus lasketaan lopuksi, joten otetaan talteen sitä koskevan elementin sijainti
    // kaavionKorkeusIndeksi-muuttujaan
    tulosteHTML.push("<div class='kaavio'>\n\n<svg width='" + kaavionLeveys
        + "' height='");
    tulosteHTML.push("");
    let kaavionKorkeusIndeksi = tulosteHTML.length - 1;
    tulosteHTML.push("'>\n");

    // lisätään kuukausien vaakaviivat ja kuukausinumerot

    while (väliviivaY <= loppupvmY) {

        // lisätään kuukauden vaakaviiva
        if (värillinenKaavio) {
            lisääKaavioonViiva(tulosteHTML, rikoksetX, (väliviivaY - alkupvmY + pystymarginaali), tuomiotX - 1,
                (väliviivaY - alkupvmY + pystymarginaali), "#d0d0d0", 1);
        } else {
            lisääKaavioonViiva(tulosteHTML, rikoksetX, (väliviivaY - alkupvmY + pystymarginaali), tuomiotX - 1,
                (väliviivaY - alkupvmY + pystymarginaali), "black", 1);
        }

        // lisätään vaakaviivan jatke kuukausinumeron kohdalle (eri värinen, jos kaavio on värillinen)
        if (värillinenKaavio) {
            lisääKaavioonViiva(tulosteHTML, rikoksetX - 10, (väliviivaY - alkupvmY + pystymarginaali), rikoksetX,
                (väliviivaY - alkupvmY + pystymarginaali), "#888", 1);
        } else {
            lisääKaavioonViiva(tulosteHTML, rikoksetX - 10, (väliviivaY - alkupvmY + pystymarginaali), rikoksetX,
                (väliviivaY - alkupvmY + pystymarginaali), "black", 1);
        }

        // lisätään kuukausinumero
        lisääKaavioonTekstinAloitus(tulosteHTML, rikoksetX - 15, väliviivaY - alkupvmY + 2 + pystymarginaali,
            "middle", "end", "black");
        tulosteHTML.push(väliviivaPvm.getMonth() + 1); // kuukausi
        tulosteHTML.push("/"); // kauttaviiva
        tulosteHTML.push(väliviivaPvm.getFullYear()); // vuosi nelinumeroisena
        lisääKaavioonTekstinLopetus(tulosteHTML);

        // siirrytään kuukaudella eteenpäin
        väliviivaPvm = new Date(väliviivaPvm.getFullYear(), väliviivaPvm.getMonth() + 1, 1);
        väliviivaY = pvmY(väliviivaPvm);

    }

    // vasen ja oikea reuna
    lisääKaavioonViiva(tulosteHTML, rikoksetX, pystymarginaali, rikoksetX, (loppupvmY - alkupvmY + pystymarginaali),
        "black", 2);
    lisääKaavioonViiva(tulosteHTML, tuomiotX, pystymarginaali, tuomiotX, (loppupvmY - alkupvmY + pystymarginaali),
        "black", 2);

    // vasemman ja oikean reunan jatke yläpuolelle Rikokset- ja Tuomiot-otsikoiden kohdalle
    // (ohuempi kuin vasen ja oikea reuna ja myös eri värinen, jos kaavio on värillinen)
    if (värillinenKaavio) {
        lisääKaavioonViiva(tulosteHTML, rikoksetX, pystymarginaali, rikoksetX, pystymarginaali - 15, "#888", 1);
        lisääKaavioonViiva(tulosteHTML, tuomiotX, pystymarginaali, tuomiotX, pystymarginaali - 15, "#888", 1);
    } else {
        lisääKaavioonViiva(tulosteHTML, rikoksetX, pystymarginaali, rikoksetX, pystymarginaali - 15, "black", 1);
        lisääKaavioonViiva(tulosteHTML, tuomiotX, pystymarginaali, tuomiotX, pystymarginaali - 15, "black", 1);
    }

    // ylä- ja alareuna
    lisääKaavioonViiva(tulosteHTML, rikoksetX, pystymarginaali, tuomiotX, pystymarginaali, "black", 2);
    lisääKaavioonViiva(tulosteHTML, rikoksetX, (loppupvmY - alkupvmY + pystymarginaali), tuomiotX,
        (loppupvmY - alkupvmY + pystymarginaali), "black", 2);

    // kaavion otsikko "Rikokset"
    lisääKaavioonTekstinAloitus(tulosteHTML, rikoksetX, (pystymarginaali - 30),
        "auto", "middle", "black", "font-weight: bold");
    tulosteHTML.push("Rikokset");
    lisääKaavioonTekstinLopetus(tulosteHTML);

    // kaavion otsikko "Tuomiot"
    lisääKaavioonTekstinAloitus(tulosteHTML, tuomiotX, (pystymarginaali - 30),
        "auto", "middle", "black", "font-weight: bold");
    tulosteHTML.push("Tuomiot");
    lisääKaavioonTekstinLopetus(tulosteHTML);

    // käydään ensin läpi kaikki ehdottomien tuomioiden rikokset ja piirretään niistä viivat tuomioihin

    for (let i = 0; i < rikosluetteloEhdottomat.length; i++) {

        let viivanVäri = värivalikoima[rikosluetteloEhdottomat[i].konkurrenssiryhmänro % värivalikoima.length];
        if (!värillinenKaavio) {
            viivanVäri = "black";
        }

        let rikoksenY = pvmY(rikosluetteloEhdottomat[i].pvm) - alkupvmY + pystymarginaali;
        let tuomionY = pvmY(ehdottomatTuomiot[rikosluetteloEhdottomat[i].tuomionro].pvm) - alkupvmY
            + pystymarginaali;

        // piirretään jokaisesta rikoksesta viiva tuomioon, jossa se on tuomittu, ja lisätään rikoksen kohdalle ympyrä

        lisääKaavioonViiva(tulosteHTML, rikoksetX, rikoksenY, tuomiotX, tuomionY, viivanVäri, 2);
        lisääKaavioonYmpyra(tulosteHTML, rikoksetX, rikoksenY, 3, "black", 1, viivanVäri);

    }

    // käydään sitten läpi kaikki ehdollisten tuomioiden rikokset ja piirretään niistä viivat tuomioihin

    for (let i = 0; i < rikosluetteloEhdolliset.length; i++) {

        let rikoksenY = pvmY(rikosluetteloEhdolliset[i].pvm) - alkupvmY + pystymarginaali;
        let tuomionY = pvmY(ehdollisetTuomiot[rikosluetteloEhdolliset[i].tuomionro].pvm) - alkupvmY
            + pystymarginaali;

        // piirretään jokaisesta rikoksesta viiva tuomioon, jossa se on tuomittu, ja lisätään rikoksen kohdalle ympyrä

        if (värillinenKaavio) {
            // katkoviiva, koska ehdollinen (2 viimeistä argumenttia)
            lisääKaavioonViiva(tulosteHTML, rikoksetX, rikoksenY, tuomiotX, tuomionY, "#bbb", 2, "10, 10");
            lisääKaavioonYmpyra(tulosteHTML, rikoksetX, rikoksenY, 3, "#888", 1, "#bbb");
        } else {
            // katkoviiva, koska ehdollinen (2 viimeistä argumenttia)
            lisääKaavioonViiva(tulosteHTML, rikoksetX, rikoksenY, tuomiotX, tuomionY, "black", 2, "10, 10");
            lisääKaavioonYmpyra(tulosteHTML, rikoksetX, rikoksenY, 3, "black", 1, "white");
        }

    }

    // käydään läpi kaikki tuomiot ja merkitään niille selitteet (viivat rikoksista tuomioon on piirretty edellä),
    // sekä piirretään muutoksenhakuja osoittavat viivat tuomiosta toiseen ja ympyrät tuomioiden kohdalle

    // tuomion ja tekstiselitteen y-koordinaatit vaihtuvat kaikkiTuomiot-silmukan kierrokselta toiselle
    // (tekstiselite voi olla tuomiota alempana, jos tuomiot ovat lähekkäin, jotta tekstiselitteet
    // eivät menisi päällekkäin)

    let vasenY = 0; // tuomion y-koordinaatti
    let oikeaY = 0; // tekstiselitteen y-koordinaatti

    for (let i = 0; i < kaikkiTuomiot.length; i++) {

        // haetaan käsiteltävän tuomion tiedot kaikkiTuomiot-taulukosta

        // onko kyseessä ehdoton tuomio
        let tuomioOnEhdoton = kaikkiTuomiot[i][0];
        // viittaus tuomion nroon ehdottomatTuomiot- tai ehdollisetTuomiot-taulukossa
        let tuomionIndeksi = kaikkiTuomiot[i][1];
        // tuomion päivämäärä
        let tuomionPvm = new Date(kaikkiTuomiot[i][2]);

        // onko kyseessä konkurrenssin kannalta merkityksellisen oikeusasteen tuomio?
        let onKatkaisevaOikeusaste = false;
        if (mhKaaviossa) {
            if (tuomioOnEhdoton) {
                if (kaikkiTuomiot[i][4] == ehdottomatTuomiot[tuomionIndeksi].katkaisevaTuomio) {
                    onKatkaisevaOikeusaste = true;
                }
            } else {
                if (kaikkiTuomiot[i][4] == ehdollisetTuomiot[tuomionIndeksi].katkaisevaTuomio) {
                    onKatkaisevaOikeusaste = true;
                }
            }
        } else {
            onKatkaisevaOikeusaste = true;
        }

        let tuomionVäri = 0;
        if (tuomioOnEhdoton && ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro != null) {
            tuomionVäri = värivalikoima[ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro % värivalikoima.length];
        }
        if (!värillinenKaavio) {
            tuomionVäri = "black";
        }

        // lasketaan ensin tuomion y-koordinaatti (vasenY) sekä tekstiselitteen y-koordinaatti (oikeaY),
        // joka voi olla tuomion y-koordinaattia alempana (jos tuomiot ovat lähekkäin)

        // lasketaan ko. rikoksen tuomion pvm:n y-koordinaatti
        vasenY = pvmY(tuomionPvm) - alkupvmY + pystymarginaali;

        // oikeaY on edelliseltä kierrokselta; verrataan siihen, jotta tiedetään mahtuuko teksti pystysuunnassa
        if (i > 0 && vasenY - oikeaY < 20) {
            // jos ei mahdu, otetaan riittävä etäisyys edelliseen
            oikeaY = oikeaY + 20;
        } else {
            // muutoin teksti sijoitetaan samaan kohtaan kuin tuomio
            oikeaY = vasenY;
        }

        // jos tekstiselitteen sijainti menee pidemmälle kuin kaavion tähänastinen alaraja (loppupvmY), siirretään
        // alarajaa vastaavasti
        if (oikeaY > loppupvmY - alkupvmY + pystymarginaali) {
            loppupvmY = oikeaY + alkupvmY - pystymarginaali;
        }

        // lisätään tuomion tekstiselite

        if (tuomioOnEhdoton) {

            // tuomion tekstiselite alkaa
            if (värillinenKaavio) {
                // värillisessä kaaviossa tekstin väri riippuu siitä, onko konkurrenssin kannalta ratkaiseva oikeusaste
                if (onKatkaisevaOikeusaste) {
                    // teksti mustalla, jos on em. oikeusaste
                    lisääKaavioonTekstinAloitus(tulosteHTML, tuomioseliteX, (oikeaY + 4), "middle", "start", "black");
                } else {
                    // teksti harmaalla, jos ei ole em. oikeusaste
                    lisääKaavioonTekstinAloitus(tulosteHTML, tuomioseliteX, (oikeaY + 4), "middle", "start", "#aaa");
                }
            } else {
                // teksti aina mustalla, jos mustavalkoinen kaavio
                lisääKaavioonTekstinAloitus(tulosteHTML, tuomioseliteX, (oikeaY + 4), "middle", "start", "black");
            }

            tulosteHTML.push("<tspan>");

            // jos kyseessä on konkurrenssin katkaiseva tuomio, selitteen alussa on konkurrenssiryhmän numero
            // suluissa lihavoituna (vain siinä tapauksessa, että kyseessä on oikea oikeusaste)
            if (onKatkaisevaOikeusaste && ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro != null) {
                tulosteHTML.push("<tspan class='rooma' style='font-weight: bold; fill: " + tuomionVäri + "'>");
                tulosteHTML.push("" + nroRoomalaiseksi(ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro + 1));
                tulosteHTML.push("</tspan>&nbsp;&nbsp;");
            }

            // jos kyseessä on uusi tuomio, tulostetaan tuomioistuimen nimi ja pvm punaisella korostettuna;
            // muussa tapauksessa tulostetaan tuomioistuimen nimi ja pvm sen mukaan, mistä oikeusasteesta on kyse
            if (ehdottomatTuomiot[tuomionIndeksi].tuomioistuin.includes("UUSI TUOMIO")) {
                tulosteHTML.push("<tspan style='font-weight: bold; fill: red'>");
                tulosteHTML.push(lyhennäTuomionTiedot(ehdottomatTuomiot[tuomionIndeksi].tuomioistuin) + " "
                    + pvmTekstiksi(ehdottomatTuomiot[tuomionIndeksi].pvm));
                tulosteHTML.push("</tspan>");
            } else {
                switch (kaikkiTuomiot[i][4]) {
                    case 1:
                        tulosteHTML.push(lyhennäTuomionTiedot(ehdottomatTuomiot[tuomionIndeksi].tuomioistuin1) + " "
                            + pvmTekstiksi(ehdottomatTuomiot[tuomionIndeksi].pvm1));
                        break;
                    case 2:
                        tulosteHTML.push(lyhennäTuomionTiedot(ehdottomatTuomiot[tuomionIndeksi].tuomioistuin2) + " "
                            + pvmTekstiksi(ehdottomatTuomiot[tuomionIndeksi].pvm2));
                        break;
                    case 3:
                        tulosteHTML.push(lyhennäTuomionTiedot(ehdottomatTuomiot[tuomionIndeksi].tuomioistuin3) + " "
                            + pvmTekstiksi(ehdottomatTuomiot[tuomionIndeksi].pvm3));
                        break;
                }
            }

            // selitteeseen merkitään, jos tuomio on lainvoimaa vailla
            if (!ehdottomatTuomiot[tuomionIndeksi].lainvoimaisuus) {
                if (värillinenKaavio) {
                    tulosteHTML.push("<tspan style='fill: red'>");
                }
                tulosteHTML.push(" (ei lainv.)");
                if (värillinenKaavio) {
                    tulosteHTML.push("</tspan>");
                }
            }

            tulosteHTML.push("</tspan>");

            // tuomion tekstiselite päättyy
            lisääKaavioonTekstinLopetus(tulosteHTML);

        } else {

            // jos kyseessä ehdollinen

            // tuomion tekstiselite alkaa

            if (värillinenKaavio) {
                // teksti harmaalla, jos värillinen kaavio
                lisääKaavioonTekstinAloitus(tulosteHTML, tuomioseliteX, (oikeaY + 4), "middle", "start", "#888");
            } else {
                // teksti mustalla, jos mustavalkoinen kaavio
                lisääKaavioonTekstinAloitus(tulosteHTML, tuomioseliteX, (oikeaY + 4), "middle", "start", "black");
            }

            // ehdolliset kursivoituna

            tulosteHTML.push("<tspan style='font-style: italic'>");

            // tulostetaan ehdoll. tuomion nimi eli tuomioistuimen nimi ja pvm sen mukaan, mistä oikeusasteesta on kyse
            switch (kaikkiTuomiot[i][4]) {
                case 1:
                    tulosteHTML.push(lyhennäTuomionTiedot(ehdollisetTuomiot[tuomionIndeksi].tuomioistuin1) + " "
                        + pvmTekstiksi(ehdollisetTuomiot[tuomionIndeksi].pvm1));
                    break;
                case 2:
                    tulosteHTML.push(lyhennäTuomionTiedot(ehdollisetTuomiot[tuomionIndeksi].tuomioistuin2) + " "
                        + pvmTekstiksi(ehdollisetTuomiot[tuomionIndeksi].pvm2));
                    break;
                case 3:
                    tulosteHTML.push(lyhennäTuomionTiedot(ehdollisetTuomiot[tuomionIndeksi].tuomioistuin3) + " "
                        + pvmTekstiksi(ehdollisetTuomiot[tuomionIndeksi].pvm3));
                    break;
            }

            // tieto rangaistuksen lajista tulostetaan vain, jos kyseessä on viimeisin oikeusaste
            // (alempien oikeusasteiden tiedothan eivät pääosin näy rikrekissä, joten alemman lajia ei ole tiedossa)
            // tai jos muutoksenhakuja ei näytetä kaaviossa
            let alkusulkuTulostettu = false;
            if (!mhKaaviossa || kaikkiTuomiot[i][4] == 1) {
                if (ehdollisetTuomiot[tuomionIndeksi].rangaistus.toLowerCase().indexOf("nuorisorangaistu") != -1 ||
                    ehdollisetTuomiot[tuomionIndeksi].rangaistus.toLowerCase().indexOf("nuorisopalvelu") != -1) {
                    tulosteHTML.push(" (nuorisorang.");
                } else {
                    tulosteHTML.push(" (ehdoll.");
                }
                alkusulkuTulostettu = true;
            }
            if (!ehdollisetTuomiot[tuomionIndeksi].lainvoimaisuus) {
                if (alkusulkuTulostettu) {
                    tulosteHTML.push(", <tspan ");
                } else {
                    tulosteHTML.push(" (<tspan ");
                    alkusulkuTulostettu = true;
                }
                if (värillinenKaavio) {
                    tulosteHTML.push("style='fill: red");
                }
                tulosteHTML.push("'>ei lainv.</tspan>");
            }
            if (alkusulkuTulostettu) {
                tulosteHTML.push(")");
            }
            tulosteHTML.push("</tspan>");

            // tuomion tekstiselite päättyy
            lisääKaavioonTekstinLopetus(tulosteHTML);

        }

        // piirretään lyhyt viiva tuomiosta tuomion tekstiselitteeseen

        if (tuomioOnEhdoton) {
            if (värillinenKaavio) {
                if (ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro == null || !onKatkaisevaOikeusaste) {
                    lisääKaavioonViiva(tulosteHTML, tuomiotX, vasenY, tuomioseliteX - 5, oikeaY, "#999", 1);
                } else {
                    lisääKaavioonViiva(tulosteHTML, tuomiotX, vasenY, tuomioseliteX - 5, oikeaY, tuomionVäri, 1);
                }
            } else {
                lisääKaavioonViiva(tulosteHTML, tuomiotX, vasenY, tuomioseliteX - 5, oikeaY, "black", 1);
            }
        } else { // jos kyseessä ehdollinen
            if (värillinenKaavio) {
                lisääKaavioonViiva(tulosteHTML, tuomiotX, vasenY, tuomioseliteX - 5, oikeaY, "#999", 1);
            } else {
                lisääKaavioonViiva(tulosteHTML, tuomiotX, vasenY, tuomioseliteX - 5, oikeaY, "black", 1);
            }
        }

        // ohut vaakaviiva kaavioon konkurrenssin katkaisevan ehdottoman tuomion kohdalle
        // (vain jos jos kyseessä on konkurrenssin kannalta merkityksellinen oikeusaste)

        if (tuomioOnEhdoton && onKatkaisevaOikeusaste) {
            if (värillinenKaavio) {
                if (ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro != null) {
                    lisääKaavioonViiva(tulosteHTML, rikoksetX, vasenY, tuomiotX, vasenY, tuomionVäri, 1);
                }
            } else {
                if (ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro != null) {
                    lisääKaavioonViiva(tulosteHTML, rikoksetX, vasenY, tuomiotX, vasenY, "black", 1);
                }
            }
        }

        // muutoksenhaut: piirretään kaari tuomiosta mahdolliseen seuraavan oikeusasteen tuomioon seuraavasti:
        // - kaarten leveys vaihtelee 20 - 60 pikselin välillä, jotta lähekkäiset kaaret erottuisivat toisistaan
        // - leveyttä ei haluta määrittää satunnaisesti, jottei sama ote tuottaisi aina hieman erilaista tulostetta
        // - täysin samanlaisten kaarten halutaan olevan päällekkäisiä, joten leveys riippuu vain kaaren pituudesta
        // - kaaren minimileveys on 19 - 29 pikseliä kaaren pituuden eli mh. keston (100 - 500 pv eli pikseliä) mukaan
        // - minimileveyteen lisätään 0 - 31 pikseliä alla olevan kaavan mukaisesti, jotta vierekkäiset tai toisiaan
        //   hyvin lähellä olevat kaaret olisivat silminnähden eri levyisiä; kaava tuottaa peräkkäisille luvuille
        //   seuraavat lisäykset minimileveyteen: 0, 8, 16, 24, 1, 9, 17, 25 jne. (yhteensä 4*8 eli 32 vaihtoehtoa)

        if (kaikkiTuomiot[i][3] != null) {

            let seuraavaVasenY = pvmY(kaikkiTuomiot[i][3]) - alkupvmY + pystymarginaali;
            let kaarenPituus = seuraavaVasenY - vasenY;
            let minLeveys = 19 + Math.trunc(Math.min(Math.max(kaarenPituus, 100), 500) / 40);
            let kaarenLeveys = Math.trunc(minLeveys + ((kaarenPituus % 4) * 8 + (Math.trunc(kaarenPituus / 4) % 8)));

            if (värillinenKaavio) {
                lisääKaavioonKaari(tulosteHTML, tuomiotX, vasenY, tuomiotX, seuraavaVasenY, kaarenLeveys, "#888", 1);
            } else {
                lisääKaavioonKaari(tulosteHTML, tuomiotX, vasenY, tuomiotX, seuraavaVasenY, kaarenLeveys, "black", 1);
            }

        }

        // lisätään lopuksi tuomion kohdalle ympyrä (tämä kannattaa tehdä viimeiseksi, jotta edellä tehdyn
        // muutoksenhakua osoittavan kaaren alkupää jää tuomiota esittävän ympyrän "alle"); konkurrenssin katkaisevien
        // tuomioiden ympyrät tehdään kuitenkin vasta lopuksi, jotta ne ovat päällimmäisinä

        if (tuomioOnEhdoton) {
            if (värillinenKaavio) {
                if (ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro != null && onKatkaisevaOikeusaste) {
                    // kerätään konkurrenssin katkaisevien tuomioiden tiedot (y-koordinaatti ja väri eli seuraavan
                    // rivin muuttujat vasenY ja tuomionVäri):
                    // lisääKaavioonYmpyra(tulosteHTML, tuomiotX, vasenY, 4, "black", 1, tuomionVäri);
                    katkaisevienYmpyrät.push([vasenY, tuomionVäri]);
                } else {
                    lisääKaavioonYmpyra(tulosteHTML, tuomiotX, vasenY, 3, "#888", 1, "#888");
                }
            } else {
                if (ehdottomatTuomiot[tuomionIndeksi].konkurrenssiryhmänro != null) {
                    lisääKaavioonYmpyra(tulosteHTML, tuomiotX, vasenY, 4, "black", 1, "black");
                } else {
                    lisääKaavioonYmpyra(tulosteHTML, tuomiotX, vasenY, 3, "black", 1, "white");
                }
            }
        } else { // jos kyseessä ehdollinen
            if (värillinenKaavio) {
                lisääKaavioonYmpyra(tulosteHTML, tuomiotX, vasenY, 3, "#888", 1, "#bbb");
            } else {
                lisääKaavioonYmpyra(tulosteHTML, tuomiotX, vasenY, 3, "black", 1, "white");
            }
        }

    }

    // viimeiseksi piirretään vielä konkurrenssin katkaisevia tuomioita osoittavat ympyrät, joiden tiedot
    // on koottu edellä

    for (let i = 0; i < katkaisevienYmpyrät.length; i++) {
        lisääKaavioonYmpyra(tulosteHTML, tuomiotX, katkaisevienYmpyrät[i][0], 4, "black", 1, katkaisevienYmpyrät[i][1]);
    }

    // lasketaan lopuksi kaavion korkeus
    kaavionKorkeus = loppupvmY - alkupvmY + pystymarginaali * 2;
    tulosteHTML[kaavionKorkeusIndeksi] = kaavionKorkeus.toString();

    // lopetetaan SVG-osio

    tulosteHTML.push("</svg>\n\n</div>\n\n");

    console.log("Konkurrenssikaavion tulostaminen valmis");

    // pvmY:
    // funktio, joka muuttaa päivämäärän konkurrenssikaavion mittakaavaan (y-koordinaatin osaksi)

    function pvmY(pvm) {
        // vastaus saadaan jakamalla rikoksen/tuomion pvm (.getTime) vuorokauden pituudella, joka on millisekunteina
        // 1000 * 60 * 60 * 24 eli 86400000; kaavionKoko määrittää, montako pikseliä yksi päivä vastaa
        return Math.trunc(pvm.getTime() / 86400000 * kaavionKoko);
    }

    // lisääKaavioonViiva:
    // funktio, joka lisää SVG-muotoiseen konkurrenssikaavioon viivan

    function lisääKaavioonViiva(tulosteHTML, x1, y1, x2, y2, stroke, strokewidth, strokedasharray) {
        tulosteHTML.push("<line x1='" + x1);
        tulosteHTML.push("' y1='" + y1);
        tulosteHTML.push("' x2='" + x2);
        tulosteHTML.push("' y2='" + y2);
        tulosteHTML.push("' style='stroke: " + stroke);
        tulosteHTML.push("; stroke-width: " + strokewidth);
        if (strokedasharray != undefined) {
            tulosteHTML.push("; stroke-dasharray: " + strokedasharray);
        }
        tulosteHTML.push("' />\n");
    }

    // lisääKaavioonYmpyra:
    // funktio, joka lisää SVG-muotoiseen konkurrenssikaavioon ympyrän

    function lisääKaavioonYmpyra(tulosteHTML, x, y, r, stroke, strokewidth, fill, title) {
        tulosteHTML.push("<circle cx='" + x);
        tulosteHTML.push("' cy='" + y);
        tulosteHTML.push("' r='" + r);
        tulosteHTML.push("' stroke='" + stroke);
        tulosteHTML.push("' stroke-width='" + strokewidth);
        tulosteHTML.push("' fill='" + fill);
        tulosteHTML.push("'>\n");
        if (typeof title == "string") {
            tulosteHTML.push("<title>" + title + "</title>\n");
        }
        tulosteHTML.push("</circle>\n");
    }

    // lisääKaavioonKaari:
    // funktio, joka lisää SVG-muotoiseen konkurrenssikaavioon kaaren pisteiden (x1, y1) ja (x2, y2) välille;
    // kaari kaartuu oikealle leveys-argumentin verran

    function lisääKaavioonKaari(tulosteHTML, x1, y1, x2, y2, leveys, stroke, strokewidth) {
        tulosteHTML.push("<path d='M ");
        tulosteHTML.push(x1 + " " + y1);
        tulosteHTML.push(" Q ");
        tulosteHTML.push((x2 + leveys) + " " + ((y1 + y2) * 0.5));
        tulosteHTML.push(" ");
        tulosteHTML.push(x2 + " " + y2);
        tulosteHTML.push("' stroke='" + stroke);
        tulosteHTML.push("' stroke-width='" + strokewidth);
        tulosteHTML.push("' fill-opacity='0' />\n");
    }

    // lisääKaavioonTekstinAloitus:
    // funktio, joka lisää SVG-muotoiseen konkurrenssikaavioon tekstin aloituksen

    function lisääKaavioonTekstinAloitus(tulosteHTML, x, y, alignmentbaseline, textanchor, fill, style) {
        tulosteHTML.push("<text x='" + x);
        tulosteHTML.push("' y='" + y);
        tulosteHTML.push("' alignment-baseline='" + alignmentbaseline);
        tulosteHTML.push("' text-anchor='" + textanchor);
        tulosteHTML.push("' fill='" + fill);
        if (typeof style == "string") {
            tulosteHTML.push("' style='" + style);
        }
        tulosteHTML.push("'>");
    }

    // lisääKaavioonTekstinLopetus:
    // funktio, joka lisää SVG-muotoiseen konkurrenssikaavioon tekstin lopetuksen

    function lisääKaavioonTekstinLopetus(tulosteHTML) {
        tulosteHTML.push("</text>\n");
    }

}

// ********************************************************************************************************************
// luePDFRikosrekisteriote:
// funktio, joka lukee pdf-muotoisen rikosrekisteriotteen sisällön (rikosrekisteriote) ja tallentaa siitä löydetyt
// tuomiot ja rikokset neljään taulukkoon (ehdottomatTuomiot, rikosluetteloEhdottomat, ehdollisetTuomiot ja
// rikosluetteloEhdolliset); lisäksi tiedot rikosrekisterikyselyn tekopaikasta ja ajankohdasta tallennetaan
// kyselytiedot-taulukkoon; luentaan liittyvät varoitukset tallennetaan varoitukset-taulukkoon;
// muokkaukset-oliossa on tallennettuna tieto muokkauksista, joita rikosrekisteriotteen sisältöön tehdään,
// ja siinä olevaan muutokset-taulukkoon lisätään ilmoitukset käyttäjälle em. muutoksista;
// jos vianhaku == true, luentaa koskevista vianhakutiedoista laaditaan erillinen tuloste (vianhakuHTML)
// ********************************************************************************************************************

function luePDFRikosrekisteriote(rikosrekisteriote, ehdottomatTuomiot, rikosluetteloEhdottomat, ehdollisetTuomiot,
    rikosluetteloEhdolliset, kyselytiedot, varoitukset, muokkaukset, tiivistys, tiivisteet, vianhaku, vianhakuHTML) {

    console.log("Pdf-muotoisen rikosrekisterin luenta alkaa");

    // rikosrekisteriotteen osa, josta luodaan tarvittaessa tiiviste
    let rikrekTiivisteelle = "";

    // tunnistetiedot sivuutettaville riveille, joissa on henkilötietoja tai muuta tarpeetonta tietoa tai sivunumero
    // (poisto tehdään kunkin tuomiojakson kohdalla)
    const poistettavat = ["Kyselijä", "Kyselyn käyttötarkoitus", "Sukunimi", "Etunimet", "Henkilötunnus", " klo ",
        "Kansalaisuus", "Syntymäaika", "Syntymämaa", "Syntymävaltio", "Syntymäkunta", "Kotipaikka", "Kotikunta",
        "OIKEUSREKISTERIKESKUS", "Vanajantie", "13101 HÄMEENLINNA", "RIKOSREKISTERIOTE", "Rikosrekisterilaki",
        "edelleenluovutuskielto", "osaote sisältää", "sähköisesti allekirjoitettu", "underskrivits elektroniskt",
        "electronically signed", "Puhelin Fax", "Telefon Telefax", "srekisteri@om", "Ei tietoja rikosrekisterissä",
        "Ei tietoja  rikosrekisterissä"];
    const sivunro = /^\d{1,3}\s\(\d{1,3}\)$/;
    const sivunronAlku = /^\d{1,3}$/;
    const sivunronLoppu = /^\(\d{1,3}\)$/;

    // onko käyttäjän poistettavaksi määräämä tuomio poistettu?
    let poistettavaTuomioLöytynyt = false;

    // onko löydetty tuomio, josta käyttäjä haluaa poistaa rikoksia?
    let poistettavatRikoksetTuomioLöytynyt = false;

    // onko löydetty tuomio, johon käyttäjä haluaa lisätä rikoksia?
    let muokattavaTuomioLöytynyt = false;

    // onko löydetty tuomio, jonka käyttäjä haluaa muuttaa ehdottomaksi?
    let tuomioEhdottomaksiLöytynyt = false;

    // onko jo mainittu Ritu-tietojen kopiointiin liittyvästä virhetilanteesta?
    let rituVirheMainittu = false;

    // säännöllinen lauseke, jolla testataan, sisältääkö merkkijono kirjaimia
    const kirjainlauseke = /([A-Za-z]|Å|Ä|Ö|å|ä|ö)/;

    // luettelo RL 7:9:n mukaisista valtioista tai niiden lyhenteistä (käytetään ulkomaisten tuomioiden tunnistamiseen)
    const ulkomaat = ["Itäval", "Belgia", "Bulgaria", "Kroatia", "Kypro", "Tsekin", "Tsekki", "Tanska", "Viro",
        "Ranska", "Saksa", "Kreikka", "Kreika", "Helleeni", "Unkari", "Irlan", "Italia", "Latvia", "Liettua",
        "Luxemburg", "Malta", "Alankoma", "Hollan", "Puola", "Portugal", "Romania", "Slovakia", "Slovenia",
        "Espanja", "Ruotsi", "Kuningaskun", "Englan", "Wales", "Skotlan", "Islan", "Norja",
        "(AT)", "(AUT)", "(BE)", "(BEL)", "(BG)", "(BGR)", "(HR)", "(HRV)", "(CY)", "(CYP)", "(CZ)", "(CZE)", "(DK)",
        "(DNK)", "(EE)", "(EST)", "(FR)", "(FRA)", "(DE)", "(DEU)", "(GR)", "(GRC)", "(HU)", "(HUN)", "(IE)", "(IRL)",
        "(IT)", "(ITA)", "(LV)", "(LVA)", "(LT)", "(LTU)", "(LU)", "(LUX)", "(MT)", "(MLT)", "(NL)", "(NLD)", "(PL)",
        "(POL)", "(RO)", "(ROU)", "(SK)", "(SVK)", "(SI)", "(SVN)", "(ES)", "(ESP)", "(SE)", "(SWE)", "(GB)", "(GBR)",
        "(IS)", "(ISL)", "(NO)", "(NOR)"];

    // jos käyttäjä haluaa muokata rikosrekisteriotetta lisäämällä uuden tuomion, lisätään se loppuun tekstinä;
    // jos uuden tuomion päivämäärää ei ole määritetty, se on kuluva päivä
    // (huom. osa koodista toistuu alempana ehdollisen/nuorisorangaistuksen ehdottomaksi muuttamisen yhteydessä)

    if (muokkaukset.uudenTuomionPvm != "" && muokkaukset.uudenTuomionRikokset == "") {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjä on määrittänyt rikosrekisteriotteen tietoihin "
            + "lisättävän tuomion päivämäärän (" + muokkaukset.uudenTuomionPvm + ") mutta ei tuomioon lisättäviä "
            + "rikoksia. Tuomiota ei&nbsp;lisätä.</b>");
    }

    if (muokkaukset.uudenTuomionRikokset != "") {

        let stilisoituPvm = "";
        let jatkoteksti = "";

        // muunnetaan Ritu- tai Aipa-tuomiolauselman tiedot rikosrekisteriotteen tietoja vastaavaan muotoon
        if (muokkaukset.uusiTuomioLaji == "Ritu") {
            muokkaukset.uudenTuomionRikokset = muunnaTLrikokset(muokkaukset.uudenTuomionRikokset, true);
        } else if (muokkaukset.uusiTuomioLaji == "Aipa") {
            muokkaukset.uudenTuomionRikokset = muunnaTLrikokset(muokkaukset.uudenTuomionRikokset, false);
        }

        // korjataan väliviivat
        muokkaukset.uudenTuomionRikokset = korjaaVäliviivat(muokkaukset.uudenTuomionRikokset);

        if (muokkaukset.uudenTuomionPvm != "") {
            stilisoituPvm = stilisoiKäyttäjänPvm(muokkaukset.uudenTuomionPvm);
            if (stilisoituPvm == "") {
                muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän uudelle tuomiolle syöttämää "
                    + "päivämäärää (" + muokkaukset.uudenTuomionPvm + ") ei pystytty tulkitsemaan. "
                    + "Uuden tuomion päivämääräksi merkitään sen sijaan kuluva päivä.</b>");
                jatkoteksti = " (päivämääränä kuluva päivä, koska käyttäjän syöttämän päivämäärän "
                    + "tulkinta ei onnistunut)";
            }
        } else {
            jatkoteksti = " (päivämääränä kuluva päivä, kun käyttäjä ei ole muuta ilmoittanut)";
        }

        if (stilisoituPvm == "") {
            let nyt = new Date();
            let pv = nyt.getDate() + "";
            let kk = (nyt.getMonth() + 1) + "";
            let v = nyt.getFullYear();
            stilisoituPvm = pv.padStart(2, "0") + "." + kk.padStart(2, "0") + "." + v;
        }

        rikosrekisteriote += "\n\nTuomio\n" + stilisoituPvm + "\n\n";
        rikosrekisteriote += "UUSI TUOMIO Ei lainvoimainen\n";
        rikosrekisteriote += "no 999999\n\n";
        rikosrekisteriote += muokkaukset.uudenTuomionRikokset + "\n\n";
        rikosrekisteriote += "Yhteinen rangaistus\nSyyksi luetut rikokset\n??? vuotta vankeutta\n\n";
            muokkaukset.muutokset.push("Rikosrekisteriotteen tietoihin on lisätty käyttäjän määrittämä uusi tuomio, "
                + "jonka pitäisi näkyä tässä tulosteessa nimellä "
                + "UUSI&nbsp;TUOMIO" + (" " + stilisoituPvm).replace(" 0", " ").replace(".0", ".")
                + " no&nbsp;999999" + jatkoteksti);

    }

    // käsitellään tilanteet, joissa on määritetty vain tuomio, josta rikoksia poistetaan, tai poistettavat rikokset
    // muttei molempia
    if (muokkaukset.poistettavatRikoksetTuomio != "" && muokkaukset.poistettavatRikokset == "") {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjä on määrittänyt vain tuomion, josta rikoksia "
            + "poistetaan (no&nbsp;" + muokkaukset.poistettavatRikoksetTuomio + "), mutta ei poistettavia rikoksia. "
            + "Poistoja ei&nbsp;tehdä.</b>");
        muokkaukset.poistettavatRikoksetTuomio = "";
    }
    if (muokkaukset.poistettavatRikoksetTuomio == "" && muokkaukset.poistettavatRikokset != "") {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjä on määrittänyt vain rikokset, jotka pitää "
            + "poistaa tietystä tuomiosta, mutta ei tuomiota, josta ne poistetaan. Poistoja ei&nbsp;tehdä.</b>");
        muokkaukset.poistettavatRikokset = "";
    }

    // käsitellään tilanteet, joissa on määritetty vain tuomio, johon rikoksia lisätään, tai lisättävät rikokset
    // muttei molempia
    if (muokkaukset.muokattavaTuomio != "" && muokkaukset.muokattavaTuomioRikokset == "") {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjä on määrittänyt vain tuomion, johon rikoksia "
            + "lisätään (no&nbsp;" + muokkaukset.muokattavaTuomio + "), mutta ei lisättäviä rikoksia. "
            + "Tuomioon ei&nbsp;tehdä muutoksia.</b>");
        muokkaukset.muokattavaTuomio = "";
    }
    if (muokkaukset.muokattavaTuomio == "" && muokkaukset.muokattavaTuomioRikokset != "") {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjä on määrittänyt vain rikokset, jotka pitää "
            + "lisätä tiettyyn tuomioon, mutta ei tuomiota, johon ne lisätään. Lisäyksiä ei&nbsp;tehdä.</b>");
        muokkaukset.muokattavaTuomioRikokset = "";
    }

    // käsitellään tilanteet, joissa on määritetty ehdottomaksi muutettavan tuomion ylemmän asteen antopäivä
    // muttei olemassa olevan ehdollisen ratkaisunumeroa
    if (muokkaukset.tuomioEhdottomaksiPvm != "" && muokkaukset.tuomioEhdottomaksi == "")  {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjä on määrittänyt ehdottomaksi muutettavan "
            + "ehdollisen tai nuorisorangaistuksen ylemmän asteen antopäivän (" + muokkaukset.tuomioEhdottomaksiPvm
            + ") muttei ratkaisunumeroa olemassa olevalle alemman asteen ehdolliselle tai nuorisorangaistukselle, "
            + "johon muutos kohdistuisi. Muutosta ei&nbsp;tehdä.</b>");
    }

    // aloitetaan rikosrekisteriotteen luenta

    // stilisoidaan otetta:
    // - korvataan rivinvaihdot katkaisumerkillä (·) ja poistetaan "rivien" alusta ja lopusta tyhjät merkit
    // - muunnetaan peräkkäiset tyhjät merkit yksittäisiksi välilyönneiksi
    // (huom! vastaava stilisointi on jäljempänä kohdassa, jossa lisätään olemassa olevaan tuomioon rikoksia)
    rikosrekisteriote = rikosrekisteriote
        .replace(/(\r\n|\n|\r)/gm, "·")
        .replace(/\s*·\s*/g, "·")
        .replace(/ +/g, " ");

    // luodaan tuomiojaksot-taulukko, joista kukin sisältää enintään yhden tuomion, jakamalla rikosrekisteriote
    // merkkijonoiksi sanan "Tuomio" ja sitä seuraavan katkaisumerkin kohdalta
    let tuomiojaksot = rikosrekisteriote.split(/Tuomio·/);

    // laskurit ehdottomille ja ehdollisille tuomioille
    let tuomiolaskuriEhdottomat = 0;
    let tuomiolaskuriEhdolliset = 0;

    // jos käyttäjä haluaa määrittää tiettyjä tuomioita konkurrenssin katkaiseviksi, jaetaan käyttäjän ilmoittama
    // tuomioluettelo taulukoksi (poistetaan välilyönnit ja katkaistaan pilkkujen kohdalta); lisäksi luodaan
    // taulukko, jonka avulla pidetään kirjaa siitä, mitkä ilmoitetuista tuomioista ovat löytyneet
    let katkaisevat = [];
    let katkaisevatLöytyneet = [];
    if (muokkaukset.katkaisevatTuomiot != "") {
        katkaisevat = muokkaukset.katkaisevatTuomiot.replace(/\s/g, "").split(",");
        if (katkaisevat.length == 1 && katkaisevat[0] == "") {
            katkaisevat = [];
        } else {
            katkaisevatLöytyneet = new Array(katkaisevat.length);
            katkaisevatLöytyneet.fill(false);
        }
    }

    // vianhakutulosteen kohta, johon lisätään tiedot otteen ottamisajankohdasta
    let vianhakuAjankohtaIndeksi = 0;

    // tulostetaan tarvittaessa vianhakutulosteen johdanto

    if (vianhaku) {
        let nyt = ajankohtaTekstiksi(new Date());
        let js = "script";
        vianhakuHTML.push("<!D" + "OCTYPE ht" + "ml>\n\n<ht" + "ml lang='fi'>\n\n<head>\n<meta charset='utf-8'>\n"
            + "<" + js + ">throw new Error('JS pois');</" + js + ">\n"
            + "<title>Rikosrekisterin luentatiedot vianhakua varten " + nyt + "</title>\n");
        vianhakuHTML.push("<style>\n"
            + "body {\n"
            + "  margin: 25px auto 5px auto; width: 900px;\n"
            + "  font-size: 12pt;\n"
            + "  font-family: system-ui, Calibri, Helvetica, Arial, sans-serif;\n"
            + "  font-weight: normal;\n"
            + "}\n"
            + "hr { border-top: 1px solid #888; }\n"
            + "h1 { font-size: 20pt; }\n"
            + "h2 { font-size: 16pt; }\n"
            + "ul { list-style-type: none; padding-left: 1em; }\n"
            + "ul li:before { content: '–'; position: absolute; margin-left: -1em; }\n"
            + "table { width: 100%; border-collapse: collapse; font-size: 10pt }\n"
            + "th, td { vertical-align: top; text-align: left, margin: 0; padding: 2px; border: 1px solid #aaa }\n"
            + "th { background: #ddd;\n"
            + "  border-top: 0; border-right: 0; border-bottom: 3px double black; border-left: 0 }\n"
            + "th.otsikko1 { width: 40% }\n"
            + "th.otsikko2 { width: 50% }\n"
            + "th.nro, td.nro { width: 5%; text-align: center }\n"
            + "tr.tilamuutosylä td { border-top: 3px double #888 }\n"
            + "tr.tilamuutosala td { border-bottom: 3px double #888 }\n"
            + "tr.lisäyksetpäättyvät td { background: #fee }\n"
            + "tr:last-child td { border-bottom: 0 }\n"
            + "td:first-child { border-left: 0 }\n"
            + "td:last-child { border-right: 0 }\n"
            + ".vianhakukorostus { color: red; }\n"
            + ".vianhakuhimmennys { color: #888; }\n"
            + "</style>\n\n");
        vianhakuHTML.push("</head>\n\n<body>\n\n");
        vianhakuHTML.push("<h1>Rikosrekisterin luentatiedot vianhakua varten " + nyt + "</h1>\n");
        vianhakuHTML.push("<p><b>SALASSA PIDETTÄVÄ</b>, sisältää rikosrekisteritietoja. Ks. rikosrekisterilaki 3 ja "
            + "11&nbsp;§, laki oikeudenkäynnin julkisuudesta yleisissä tuomioistuimissa 9&nbsp;§ 1&nbsp;mom. "
            + "4&nbsp;kohta sekä laki viranomaisten toiminnan julkisuudesta 24&nbsp;§ 1&nbsp;mom. 28&nbsp;kohta."
            + "</p>\n");
        if (tuomioistuinkäyttö) {
            vianhakuHTML.push("<p><b>Konkurrenssikoneen versio:</b><br>" + versio
                + " (vain tuomioistuinkäyttöön tarkoitettu versio)</p>\n");
        } else {
            vianhakuHTML.push("<p><b>Konkurrenssikoneen versio:</b><br>" + versio
                + " (julkinen versio)</p>\n");
        }
        vianhakuHTML.push("");
        vianhakuAjankohtaIndeksi = vianhakuHTML.length - 1;
        if (muokkaukset.uudenTuomionRikokset != "") {
            vianhakuHTML.push("<hr>\n<p><b style='color: red'>Tietoihin on lisätty käyttäjän määrittämä "
                + "uusi ehdoton tuomio, jonka pitäisi näkyä alla rikosrekisteriotteen viimeisenä osiona nimellä "
                + "&#8221;UUSI TUOMIO&#8221;.</b></p>\n");
        }
    }

    // vianhakutulosteen johdannon tulostaminen päättyy

    // käydään läpi kukin tuomiojakso rivi riviltä (silmukka i)

    for (let i = 0; i < tuomiojaksot.length; i++) {

        let tila = 0;
        let edellinenTila = 0;

        // tila-muuttuja määrittää, missä tilassa tuomion läpikäynti on
        // 0: tuomion 1 tietojen lukeminen
        // 1: rikostietojen lukeminen
        // 2: rangaistustietojen lukeminen
        // 3: tuomion 2 tai rikostietojen lukeminen
        // 4: tuomion 3 tai rikostietojen lukeminen

        let laji = 0;
        let edellinenLaji = -1;
        let lajitYhteensä = 0;

        // laji-muuttuja määrittää, mikä on läpikäytävän rivin laji
        // (edellinenLaji on edelliseltä kierrokselta):
        // -1: nyt käsiteltävä rivi on ensimmäinen
        // 0: tunnistamaton
        // 1: tuomion pvm, aina ensimmäisenä (tuomio 1)
        // 2: tuomioistuin ja lainvoimaisuus, seuraa aina 0:aa (tuomio 1)
        // 3: ratkaisunro, seuraa aina 1:ä
        // 4: syytekohta ja rikosnimike, seuraa aina 2:a
        // 5: rikoksen pvm, seuraa aina 3:a
        // 6: "Yhteinen rangaistus" / "Syyksi luetut rikokset" tms.
        // 7: vankeuden määrä, "vankeutta"
        // 8: "on riittävä seuraamus"
        // 9: "Vankeusrangaistus on ehdollinen"
        // 10: "... oli alioikeudessa ehdollinen"
        // 11: "Suoritustiedot" = seuraava rivi on pvm, joka on jätettävä huomiotta
        // 12: tuomion pvm ja tuomioistuin (tuomio 2)
        // 13: tuomion pvm ja tuomioistuin (tuomio 3)
        // 14: ratkaisunro (tuomio 2)
        // 15: ratkaisunro (tuomio 3)
        // 16: "sijasta yhdyskuntapalvelua" ___ tuntia
        // 17: valvontarangaistus
        // 18: nuorisorangaistus
        // 19: ykp:n tms. muuntotuomio
        // 20: jäännösrangaistuksen täytäntöönpano osana yhteistä rangaistusta
        // 21: ehdollisen täytäntöönpano osana yhteistä rangaistusta
        // 22: vapaudenmenetys katsotaan rangaistuksen täydeksi suoritukseksi
        // 23: kohta, jossa käyttäjän lisäämät rikokset päättyvät, on ohitettu
        // 24: viraltapano
        // 25: jäännösrangaistuksen täytäntöönpano valvontamääräyksien rikkomisen vuoksi

        // uusi, "tyhjä" tuomio
        let uusiTuomio = new Tuomio(new Date(0), "", 0, "", true);

        // muuttujat, joihin tallennetaan eri oikeusasteiden (enintään 3) tuomioiden tiedot
        let pvm1 = new Date(0);
        let pvm2 = new Date(0);
        let pvm3 = new Date(0);
        let tuomioistuin1 = "";
        let tuomioistuin2 = "";
        let tuomioistuin3 = "";
        let ratkaisunro1 = null;
        let ratkaisunro2 = null;
        let ratkaisunro3 = null;

        // tieto siitä, onko konkurrenssin kannalta ratkaiseva oikeusaste 1, 2 vai 3
        let katkaisevaTuomio = 1;

        // uusi, "tyhjä" rikos
        let uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0))

        // taulukko, johon tuomiosta löydetyt rikokset kerätään
        let lisättävätRikokset = [];

        // onko tuomion tiedot tunnistettu?
        let tuomionTiedotTunnistettu = false;

        // onko rikoksen syytekohta ja nimike tunnistettu?
        let syytekohtaJaNimikeTunnistettu = false;

        // onko ehdoton (tai riittävä seuraamus)?
        let huomioonotettava = false;

        // onko ehdollinen (tai nuorisorangaistus)?
        let ehdollinen = false;

        // onko nuorisorangaistus?
        let nuorisorangaistus = false;

        // onko kokonaan sivuutettava (esim. ykp-muunto)?
        let sivuutettava = false;

        // sisältyykö jäännösrangaistuksen tai ehdollisen täytäntöönpano rangaistukseen?
        let jäännösrangaistuksenTP = false;
        let ehdollisenTP = false;

        // katkaistaan tuomion tietojen lukeminen viimeistään sanaan "tuomiotiedot"
        let valmis = false;

        // onko kyseessä tuomio, johon käyttäjä haluaa lisätä rikoksia, ja onko lisääminen onnistunut (oletettavasti)?
        let onMuokattavaTuomio = false;
        let muokkausOnnistui = false;

        // onko edetty kohtaan, jossa mahdolliset lisäykset päättyvät (ennen tätä kohtaa rikoksia ei poisteta;
        // oletusarvona on true, koska lisäyksiä ei lähtökohtaisesti ole, eli rikoksia voi poistaa tuomion alusta asti)
        let lisätytRikoksetOhitettu = true;

        // jos käyttäjä haluaa lisätä tuomioon rikoksia, tarkistetaan tässä vaiheessa, onko kyse ao. tuomiosta
        // (on helpompaa muokata tuomion tietoja tässä vaiheessa, kun tietoja ei ole vielä jaettu riveiksi)

        if (muokkaukset.muokattavaTuomio != "" && muokkaukset.muokattavaTuomioRikokset != "") {

            // onko kyse käyttäjän valitsemasta tuomiosta:
            // tällöin tuomion tiedoissa on rivi, jossa on pelkästään "no " + nro (molemmin puolin katkaisumerkit);
            // periaatteessa tällainen saattaisi esiintyä myös rikrekissä näkyvässä vanhassa konkurrenssilausunnossa
            // (uusissa on yleensä sana "ratkaisu");

            if (tuomiojaksot[i].includes("·no " + muokkaukset.muokattavaTuomio + "·") &&
                (tuomiojaksot[i].includes("oikeus Ei lainvoimainen·") ||
                 tuomiojaksot[i].includes("oikeus Lainv") ||
                 tuomiojaksot[i].includes("oikeus Täytäntöönp"))) {

                muokattavaTuomioLöytynyt = true;
                onMuokattavaTuomio = true;

                // muunnetaan Ritu- tai Aipa-tuomiolauselman tiedot rikosrekisteriotteen tietoja vastaavaan muotoon
                if (muokkaukset.muokattavaTuomioLaji == "Ritu") {
                    muokkaukset.muokattavaTuomioRikokset = muunnaTLrikokset(muokkaukset.muokattavaTuomioRikokset,
                        true);
                } else if (muokkaukset.muokattavaTuomioLaji == "Aipa") {
                    muokkaukset.muokattavaTuomioRikokset = muunnaTLrikokset(muokkaukset.muokattavaTuomioRikokset,
                        false);
                }

                // korjataan väliviivat
                muokkaukset.muokattavaTuomioRikokset = korjaaVäliviivat(muokkaukset.muokattavaTuomioRikokset);

                // vastaava stilisointi tehdään lisättävien rikosten tiedoille kuin edellä (koodi kopioitu ylempää)
                muokkaukset.muokattavaTuomioRikokset = muokkaukset.muokattavaTuomioRikokset
                    .replace(/(\r\n|\n|\r)/gm, "·")
                    .replace(/\s*·\s*/g, "·")
                    .replace(/ +/g, " ");

                // etsitään tuomiosta kohta, johon tuomion tiedot päättyvät ja rikosten tiedot alkavat;
                // tällaisessa kohdassa on ensin rivi, jossa on "no " ja 6 numeroa (ei välttämättä sama kuin
                // käyttäjän ilmoittama nro), ja sen perässä tyhjä rivi ja ensimmäisen rikoksen tiedot, joten
                // ko. rivi alkaa 1-3 numerolla ja sen jälkeen välilyönnillä (esim. "21 Petos") tai vastaavasti
                // pitkällä numerolla ja välilyönnillä ("esim. 3.2 Petos"); tähän kohtaan tyhjän rivin
                // (2 katkaisumerkkiä) jälkeen lisätään rikosten tiedot
                // (huom! muokattava vielä niin, että toimisi jatkossa myös 8-numeroisilla Aipa-ratkaisunumeroilla)

                let indeksi = -1;
                indeksi = tuomiojaksot[i].search(/·no\s[0-9]{6}··[0-9]{1,3}\.\s/);
                if (indeksi == -1) {
                    indeksi = tuomiojaksot[i].search(/·no\s[0-9]{6}··[0-9]{1,3}\.[0-9]{1,3}\.\s/);
                }

                // jos kohta on löytynyt, sijoitetaan lisättävät rikokset kyseiseen väliin
                // (aluksi indeksiin lisätään 12, koska em. hakukriteerin alusta sijoituskohta on 12 merkin päässä:
                // "·no·999999··"

                if (indeksi != -1) {
                    indeksi += 12;
                    let vanha = tuomiojaksot[i];
                    tuomiojaksot[i] = tuomiojaksot[i].slice(0, indeksi) + muokkaukset.muokattavaTuomioRikokset
                        + "··(lisäykset päättyvät)··" + tuomiojaksot[i].slice(indeksi);
                        // huom. lisätään varmuuden vuoksi 2 katkaisumerkkiä;
                        // "(lisäykset päättyvät)" rajaa sen, mistä rikosten poistaminen on mahdollista
                        // (lisättyjä rikoksia ei haluta poistaa, ainoastaan lisäysten jälkeisiä)
                    muokkausOnnistui = true; // tiedot on saatu lisättyä (eri asia on, onnistuuko niiden tulkinta)
                    lisätytRikoksetOhitettu = false; // arvoksi tulee true, kun lisätyt on ohitettu
                }
                // jos kohtaa ei löytynyt, muokkausOnnistui-muuttujan arvoksi jää false

            }

        }

        // katkaistaan tutkittavana oleva tuomiojakso yksittäisiksi riveiksi katkaisumerkin kohdalta
        let tuomiojaksonRivit = tuomiojaksot[i].split("·");

        // ennen kuin tuomiojaksosta etsitään tuomiot ja rikokset, poistetaan tarpeettomat rivit
        // (poistettavat- ja sivunro-vakiot määritelty yllä; lisäksi //-alkuiset kommenttirivit poistetaan)
        // samalla otetaan talteen tieto rikosrekisterikyselyn tekopaikasta ja ajankohdasta, jos tällaiset tiedot
        // tulevat vastaan, sekä tarkistetaan, onko kyse osaotteesta, josta tulostetaan varoitus
        let poistettavatRivit = [];

        // sivunumero voi olla jakautunut kahdelle riville (riippuen PDF-sovelluksesta)
        let sivunronAlkuLöytynyt = false;

        for (let j = 0; j < tuomiojaksonRivit.length; j++) {

            if (kyselytiedot[0] == "") {
                if (tuomiojaksonRivit[j].includes("Kyselijä: ")) {
                    kyselytiedot[0] = tuomiojaksonRivit[j].split("Kyselijä: ")[1].split(", ")[0].trim();
                }
                if (!kyselytiedot[0].includes("käräjäoikeus") && !kyselytiedot[0].includes("hovioikeus")
                    && !kyselytiedot[0].includes(" oikeus") && !kyselytiedot[0].includes("tingsrätt")
                    && !kyselytiedot[0].includes("hovrätt") && !kyselytiedot[0].includes("domstolen")) {
                    kyselytiedot[0] = "";
                }
            }

            if (kyselytiedot[1] == "") {
                if (tuomiojaksonRivit[j].includes(" klo ")) {
                    kyselytiedot[1] = tuomiojaksonRivit[j].trim();
                }
            }

            if (tuomiojaksonRivit[j].includes("osaote sisältää")) {
                varoitukset.push("Rikosrekisteriote on vain 10&nbsp;vuoden osaote eikä ns. koko ote. Tapauksesta "
                    + "riippuen konkurrenssiryhmät saattavat määräytyä virheellisesti pelkän osaotteen tietojen "
                    + "perusteella. Jos kuitenkin käytät osaotetta, tarkista, että otteessa on tässä tapauksessa "
                    + "riittävät tiedot konkurrenssin arvioimiseksi.");
            }

            for (let k = 0; k < poistettavat.length; k++) {
                if (tuomiojaksonRivit[j].includes(poistettavat[k])) {
                    poistettavatRivit.push(j);
                }
            }

            if (tuomiojaksonRivit[j].startsWith("//")) {
                poistettavatRivit.push(j);
            }

            if (sivunro.test(tuomiojaksonRivit[j].trim())) {
                poistettavatRivit.push(j);
            }

            if (sivunronAlkuLöytynyt && sivunronLoppu.test(tuomiojaksonRivit[j].trim())) {
                poistettavatRivit.push(j - 1);
                poistettavatRivit.push(j);
            }

            if (sivunronAlku.test(tuomiojaksonRivit[j].trim())) {
                sivunronAlkuLöytynyt = true;
            } else {
                sivunronAlkuLöytynyt = false;
            }

        }

        for (let j = poistettavatRivit.length - 1; j >= 0; j--) {
            tuomiojaksonRivit.splice(poistettavatRivit[j], 1);
        }

        // tulostetaan vianhakuosion 1 alku

        if (vianhaku) {
            vianhakuHTML.push("<hr>\n<h2>Rikosrekisteriotteen osio " + i + "/" + (tuomiojaksot.length - 1)
                + "</h2>\n");
            if (poistettavatRivit.length == 1) {
                vianhakuHTML.push("<p>Ennen osion luentaa on poistettu 1&nbsp;tarpeeton rivi.</p>\n");
            } else if (poistettavatRivit.length > 1) {
                vianhakuHTML.push("<p>Ennen osion luentaa on poistettu " + poistettavatRivit.length
                    + " tarpeetonta riviä.</p>\n");
            }

            if (vianhaku && onMuokattavaTuomio) {
                vianhakuHTML.push("<p><b style='color: red'>Tämä on tuomio, johon käyttäjä on halunnut "
                    + "lisätä rikoksia. Lisättävien rikosten pitäisi näkyä tässä vianhakutulosteessa "
                    + "ensimmäisinä, ja niitä pitäisi seurata &#8221;lisäykset päättyvät&#8221 "
                    + "&#8209;rivi.</b></p>\n");
            }

            vianhakuHTML.push("<table>\n<tr>\n<th class='otsikko1'>Rikosrekisteriotteen rivi</th>"
                + "<th class='otsikko2'>Tulkinta</th><th class='nro'>Laji</th><th class='nro'>Tila</th>\n</tr>");
        }

        // tästä alkaa tuomion tietojen tunnistaminen

        // käydään jokainen tuomion alla oleva rivi läpi
        for (let j = 0; j < tuomiojaksonRivit.length; j++) {

            // jos käyttäjä on valinnut asetuksista tiivisteen luonnin, lisätään rivin sisältö merkkijonon jatkeeksi
            // (edellä poistetut rivit, joissa on tunnistetietoja ym., jäävät siis pois eivätkä vaikuta tiivisteeseen)
            if (tiivistys) {
                rikrekTiivisteelle += tuomiojaksonRivit[j];
            }

            // tuomion laji on 0 eli tunnistamaton, jos muuta ei havaita
            laji = 0;

            // jos on kyseessä tuomio, johon on lisätty rikoksia, onko lisättyjen osio (alussa) ohitettu?
            if (tuomiojaksonRivit[j] == "(lisäykset päättyvät)") {
                lisätytRikoksetOhitettu = true;
                laji = 24;
            }

            // ulkomainen tuomio?

            for (let k = 0; k < ulkomaat.length; k++) {
                if (tuomiojaksonRivit[j].indexOf(ulkomaat[k]) != -1) {
                    // HUOM! Tärkeää: jos varoituksen sanamuotoa muutetaan, vastaava muutos on tehtävä myös
                    // laskeKokonaisrangaistukset-funktioon, jossa etsitään varoituksista tätä sanamuotoa!
                    varoitukset.push("Ote saattaa sisältää ulkomaisen tuomion: &#8221;<i>"
                        + tuomiojaksonRivit[j].replaceAll(" Lainvoimainen", "").replaceAll(" Ei lainvoimainen", "")
                        + "</i>&#8221;.");
                }
            }

            // ruotsinkielinen tuomio?

            if (tuomiojaksonRivit[j].indexOf("agakraft") != -1 ||
                tuomiojaksonRivit[j].indexOf("aga kraft") != -1 ||
                tuomiojaksonRivit[j].indexOf("erkställbar") != -1) {
                let teksti = "Ote saattaa sisältää tuomion, jonka tiedot ovat ruotsiksi. Tarkista, onko asia näin. "
                    + "Ruotsinkielisten tuomioiden tietoja kone ei pysty lukemaan. Tämä ilmoitus perustuu seuraavaan "
                    + "kohtaan rikosrekisteriotteessa:<br>";
                if (j > 0) {
                    teksti += "<i>" + tuomiojaksonRivit[j - 1] + "</i> ";
                }
                teksti += "<i>" + tuomiojaksonRivit[j] + "</i>";
                varoitukset.push(teksti);
            }

            // kun tunnistetaan päivämäärää seuraavaksi, kyseessä ei saa olla TLP-tuomio tai uusi tuomio, jossa
            // tekoaikarivillä on vielä jotain lisätietoa eli pituus on selvästi enemmän kuin pvm (10 merkkiä) eli
            // yli 15 merkkiä ja kyseessä on pitkä tulkinnanvarainen päivämäärä, jossa on toinenkin vuosiluku
            // (tällöin kyseessä esim. "17.12.1997 alkaen kesäkuuhun 1998 asti") mutta ei sanaa "oikeus" tms.
            // (jotta ei varmasti sisältäisi tuomioistuimen nimeä eli ei olisi tekoaikarivin sijaan tuomioistuinrivi),
            // eikä kyseessä saa olla myöskään nn.nn.nnnn-nn.nn.nnnn-tyyppinen selvä tekoaika
            let ehkäTulkittavaTekoaika = false;
            let riviPienellä = tuomiojaksonRivit[j].toLowerCase();
            if (((uusiTuomio.ratkaisunro < 100000 || (ratkaisunro1 > 0 && ratkaisunro1 < 10000) ||
                uusiTuomio.ratkaisunro == 999999 || onMuokattavaTuomio) && tuomiojaksonRivit[j].length > 15 &&
                /([0-9]{2}).([0-9]{2}).([0-9]{4})/.test(tuomiojaksonRivit[j].substr(0, 10)) &&
                !/([0-9]{2}).([0-9]{2}).([0-9]{4})-([0-9]{2}).([0-9]{2}).([0-9]{4})/
                    .test(tuomiojaksonRivit[j].substr(0, 21)) &&
                tuomiojaksonRivit[j].match(/[0-9]{4}/g).length > 1 &&
                !riviPienellä.includes("oikeus") && !riviPienellä.includes("rätt") &&
                !tuomiojaksonRivit[j].includes(" KO") && !tuomiojaksonRivit[j].includes(" HO") &&
                !tuomiojaksonRivit[j].includes(" KKO") && !tuomiojaksonRivit[j].includes(" HD") &&
                !tuomiojaksonRivit[j].includes(" RO") && !tuomiojaksonRivit[j].includes(" RR") &&
                !riviPienellä.includes("tuomiokunta") && !riviPienellä.includes("domsaga") &&
                !tuomiojaksonRivit[j].includes(" TK") && !tuomiojaksonRivit[j].includes(" DS"))) {
                ehkäTulkittavaTekoaika = true;
            }

            // päivämäärän tunnistus: pp.kk.vvvv

            if ((/([0-9]{2}).([0-9]{2}).([0-9]{4})/.test(tuomiojaksonRivit[j].substr(0, 10))) && // nn.nn.nnnn
                ((tuomiojaksonRivit[j].substr(0,2) > 0) && (tuomiojaksonRivit[j].substr(0,2) < 32) && // pvm 1-31
                (tuomiojaksonRivit[j].substr(3,2) > 0) && (tuomiojaksonRivit[j].substr(3,2) < 13) && // kk 1-12
                (tuomiojaksonRivit[j].substr(6,4) > 1950) && (tuomiojaksonRivit[j].substr(6,4) < 2100)) && // v 50-99
                // ei saa myöskään sisältää merkkijonoa " klo " (tällöin kyseessä on sivuutettava rivi,
                // jossa ilmoitetaan otteen ajankohta)
                (tuomiojaksonRivit[j].indexOf(" klo ") == -1) &&
                // ks. tästä edellä: ei saa olla vanhanmallinen tekoaikarivi (TLP)
                !ehkäTulkittavaTekoaika &&
                // edellinen rivi ei saa olla "Suoritustiedot" (tällöin kyseessä on suoritustietopvm)
                (edellinenLaji != 11)) {

                // jos kyseessä ensimmäinen rivi, joka ilmoittaa tuomion pvm:n
                if (edellinenLaji == -1) {

                    if (tila == 0) {
                        uusiTuomio.pvm.setFullYear(tuomiojaksonRivit[j].substr(6,4),
                            tuomiojaksonRivit[j].substr(3,2) - 1, tuomiojaksonRivit[j].substr(0,2));
                        pvm1.setFullYear(tuomiojaksonRivit[j].substr(6,4), tuomiojaksonRivit[j].substr(3,2) - 1,
                            tuomiojaksonRivit[j].substr(0,2));
                        laji = 1;
                    }

                } else {

                    // muussa tapauksessa kyseessä on tuomion 2 tai 3 pvm (tila 3 tai 4) taikka rikoksen pvm (tila 1)

                    if (tila == 3 || tila == 4) {

                        // tarkistetaan, onko rivillä ainakin yksi kirjain eli sisältääkö rivi tuomioistuimen nimen
                        // (jos ei sisällä, kyseessä ei ole tuomion 2 tai 3 pvm vaan todennäköisesti
                        // Ritu-tuomiolauselman lisäämisestä johtuva virhetilanne: käyttäjä ei ole valinnut vaihtoehtoa
                        // "Ritusta kopioitu", jolloin rivit jäävät käänteiseen järjestykseen ja tuomion tietojen
                        // alkuun tulee viimeisen lisättävän rikoksen pvm, joka siis sekoittuu tuomion tietoihin)

                        if (kirjainlauseke.test(tuomiojaksonRivit[j])) {

                            if (tila == 3) {
                                pvm2.setFullYear(tuomiojaksonRivit[j].substr(6,4),
                                    tuomiojaksonRivit[j].substr(3,2) - 1, tuomiojaksonRivit[j].substr(0,2));
                                tuomioistuin2 = tuomiojaksonRivit[j].substr(11);
                                laji = 12;
                            }

                            if (tila == 4) {
                                pvm3.setFullYear(tuomiojaksonRivit[j].substr(6,4),
                                    tuomiojaksonRivit[j].substr(3,2) - 1, tuomiojaksonRivit[j].substr(0,2));
                                tuomioistuin3 = tuomiojaksonRivit[j].substr(11);
                                laji = 13;
                            }

                        } else if (((muokkaukset.uudenTuomionRikokset != "" && muokkaukset.uusiTuomioLaji != "Ritu") ||
                            (muokkaukset.muokattavaTuomio != "" && muokkaukset.muokattavaTuomioRikokset != "" &&
                            muokkaukset.muokattavaTuomioLaji != "Ritu")) && !rituVirheMainittu) {

                            // ks. selostus ylhäällä (edellisten rivien ehto täyttyy, jos on lisätty uusi tuomio
                            // tai lisätty rikoksia olemassa olevaan tuomioon)
                            let virheilmoitus = "VIRHETILANNE! Rikosrekisteriä ei pystytä tulkitsemaan oikein, "
                                + "ja lisättyjen rikosten tekoajat ja muut tiedot voivat olla sekaisin. "
                                + "Todennäköisesti ongelma johtuu siitä, että käyttäjä on kopioinut tietoja Ritusta "
                                + "mutta on unohtanut valita vaihtoehdon ’Ritusta kopioitu’. "
                                + "Tarkista, onko oikea vaihtoehto valittu ja onko tiedot muutenkin syötetty oikein. ";

                            // lisätään ensimmäiseksi virheilmoitukseksi (ei push vaan unshift)
                            varoitukset.unshift(virheilmoitus);

                            // (näytetään lisäksi erillinen huomautus käyttäjälle heti, koska asia on syytä tarkistaa
                            // saman tien ja ottaa uusi tuloste oikeilla asetuksilla)
                            alert(virheilmoitus);

                            rituVirheMainittu = true;

                        }

                    }

                    if (tila == 1 && syytekohtaJaNimikeTunnistettu) {

                        uusiRikos.pvm.setFullYear(tuomiojaksonRivit[j].substr(6,4),
                            tuomiojaksonRivit[j].substr(3,2) - 1, tuomiojaksonRivit[j].substr(0,2));
                        laji = 5;

                        // tarkistetaan vielä, onko rivillä pvm:n perässä viiva ja toinen pvm,
                        // jolloin kyseessä on pitkä tekoaika

                        // -nn.nn.nnnn, pvm 1-31, kk 1-12, v 1950-2099
                        if ((/-([0-9]{2}).([0-9]{2}).([0-9]{4})/.test(tuomiojaksonRivit[j].substr(10, 11))) &&
                           ((tuomiojaksonRivit[j].substr(11,2) > 0) && (tuomiojaksonRivit[j].substr(11,2) < 32) &&
                           (tuomiojaksonRivit[j].substr(14,2) > 0) && (tuomiojaksonRivit[j].substr(14,2) < 13) &&
                           (tuomiojaksonRivit[j].substr(17,4) > 1950) && (tuomiojaksonRivit[j].substr(17,4) < 2100))) {
                            uusiRikos.pitkäTekoaika = true;
                            uusiRikos.alkupvm.setFullYear(tuomiojaksonRivit[j].substr(6,4),
                                tuomiojaksonRivit[j].substr(3,2) - 1, tuomiojaksonRivit[j].substr(0,2));
                            uusiRikos.pvm.setFullYear(tuomiojaksonRivit[j].substr(17,4),
                                tuomiojaksonRivit[j].substr(14,2) - 1, tuomiojaksonRivit[j].substr(11,2));
                        }

                        // lisätään uusi rikos lisättävien rikosten luetteloon (huom! sama koodi toistuu alempana)

                        if (uusiRikos.pitkäTekoaika) {
                            lisättävätRikokset.push(new Rikos(new Date(uusiRikos.pvm.getTime()),
                                uusiRikos.syytekohta, uusiRikos.nimike, tuomiolaskuriEhdottomat, null, true,
                                new Date(uusiRikos.alkupvm.getTime()), uusiRikos.pvmTeksti, uusiRikos.pvmEpäselvä));
                        } else {
                            lisättävätRikokset.push(new Rikos(new Date(uusiRikos.pvm.getTime()),
                                uusiRikos.syytekohta, uusiRikos.nimike, tuomiolaskuriEhdottomat, null, false,
                                null, uusiRikos.pvmTeksti, uusiRikos.pvmEpäselvä));
                        }

                        // merkitään uuden rikoksen kohdalle myös tieto siitä, onko kyseessä lisätty rikos

                        if (lisätytRikoksetOhitettu) {
                            lisättävätRikokset[lisättävätRikokset.length - 1].onkoLisätty = false;
                        } else {
                            lisättävätRikokset[lisättävätRikokset.length - 1].onkoLisätty = true;
                        }

                        syytekohtaJaNimikeTunnistettu = false;

                    }
                }

            }

            // onko kyseessä ritu-aikaa edeltävä tilanne eli ratkaisunro on alle 100000?
            // (tällöin vapaamuotoisesti kirjoitettu tekoaika; KKO:ssa ilmeisesti aina alle 100000)
            // pyritään tunnistamaan tällaisesta tuomiosta tekoaika;
            // huom! myös ratkaisunro 999999
            // huom! vapaamuotoisia tekoaikoja voi olla myös tilanteessa, jossa käyttäjä haluaa lisätä kyseiseen
            // tuomioon syyksiluettuja rikoksia (onMuokattavaTuomio)
            // huom! sama ehtolauseke on osittaisena myös aiemmin

            if ((uusiTuomio.ratkaisunro < 100000 || (ratkaisunro1 > 0 && ratkaisunro1 < 10000) ||
                uusiTuomio.ratkaisunro == 999999 || onMuokattavaTuomio) && tuomiojaksonRivit[j].length > 7 &&
                tila == 1 && syytekohtaJaNimikeTunnistettu) {

                // tässä tarkistetaan vain tekoajan päättymispvm (rivi päättyy pvm:ään ja 1-nroinen pvm/kk)

                let apumuuttuja = "";

                let tunnistettu = false;

                let vuosiluku = 0;

                let onkoVuosilukua = tuomiojaksonRivit[j].match(/([0-9]{4})(?!.*[0-9]{4})/g);

                if (onkoVuosilukua != null) {
                    vuosiluku = onkoVuosilukua[0];
                }

                if (vuosiluku > 1950 && vuosiluku < 2100) {

                    // pyritään tulkitsemaan tulkinnanvarainen tekoaika (esim. "kesä 2006";
                    // tällaiset on lueteltu alussa määritellyssä ajankohdat[]-taulukossa);

                    let tulkittuTekoaika = tulkitseTekoaika(tuomiojaksonRivit[j], vuosiluku);
                    let pv = tulkittuTekoaika[0];
                    let kk = tulkittuTekoaika[1];

                    if (pv != null && kk != null) {

                        // jos tekoajan tulkinta on onnistunut:

                        uusiRikos.pvm.setFullYear(vuosiluku, kk, pv);
                        laji = 5;
                        uusiRikos.pvmTeksti = tuomiojaksonRivit[j].toString();
                        uusiRikos.pvmEpäselvä = true;
                        tunnistettu = true;
                        varoitukset.push("Tuomiossa <i>" + uusiTuomio.lyhytNimi()
                            + "</i> olevan rikoksen (<i>" + uusiRikos.syytekohta + " " + uusiRikos.nimike
                            + "</i>) tekoajankohta on tulkinnanvarainen: &#8217;<i>"
                            + tuomiojaksonRivit[j] + "</i>&#8217; &#8211; kone tulkitsee tekoajaksi tai sen "
                            + "päättymisajankohdaksi " + pvmTekstiksi(uusiRikos.pvm));

                    } else {

                        let vuosiluvunSijainti = tuomiojaksonRivit[j].lastIndexOf(vuosiluku);

                        // tarkistetaan vielä, täsmääkö pelkkä pvm (vuosiluvun sijainnista enintään 6 vasemmalle,
                        // siis nn.nn. = 6 merkkiä, plus 4 merkin vuosiluku = 10)

                        if (vuosiluvunSijainti >= 6) {
                            apumuuttuja = tuomiojaksonRivit[j].substr(vuosiluvunSijainti - 6, 10);
                        } else if (vuosiluvunSijainti == 5) {
                            apumuuttuja = tuomiojaksonRivit[j].substr(0, 9);
                        } else if (vuosiluvunSijainti == 4) {
                            apumuuttuja = tuomiojaksonRivit[j].substr(0, 8);
                        } else {
                            apumuuttuja = tuomiojaksonRivit[j].substr(vuosiluvunSijainti, 4);
                        }

                        if ((/[0-9]{2}.([0-9]{2}).([0-9]{4})/.test(apumuuttuja)) && // nn.nn.nnnn
                            (apumuuttuja.substr(0,2) > 0) && (apumuuttuja.substr(0,2) < 32) && // pv 1-31
                            (apumuuttuja.substr(3,2) > 0) && (apumuuttuja.substr(3,2) < 13) && // kk 1-12
                            (apumuuttuja.substr(6,4) > 1950) && (apumuuttuja.substr(6,4) < 2100)) { // v 1951-2099
                            uusiRikos.pvm.setFullYear(apumuuttuja.substr(6,4), apumuuttuja.substr(3,2) - 1,
                                apumuuttuja.substr(0,2));
                            laji = 5;
                            uusiRikos.pvmTeksti = tuomiojaksonRivit[j].toString();
                            tunnistettu = true;
                        }

                        if (!tunnistettu) {

                            if (apumuuttuja.length == 10) {
                                apumuuttuja = apumuuttuja.slice(1); // poistetaan 1. merkki (ei ollut nn.nn.nnnn)
                            }

                            if ((/[0-9].([0-9]{2}).([0-9]{4})/.test(apumuuttuja)) && // n.nn.nnnn
                                (apumuuttuja.substr(0,1) > 0) && (apumuuttuja.substr(0,1) < 32) && // pv 1-31
                                (apumuuttuja.substr(2,2) > 0) && (apumuuttuja.substr(2,2) < 13) && // kk 1-12
                                (apumuuttuja.substr(5,4) > 1950) && (apumuuttuja.substr(5,4) < 2100)) { // v 51-99
                                uusiRikos.pvm.setFullYear(apumuuttuja.substr(5,4), apumuuttuja.substr(2,2) - 1,
                                    apumuuttuja.substr(0,1));
                                laji = 5;
                                uusiRikos.pvmTeksti = tuomiojaksonRivit[j].toString();
                                tunnistettu = true;
                            }

                            if ((/([0-9]{2}).[0-9].([0-9]{4})/.test(apumuuttuja)) && // nn.n.nnnn
                                (apumuuttuja.substr(0,2) > 0) && (apumuuttuja.substr(0,2) < 32) && // pv 1-31
                                (apumuuttuja.substr(3,1) > 0) && (apumuuttuja.substr(3,1) < 13) && // kk 1-12
                                (apumuuttuja.substr(5,4) > 1950) && (apumuuttuja.substr(5,4) < 2100)) { // v 51-99
                                uusiRikos.pvm.setFullYear(apumuuttuja.substr(5,4), apumuuttuja.substr(3,1) - 1,
                                    apumuuttuja.substr(0,2));
                                laji = 5;
                                uusiRikos.pvmTeksti = tuomiojaksonRivit[j].toString();
                                tunnistettu = true;
                            }

                            // seuraava voi toteutua, jos sekä pv että kk ovat 1-numeroisia
                            // (tällöin n.nn.nnnn ja nn.n.nnnn eivät ole toteutuneet ja apumuuttujan 1. merkki
                            // on jotain pvm:ään kuulumatonta, esim. "-5.4.2002")

                            if (!tunnistettu) {
                                if (apumuuttuja.length == 9) {
                                    apumuuttuja = apumuuttuja.slice(1); // poistetaan 1. merkki
                                }
                                if ((/[0-9].[0-9].([0-9]{4})/.test(apumuuttuja)) &&
                                    (apumuuttuja.substr(0,1) > 0) && (apumuuttuja.substr(0,1) < 32) &&
                                    (apumuuttuja.substr(2,1) > 0) && (apumuuttuja.substr(2,1) < 13) &&
                                    (apumuuttuja.substr(4,4) > 1950) && (apumuuttuja.substr(4,4) < 2100)) {
                                    uusiRikos.pvm.setFullYear(apumuuttuja.substr(4,4), apumuuttuja.substr(2,1) - 1,
                                        apumuuttuja.substr(0,1));
                                    laji = 5;
                                    uusiRikos.pvmTeksti = tuomiojaksonRivit[j].toString();
                                    tunnistettu = true;
                                }
                            }
                        }
                    }

                    if (!tunnistettu) {
                        uusiRikos.pvm.setFullYear(vuosiluku, 6, 1);
                        laji = 5;
                        varoitukset.push("Tuomiossa <i>" + uusiTuomio.lyhytNimi()
                            + "</i> olevan rikoksen (<i>" + uusiRikos.syytekohta + " " + uusiRikos.nimike
                            + "</i>) tekoajankohdasta pystyttiin tunnistamaan vain vuosiluku: &#8217;<i>"
                            + tuomiojaksonRivit[j] + "</i>&#8217; &#8211; tekoajan päättymispäiväksi merkitään "
                            + "1.7." + vuosiluku);
                        uusiRikos.pvmTeksti = tuomiojaksonRivit[j].toString();
                        uusiRikos.pvmEpäselvä = true;
                        tunnistettu = true;
                    }

                }

                // onko vanhanmallinen pvm tunnistettu?

                if (tunnistettu) {

                    // muutetaan mahdollinen lyhyt viiva pitkäksi

                    if (typeof uusiRikos.pvmTeksti == "string") {
                        uusiRikos.pvmTeksti = uusiRikos.pvmTeksti.replaceAll(" - ", "&#8211;")
                            .replace(/\.\-/g, ".&#8211;").replace(/(\d)-(\d)/g, "$1&#8211;$2");
                    }

                    // lisätään uusi rikos lisättävien rikosten luetteloon (huom! koodi sama kuin ylempänä)

                    if (uusiRikos.pitkäTekoaika) {
                        lisättävätRikokset.push(new Rikos(new Date(uusiRikos.pvm.getTime()),
                            uusiRikos.syytekohta, uusiRikos.nimike, tuomiolaskuriEhdottomat, null, true,
                            new Date(uusiRikos.alkupvm.getTime()), uusiRikos.pvmTeksti, uusiRikos.pvmEpäselvä));
                    } else {
                        lisättävätRikokset.push(new Rikos(new Date(uusiRikos.pvm.getTime()),
                            uusiRikos.syytekohta, uusiRikos.nimike, tuomiolaskuriEhdottomat, null, false,
                            null, uusiRikos.pvmTeksti, uusiRikos.pvmEpäselvä));
                    }

                    // merkitään uuden rikoksen kohdalle myös tieto siitä, onko kyseessä lisätty rikos

                    if (lisätytRikoksetOhitettu) {
                        lisättävätRikokset[lisättävätRikokset.length - 1].onkoLisätty = false;
                    } else {
                        lisättävätRikokset[lisättävätRikokset.length - 1].onkoLisätty = true;
                    }

                    syytekohtaJaNimikeTunnistettu = false;

                }

            }

            // tuomioistuimen tunnistus: rivi päättyy aina sanoihin "Lainvoimainen" tai "Lainvoimaisuus"
            // tai "Ei lainvoimainen" tai "Täytäntöönpanok" (sana katkeaa); (ainoastaan ensimmäisen osalta!)
            // (huom! "Lainvoimaisuus" viittaa sanoihin "Lainvoimaisuus määrittämätön")

            if (tila == 0) {

                if (/Lainvoimainen$/.test(tuomiojaksonRivit[j])) {
                    uusiTuomio.tuomioistuin = tuomiojaksonRivit[j].split(" Lainvoimainen")[0];
                    tuomioistuin1 = uusiTuomio.tuomioistuin;
                    uusiTuomio.lainvoimaisuus = true;
                    laji = 2;
                }

                if (/Lainvoimaisuus$/.test(tuomiojaksonRivit[j])) {
                    uusiTuomio.tuomioistuin = tuomiojaksonRivit[j].split(" Lainvoimaisuus")[0];
                    tuomioistuin1 = uusiTuomio.tuomioistuin;
                    uusiTuomio.lainvoimaisuus = false;
                    uusiTuomio.lainvoimaisuusLisätieto = "Lainvoimaisuus määrittämätön";
                    laji = 2;
                }

                if (/Ei lainvoimainen$/.test(tuomiojaksonRivit[j])) {
                    uusiTuomio.tuomioistuin = tuomiojaksonRivit[j].split(" Ei lainvoimainen")[0];
                    tuomioistuin1 = uusiTuomio.tuomioistuin;
                    uusiTuomio.lainvoimaisuus = false;
                    laji = 2;
                }

                if (/Täytäntöönpanok$/.test(tuomiojaksonRivit[j])) {
                    uusiTuomio.tuomioistuin = tuomiojaksonRivit[j].split(" Täytäntöönpanok")[0];
                    tuomioistuin1 = uusiTuomio.tuomioistuin;
                    uusiTuomio.lainvoimaisuus = false;
                    uusiTuomio.lainvoimaisuusLisätieto = "Täytäntöönpanokelpoinen";
                    laji = 2;
                }

            }

            // ratkaisunron tunnistus: rivi alkaa merkkijonolla "no " + nro

            if ((tila == 0) || (tila == 3) || (tila == 4)) {

                if (/^no \d+$/.test(tuomiojaksonRivit[j])) {
                    switch (tila) {
                    case 0:
                        uusiTuomio.ratkaisunro = tuomiojaksonRivit[j].split("no ")[1];
                        ratkaisunro1 = uusiTuomio.ratkaisunro;
                        laji = 3;
                        tila = 3;
                    break;
                    case 3:
                        ratkaisunro2 = tuomiojaksonRivit[j].split("no ")[1];
                        katkaisevaTuomio = 2;
                        laji = 14;
                        tila = 4;
                    break;
                    case 4:
                        ratkaisunro3 = tuomiojaksonRivit[j].split("no ")[1];
                        katkaisevaTuomio = 3;
                        laji = 15;
                        tila = 1;
                        uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    break;
                    }
                }

            }

            if ((tila == 1) || (tila == 3) || (tila == 4)) {

                // rikoksen tunnistus: rivi alkaa seuraavasti: nro(ja)+piste+välilyönti+kirjain (esim. "1. Ryöstö")
                // syytekohtanumero voi päättyä pisteeseen (Ritu), välilyöntiin (TLP) tai sulkuun (vanhimmat TLP:t)

                if (/^\d+\.\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(" ")[0];
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\.\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                if (/^\d+\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(" ")[0]+".";
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                if (/^\d+\)\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(") ")[0]+".";
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\)\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                // vanhimmissa tuomioissa (sulkumerkkiin päättyvä nro) voi joskus olla myös
                // pieni alkukirjain nimikkeessä (edellä lienee jo tämä tosin tunnistettu):

                if (/^\d+\)\s([a-z]|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(") ")[0]+".";
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\)\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                // rikoksen tunnistus: rivi alkaa seuraavasti: nro(ja)+piste+nro(ja)+piste+välilyönti+kirjain
                // (esim. "1.1. Varkaus");
                // syytekohtanumero voi päättyä pisteeseen (Ritu), välilyöntiin (TLP) tai sulkuun (vanhimmat TLP:t)

                if (/^\d+\.\d+\.\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(" ")[0];
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\.\d+\.\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                if (/^\d+\.\d+\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(" ")[0]+".";
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\.\d+\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                if (/^\d+\.\d+\)\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(") ")[0]+".";
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\.\d+\)\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                // vanhimmissa tuomioissa (sulkumerkkiin päättyvä nro) voi joskus olla myös
                // pieni alkukirjain nimikkeessä:

                if (/^\d+\.\d+\)\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(tuomiojaksonRivit[j])) {
                    uusiRikos = new Rikos(new Date(0), "", "", 0, 0, false, new Date(0)) // tyhjä rikos
                    uusiRikos.syytekohta = tuomiojaksonRivit[j].split(") ")[0]+".";
                    uusiRikos.nimike = tuomiojaksonRivit[j].split(/^\d+\.\d+\)\s/)[1];
                    laji = 4;
                    syytekohtaJaNimikeTunnistettu = true;
                    tila = 1;
                }

                // rikosrekisterissä voi olla iso alkukirjain sanojen "nuorena henkilönä" jälkeen, korjataan se

                if (/^Nuorena henkilönä [A-ZÅÄÖ]/.test(uusiRikos.nimike)) {
                    uusiRikos.nimike = "Nuorena henkilönä " + uusiRikos.nimike.slice(18, 19).toLowerCase()
                        + uusiRikos.nimike.slice(19);
                }

            }

            // tarkistetaan, onko kyse tilanteesta, jossa rikosnimike jatkuu kahdelle riville:
            // (tällöin lisätään nyt käsiteltävän toisen rivin sisältö rikosnimikkeeseen)
            // lisäksi otetaan huomioon tilanteet kuten "Nuorena henkilönä Nuorena henkilönä..."
            // tai "Yllytys Yllytys..." (joista alkuosa 1. rivillä ja toistuen 2. rivillä)

            if (tila == 1 && laji == 0 && syytekohtaJaNimikeTunnistettu) {

                if (uusiRikos.nimike.toLowerCase() == tuomiojaksonRivit[j]
                    .toLowerCase().substr(0, uusiRikos.nimike.length) ||
                    uusiRikos.nimike.toLowerCase() == tuomiojaksonRivit[j]
                    .toLowerCase().slice(0 - uusiRikos.nimike.length)) {

                    uusiRikos.nimike = tuomiojaksonRivit[j];

                } else if (tuomiojaksonRivit[j].trim() != "") {

                    // joskus voi olla tavutus, kun on kahdella rivillä: "hallus- sapito",
                    // eli jätetään tavuviiva pois yhdistettäessä
                    if (uusiRikos.nimike.trim().slice(-1) == "-") {
                        uusiRikos.nimike = uusiRikos.nimike.slice(0, -1) + tuomiojaksonRivit[j];
                    } else {
                        // muussa tapauksessa väliin välilyönti
                        uusiRikos.nimike += " " + tuomiojaksonRivit[j];
                    }

                }

                laji = 4;

            }

            // rangaistuskohtaan siirtyminen ("Aikaisempi tuomio" on muuntorangaistuksissa):

            if ((/^Yhteinen rangaistus/.test(tuomiojaksonRivit[j])) ||
                (/^Vankeus/.test(tuomiojaksonRivit[j])) ||
                (/^Yhdistelmärangaistus/.test(tuomiojaksonRivit[j])) ||
                (/^Jäännösrangaistus/.test(tuomiojaksonRivit[j])) ||
                (/^Aikaisempi tuomio/.test(tuomiojaksonRivit[j])) ||
                (/^Ehdollista rangaistusta koskevat/.test(tuomiojaksonRivit[j])) ||
                (/^Yhdyskuntapalvelua koskeva ratkaisu/.test(tuomiojaksonRivit[j])) ||
                (/^Syyksi luetut rikokset/.test(tuomiojaksonRivit[j])) ||
                (/^Syyksi luettu rikos/.test(tuomiojaksonRivit[j]))) {
                laji = 6;
                tila = 2;
            }

            // vastaava testi, mutta ennen vuotta 2003 kaikki isolla:
            if ((/^YHTEINEN VANKEUSRANGAISTUS/.test(tuomiojaksonRivit[j])) ||
                (/^VANKEUS/.test(tuomiojaksonRivit[j])) ||
                (/^AIKAISEMPI TUOMIO/.test(tuomiojaksonRivit[j])) ||
                (/^JÄÄNNÖSRANGAISTUS/.test(tuomiojaksonRivit[j])) ||
                (/^NUORISORANGAISTUS/.test(tuomiojaksonRivit[j])) ||
                (/^YHDYSKUNTAPALVELU/.test(tuomiojaksonRivit[j])) ||
                (/^YHDYSKUNTAPALVELUA KOSKEVA RATKAISU/.test(tuomiojaksonRivit[j])) ||
                (/^YHDYSKUNTAPALVELUN MUUNTAMINEN VANKEUDEKSI/.test(tuomiojaksonRivit[j]))) {
                laji = 6;
                tila = 2;
            }

            // rangaistuskohdan tunnistus

            if ((tila == 2) && (!valmis)) {

                // tunnistetaan sana vankeutta mutta vältetään sanoja määräämä/tuomitsema/oikeuden/oikeus
                // (rikosrekisteriotteessa näkyvien konkurrenssilausuntojen ohittamiseksi);
                // lisäksi huomioidaan yhdistelmärangaistusvaihtoehto, jossa rivi alkaa sanoilla
                // "Vankeus x vuotta" ja jatkuu sanoilla "ja sitä välittömästi seuraava valvonta-aika"
                // (jotka sanat on tarpeen mukaan poistettava);
                // lisäksi manuaalisessa tuomiossa (ratkaisunro 999999) rangaistusta ei ole määritetty

                if ((/vankeutta$/.test(tuomiojaksonRivit[j]) && !tuomiojaksonRivit[j].includes("Ehdolliseksi jää")) ||
                    (/^Vankeus /.test(tuomiojaksonRivit[j]) &&
                     /ja sitä välittömästi/.test(tuomiojaksonRivit[j]))) {
                    if (tuomiojaksonRivit[j].indexOf("määräämä") == -1 &&
                        tuomiojaksonRivit[j].indexOf("tuomitsema") == -1 &&
                        tuomiojaksonRivit[j].indexOf("oikeuden") == -1 &&
                        tuomiojaksonRivit[j].indexOf("oikeus") == -1) {
                        uusiTuomio.rangaistus = tuomiojaksonRivit[j].split(" vankeutta")[0]
                            .replaceAll(" vuosi", "&nbsp;v").replaceAll(" vuotta", "&nbsp;v")
                            .replaceAll(" kuukautta", "&nbsp;kk").replaceAll(" kuukausi", "&nbsp;kk")
                            .replaceAll(" päivää", "&nbsp;pv") + " vankeutta";
                        if (uusiTuomio.rangaistus.indexOf(" ja sitä välittömästi") != -1) {
                            uusiTuomio.rangaistus = uusiTuomio.rangaistus.split(" ja sitä välittömästi")[0]
                                + " vankeutta (yhdistelmärang.)";
                        }
                        if (uusiTuomio.rangaistus.startsWith("Vankeus ")) {
                            uusiTuomio.rangaistus = uusiTuomio.rangaistus.slice(8);
                        }
                        if (uusiTuomio.ratkaisunro == 999999) {
                            uusiTuomio.rangaistus = "Vankeusrangaistus (tai&nbsp;vastaava)"
                        }
                        huomioonotettava = true;
                        ehdollinen = false;
                        laji = 7;
                        // seuraava tehdään tässä yhteydessä, koska jäännösrangaistuksen tai ehdollisen täytäntöönpano
                        // on tullut jo aiemmilla riveillä
                        if (jäännösrangaistuksenTP) {
                            uusiTuomio.rangaistus += " (sis.&nbsp;jäännösrangaistus)";
                        }
                        if (ehdollisenTP) {
                            uusiTuomio.rangaistus += " (sis.&nbsp;ehdollisen&nbsp;täyt.pano)";
                        }
                        uusiTuomio.rangaistus = uusiTuomio.rangaistus.replaceAll(") (", ", ");
                        uusiTuomio.rangaistus = uusiTuomio.rangaistus
                            .replaceAll("tus, sis.&nbsp;ehdoll", "tus ja ehdoll");
                    }
                }

                if (tuomiojaksonRivit[j].indexOf("sijasta yhdyskuntapalvelua") != -1 &&
                    uusiTuomio.rangaistus != "") {
                    // vanhoissa tuomioissa ykp-teksti voi jakautua 2 riville (eli rivi päättyy
                    // sanoihin "sijasta ykp"); yhdistetään tarvittaessa:
                    if (tuomiojaksonRivit[j].slice(-26) == "sijasta yhdyskuntapalvelua") {
                        tuomiojaksonRivit[j] = tuomiojaksonRivit[j] + " " + tuomiojaksonRivit[j + 1];
                    }
                    uusiTuomio.rangaistus += " &#8658; " + tuomiojaksonRivit[j]
                        .split("sijasta yhdyskuntapalvelua ")[1].replaceAll(" tuntia", "&nbsp;h")
                        .replaceAll(".","") + " ykp";
                    laji = 16;
                }

                if (tuomiojaksonRivit[j].indexOf("sijasta") != -1 &&
                    tuomiojaksonRivit[j].indexOf("valvontarangaistu") != -1 &&
                    uusiTuomio.rangaistus != "") {
                    uusiTuomio.rangaistus += " &#8658; valvontarang.";
                    laji = 17;
                }

                if (tuomiojaksonRivit[j].indexOf("riittävä seuraamus") != -1) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    uusiTuomio.rangaistus = "Riittävä seuraamus";
                    laji = 8;
                }

                // huom. voi jakautua eri riveille, joten vain 1 sana
                if (tuomiojaksonRivit[j].indexOf("riittäväksi") != -1) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    uusiTuomio.rangaistus = "Riittävä seuraamus";
                    laji = 8;
                }

                // huom. voi jakautua eri riveille, joten vain 1 sana
                if (tuomiojaksonRivit[j].indexOf("riittävänä") != -1) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    uusiTuomio.rangaistus = "Riittävä seuraamus";
                    laji = 8;
                }

                // huom. rivinvaihtojen eri sijaintivaihtoehdot TLP-ajan tuomioissa
                if (tuomiojaksonRivit[j].indexOf("koskevat myös nyt") != -1 ||
                    tuomiojaksonRivit[j].indexOf("koskee myös nyt") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt myös syyksi luetusta") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt myös syyksi luetuista") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt myös syyksi luettuja") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt myös syyksi luettua") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt syyksi luetusta") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt syyksi luetuista") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt syyksi luettuja") != -1 ||
                    tuomiojaksonRivit[j].indexOf("nyt syyksi luettua") != -1) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    uusiTuomio.rangaistus = "Riittävä seuraamus";
                    laji = 8;
                }

                // huom. rivinvaihtojen eri sijaintivaihtoehdot / eri sanamuotovaihtoehdot TLP-ajan tuomioissa
                if (tuomiojaksonRivit[j].indexOf("ovat riittävä") != -1 ||
                    tuomiojaksonRivit[j].indexOf("on riittävä") != -1 ||
                    tuomiojaksonRivit[j].indexOf("seuraamus myös") != -1 ||
                    tuomiojaksonRivit[j].indexOf("seuraamus nyt") != -1) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    uusiTuomio.rangaistus = "Riittävä seuraamus";
                    laji = 8;
                }

                if (tuomiojaksonRivit[j].indexOf("Vankeusrangaistus on ehdollinen") != -1) {
                    huomioonotettava = false;
                    ehdollinen = true;
                    uusiTuomio.rangaistus += " (ehdollinen)";
                    laji = 9;
                }

                if (tuomiojaksonRivit[j].indexOf("Suorittamatta oleva") != -1 ||
                    tuomiojaksonRivit[j].indexOf("on kokonaan suorittamatta") != -1 ||
                    tuomiojaksonRivit[j].indexOf("Suorittamatta jääneen") != -1 ||
                    tuomiojaksonRivit[j].indexOf("Vaatimus yhdyskuntapalvelun muuntamisesta") != -1) {
                    huomioonotettava = false;
                    ehdollinen = false;
                    sivuutettava = true;
                    laji = 19;
                }

                // jäännösrangaistuksen täytäntöönpanossa mahdollisia sanamuotoja ainakin:
                // "täytäntöönpantavaksi määrätty loppuosa jäännösrangaistuksesta"
                // "täytäntöönpantavaksi määrätty osa jäännösrangaistuksesta"
                // "täytäntöönpantavaksi määrätty jäännösrangaistus"

                if (tuomiojaksonRivit[j].includes("täytäntöönpantavaksi määrätty") &&
                    tuomiojaksonRivit[j].includes("jäännösrangaistu")) {
                    jäännösrangaistuksenTP = true;
                    laji = 20;
                }

                if (tuomiojaksonRivit[j].includes("Rangaistus määrätään täytäntöönpantavaksi") ||
                    tuomiojaksonRivit[j].includes("Rangaistuksesta määrätään täytäntöönpantavaksi")) {
                    ehdollisenTP = true;
                    laji = 21;
                }

                if (tuomiojaksonRivit[j].includes("katsotaan rangaistuksen täydeksi") ||
                    tuomiojaksonRivit[j].includes("täydeksi suoritukseksi")) {
                    laji = 22;
                    uusiTuomio.rangaistus += " (vap.men.aika katsotaan täydeksi suoritukseksi)";
                }

                // seuraavassa otettava huomioon "tuomittu" ja "tuomitsema" (jolloin kyse rikosrekisteriotteessa
                // näkyvästä konkurrenssilausunnosta)

                if ((tuomiojaksonRivit[j].toLowerCase().indexOf("nuorisorangaistus") != -1 ||
                     tuomiojaksonRivit[j].toLowerCase().indexOf("nuorisopalvelu") != -1) &&
                    (tuomiojaksonRivit[j].toLowerCase().indexOf("sema") == -1 &&
                     tuomiojaksonRivit[j].toLowerCase().indexOf("ttu") == -1)) {
                    huomioonotettava = false;
                    ehdollinen = true; // nuorisorangaistus lajitellaan ehdollisten joukkoon
                    nuorisorangaistus = true;
                    uusiTuomio.rangaistus = tuomiojaksonRivit[j].replaceAll(" vuosi", "&nbsp;v")
                        .replaceAll(" vuotta", "&nbsp;v")
                        .replaceAll(" kuukausi", "&nbsp;kk")
                        .replaceAll(" kuukautta", "&nbsp;kk")
                        .replaceAll(" päivää", "&nbsp;pv"
                        .replaceAll(" tuntia", "&nbsp;h"));
                    laji = 18;
                }

                if ((tuomiojaksonRivit[j].indexOf("alioikeudessa ehdollinen") != -1) ||
                    (tuomiojaksonRivit[j].indexOf("ALIOIKEUDESSA EHDOLLINEN") != -1)) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    if (tuomioistuin3 == "") {
                        katkaisevaTuomio = 1;
                    } else {
                        katkaisevaTuomio = 2;
                    }
                    laji = 10;
                }

                if ((tuomiojaksonRivit[j].indexOf("hovioikeudessa ehdollinen") != -1) ||
                    (tuomiojaksonRivit[j].indexOf("HOVIOIKEUDESSA EHDOLLINEN") != -1)) {
                    huomioonotettava = true;
                    ehdollinen = false;
                    katkaisevaTuomio = 1;
                    laji = 10;
                }

                if (tuomiojaksonRivit[j].includes("Viraltapano") ||
                    tuomiojaksonRivit[j].includes("uomitaan viralta pantavaksi") ||
                    tuomiojaksonRivit[j].includes("uomitaan pantavaksi viralta") ||
                    tuomiojaksonRivit[j].includes("uomitaan menettämään virka") ||
                    tuomiojaksonRivit[j].includes("irka tuomitaan menetetyksi")) {
                    if (!uusiTuomio.rangaistus.includes("viraltapano")) {
                        uusiTuomio.rangaistus += " + viraltapano";
                    }
                    laji = 23;
                }

            }

            // tämä saattaa tulla vastaan, kun tila == 0
            if (tuomiojaksonRivit[j].includes("täytäntöönpano valvontamääräyksien")) {
                sivuutettava = true;
                laji = 25;
            }

            if (/^Suoritustiedot/.test(tuomiojaksonRivit[j])) {
                laji = 11;
                valmis = true;
            }

            if ((uusiTuomio.pvm != 0) && (uusiTuomio.tuomioistuin != "") && (uusiTuomio.ratkaisunro != 0)) {
                tuomionTiedotTunnistettu = true;
            }

            // vianhakuosio 1: rivikohtaiset tiedot

            if (vianhaku) {

                if (laji != 24) { // punainen tausta, jos kyse on käyttäjän lisäämien rikosten päättymisestä
                    if (tila == edellinenTila) {
                        vianhakuHTML.push("<tr>");
                    } else {
                        if (tila == 1 || tila == 2) {
                            vianhakuHTML.push("<tr class='tilamuutosylä'>");
                        } else {
                            vianhakuHTML.push("<tr class='tilamuutosala'>");
                        }
                    }
                } else {
                    vianhakuHTML.push("<tr class='lisäyksetpäättyvät'>");
                }

                vianhakuHTML.push("<td>" + tuomiojaksonRivit[j] + "</td>");
                vianhakuHTML.push("<td><span style='color: blue'>");

                switch (laji) {
                    case 0:
                        if (tuomiojaksonRivit[j].trim() == "") {
                            vianhakuHTML.push("<i style='color: #aaa'>Tyhjä rivi</i>");
                        } else {
                            vianhakuHTML.push("<i style='color: red'>Ei tunnistettu</i>");
                        }
                        break;
                    case 1:
                        vianhakuHTML.push("<b>Tuomion&nbsp;1 pvm:</b> ");
                        vianhakuHTML.push(pvmTekstiksi(uusiTuomio.pvm));
                        break;
                    case 2:
                        vianhakuHTML.push("<b>Tuomioistuin&nbsp;1:</b> "
                            + lyhennäTuomionTiedot(uusiTuomio.tuomioistuin));
                        vianhakuHTML.push(", ");
                        vianhakuHTML.push("<b>lainvoimaisuus</b>: " + uusiTuomio.lainvoimaisuus);
                        if (uusiTuomio.lainvoimaisuusLisätieto != undefined) {
                            vianhakuHTML.push(", <b>lainvoimaisuuden lisätieto</b>: "
                                + uusiTuomio.lainvoimaisuusLisätieto);
                        }
                        break;
                    case 3:
                        vianhakuHTML.push("<b>Ratkaisunro:</b> " + uusiTuomio.ratkaisunro);
                        break;
                    case 4:
                        vianhakuHTML.push("<b>Kohta:</b> " + uusiRikos.syytekohta);
                        vianhakuHTML.push(", ");
                        vianhakuHTML.push("<b>nimike:</b> " + uusiRikos.nimike);
                        break;
                    case 5:
                        if (uusiRikos.pitkäTekoaika) {
                            vianhakuHTML.push("<b>Tekoaika (pitkä):</b> ");
                            vianhakuHTML.push(pvmTekstiksi(uusiRikos.alkupvm));
                            vianhakuHTML.push("&#8211;");
                            vianhakuHTML.push(pvmTekstiksi(uusiRikos.pvm));
                        } else if (uusiRikos.pvmEpäselvä) {
                            vianhakuHTML.push("<b>Tekoaika (tulkittu):</b> ");
                            vianhakuHTML.push(pvmTekstiksi(uusiRikos.pvm));
                        } else {
                            vianhakuHTML.push("<b>Tekopäivä:</b> ");
                            vianhakuHTML.push(pvmTekstiksi(uusiRikos.pvm));
                        }
                        break;
                    case 6:
                        vianhakuHTML.push("<b>Tuomiolauselman rangaistusosio</b> on alkanut viimeistään tässä");
                        break;
                    case 7:
                        vianhakuHTML.push("<b>Vankeusrangaistus:</b> " + uusiTuomio.rangaistus);
                        break;
                    case 8:
                        vianhakuHTML.push("<b>Riittävä seuraamus -tuomio</b>");
                        break;
                    case 9:
                        vianhakuHTML.push("<b>Kyseessä on ehdollinen rangaistus</b>");
                        break;
                    case 10:
                        vianhakuHTML.push("<b>Ehdotonta tuomittu vasta ylemmässä asteessa, joten sen tuomion pvm "
                            + "ratkaisee</b>");
                        break;
                    case 11:
                        vianhakuHTML.push("<b>Suoritustiedot</b>, joten seuraavan rivin pvm:n tunnistus estetään");
                        break;
                    case 12:
                        vianhakuHTML.push("<b>Tuomion&nbsp;2 pvm:</b> ");
                        vianhakuHTML.push(pvmTekstiksi(pvm2));
                        vianhakuHTML.push(", ");
                        vianhakuHTML.push("<b>tuomioistuin&nbsp;2:</b> " + lyhennäTuomionTiedot(tuomioistuin2));
                        break;
                    case 13:
                        vianhakuHTML.push("<b>Tuomion&nbsp;3 pvm:</b> ");
                        vianhakuHTML.push(pvmTekstiksi(pvm3));
                        vianhakuHTML.push(", ");
                        vianhakuHTML.push("<b>tuomioistuin&nbsp;3:</b> " + lyhennäTuomionTiedot(tuomioistuin3));
                        break;
                    case 14:
                        vianhakuHTML.push("<b>Ratkaisunro&nbsp;2:</b> " + ratkaisunro2);
                        break;
                    case 15:
                        vianhakuHTML.push("<b>Ratkaisunro&nbsp;3:</b> " + ratkaisunro3);
                        break;
                    case 16:
                        vianhakuHTML.push("<b>Ykp</b>: " + uusiTuomio.rangaistus);
                        break;
                    case 17:
                        vianhakuHTML.push("<b>Valv.rang.:</b> " +  uusiTuomio.rangaistus);
                        break;
                    case 18:
                        vianhakuHTML.push("<b>Nuorisorang.:</b> " + uusiTuomio.rangaistus);
                        break;
                    case 19:
                        vianhakuHTML.push("<b>Muuntotuomio</b>, sivuutettava");
                        break;
                    case 20:
                        vianhakuHTML.push("<b>Yhteiseen rangaistukseen sisältyy jäännösrangaistus</b>");
                        break;
                    case 21:
                        vianhakuHTML.push("<b>Yhteiseen rangaistukseen sisältyy ehdollisen täytäntöönpano</b>");
                        break;
                    case 22:
                        vianhakuHTML.push("<b>Vapaudenmenetys katsottu täydeksi suoritukseksi</b>");
                        break;
                    case 23:
                        vianhakuHTML.push("<b>Viraltapano</b>");
                        break;
                    case 24:
                        vianhakuHTML.push("<b>Käyttäjän lisäämät rikokset päättyvät</b>");
                        break;
                    case 25:
                        vianhakuHTML.push("<b>Jäännösrang. tms. täyt.pano valv.määr. rikkomisen vuoksi</b>, sivuutettava");
                        break;
                }

                vianhakuHTML.push("</span></td>");

                vianhakuHTML.push("<td class='nro'>" + laji + "</td>");

                if (tila == edellinenTila) {
                    vianhakuHTML.push("<td class='nro'>" + tila + "</td>");
                } else {
                    vianhakuHTML.push("<td class='nro'>" + edellinenTila + "→" + tila + "</td>");
                }

                vianhakuHTML.push("</tr>\n");

            }

            // vianhakuosio 1 päättyy

            edellinenLaji = laji;
            edellinenTila = tila;

            lajitYhteensä += laji;

            // tuomiojakson yksittäisen rivin läpikäynti päättyy

        }

        // tuomion tiedot on nyt luettu

        // vianhakuosio 2: tuomion ja rikosten tiedot tiivistettynä

        if (vianhaku) {

            vianhakuHTML.push("</table>");

            if (lisättävätRikokset.length > 0) {
                if (huomioonotettava) {
                    if (uusiTuomio.rangaistus == "Riittävä seuraamus") {
                        vianhakuHTML.push("<p><b>Tuomio on ns. <i>riittävä seuraamus</i> -tuomio "
                            + "(lajitellaan tässä teknisistä syistä ehdottomaksi, "
                            + "vaikka ei olekaan varsinaisesti RL 7:6.1:n soveltamisalaan kuuluva). "
                            + "Tuomion muut tiedot:</b></p>\n");
                    } else {
                        vianhakuHTML.push("<p><b>Tuomio on <i>ehdoton</i>. Tuomion muut tiedot:</b></p>\n");
                    }
                }
                if (ehdollinen) {
                    if (nuorisorangaistus) {
                        vianhakuHTML.push("<p><b>Tuomio on <i>nuorisorangaistus</i> "
                            + "(lajitellaan tässä teknisistä syistä ehdolliseksi, "
                            + "koska ei ole RL 7:6:n soveltamisalaan kuuluva). Tuomion muut tiedot:</b></p>\n");
                    } else {
                        vianhakuHTML.push("<p><b>Tuomio on <i>ehdollinen</i>. Tuomion muut tiedot:</b></p>\n");
                    }
                }
                vianhakuHTML.push("<p>");
                if (huomioonotettava || ehdollinen) {
                    vianhakuHTML.push("<b>Tuomioistuin 1:</b> " + tuomioistuin1 + " " + pvmTekstiksi(pvm1)
                        + " no " + ratkaisunro1);
                    if (katkaisevaTuomio == 1 && tuomioistuin2 != "") {
                        vianhakuHTML.push("<span style='color: red'>&nbsp;&#8592;&nbsp;Tämän oikeusasteen "
                            + "pvm ratkaisee</span>");
                    }
                    if (tuomioistuin2 != "") {
                        vianhakuHTML.push("<br><b>Tuomioistuin 2:</b> " + tuomioistuin2 + " " + pvmTekstiksi(pvm2)
                        + " no " + ratkaisunro2);
                        if (katkaisevaTuomio == 2) {
                            vianhakuHTML.push("<span style='color: red'>&nbsp;&#8592;&nbsp;Tämän oikeusasteen "
                                + "pvm ratkaisee</span>");
                        }
                    }
                    if (tuomioistuin3 != "") {
                        vianhakuHTML.push("<br><b>Tuomioistuin 3:</b> " + tuomioistuin3 + " " + pvmTekstiksi(pvm3)
                        + " no " + ratkaisunro3);
                        if (katkaisevaTuomio == 3) {
                            vianhakuHTML.push("<span style='color: red'>&nbsp;&#8592;&nbsp;Tämän oikeusasteen "
                                + "pvm ratkaisee</span>");
                        }
                    }
                    vianhakuHTML.push("</p>\n");
                    vianhakuHTML.push("<p><b>Lainvoimaisuus:</b> " + uusiTuomio.lainvoimaisuus);
                    if (uusiTuomio.lainvoimaisuusLisätieto != undefined) {
                        vianhakuHTML.push("<p><b>Lainvoimaisuuden lisätieto:</b> "
                            + uusiTuomio.lainvoimaisuusLisätieto);
                    }
                    vianhakuHTML.push("</p>\n");
                    vianhakuHTML.push("<p><b>Tuomiosta löydetyt rikokset:</b><br>");
                    for (let x = 0; x < lisättävätRikokset.length; x++) {
                        if (x > 0) {
                            vianhakuHTML.push("<br>");
                        }
                        vianhakuHTML.push(lisättävätRikokset[x].syytekohta + " "
                            + lisättävätRikokset[x].nimike + " " + lisättävätRikokset[x].tekoaikaTekstinä()[0] + " "
                            + lisättävätRikokset[x].tekoaikaTekstinä()[1]);
                    }
                    vianhakuHTML.push("</p>\n");
                    if (onMuokattavaTuomio) {
                        vianhakuHTML.push("<p><b style='color: red'>Huom! Kun tuomioon lisätään rikoksia, "
                            + "konkurrenssikone lajittelee rikokset syytekohdittain numerojärjestykseen ennen "
                            + "konkurrenssiryhmien määrittämistä. Tarkista rikosten järjestys varsinaiselta "
                            + "tulosteelta.</b></p>\n");
                    }
                    vianhakuHTML.push("<p><b>Rangaistus:</b> " + uusiTuomio.rangaistus + "</p>\n");
                }
                if (!huomioonotettava && !ehdollinen && !sivuutettava) {
                        vianhakuHTML.push("<p><b style='color: red'>Tuomion lajia (ehdollinen/ehdoton) "
                            + "ei pystytty tunnistamaan! Tuomio sivuutetaan.</b></p>\n");
                }
            } else {
                if (sivuutettava) {
                    vianhakuHTML.push("<p><b>Tuomio on sisältönsä vuoksi <i>sivuutettava</i> "
                            + "(esim. ykp-muunto tai vastaava).</b></p>\n");
                } else {
                    if (tuomionTiedotTunnistettu) {
                        vianhakuHTML.push("<p><b style='color: red'>Tämän tuomion kohdalta "
                            + "ei löydetty rikoksia! Tuomio sivuutetaan.</b></p>\n");
                    } else if (lajitYhteensä == 0) { 
                        vianhakuHTML.push("<p>Tästä rikosrekisterin osiosta ei löydetty tuomiotietoja.</p>\n");
                    } else {
                        vianhakuHTML.push("<p><b style='color: red'>Tästä rikosrekisterin osiosta "
                            + "ei tunnistettu tuomiota!</b></p>\n");
                    }
                }
            }

        }

        // vianhakuosio 2 päättyy

        if (katkaisevaTuomio == 2) {
            uusiTuomio.pvm = new Date(pvm2.getTime());
            uusiTuomio.tuomioistuin = tuomioistuin2;
            uusiTuomio.ratkaisunro = ratkaisunro2;
        }

        if (katkaisevaTuomio == 3) {
            uusiTuomio.pvm = new Date(pvm3.getTime());
            uusiTuomio.tuomioistuin = tuomioistuin3;
            uusiTuomio.ratkaisunro = ratkaisunro3;
        }

        // tarkistetaan, onko kyseessä tuomio, josta käyttäjä haluaa poistaa rikoksia, ja jos on, poistetaan
        // ko. rikokset (taulukkoon poistettavatKohdat tulee luettelo poistettavista syytekohdista)

        if (muokkaukset.poistettavatRikokset != "" &&
            (ratkaisunro1 == muokkaukset.poistettavatRikoksetTuomio ||
             ratkaisunro2 == muokkaukset.poistettavatRikoksetTuomio ||
             ratkaisunro3 == muokkaukset.poistettavatRikoksetTuomio)) {

            poistettavatRikoksetTuomioLöytynyt = true;

            if (vianhaku) {
                vianhakuHTML.push("<p><b style='color: red'>Kyseessä on tuomio, josta käyttäjä on halunnut poistaa "
                    + "rikoksia. Tässä vianhakutulosteessa ei esitetä rikosten poistamiseen liittyviä tietoja. "
                    + "Tarkista varsinaiselta tulosteelta, että rikosten poistaminen on onnistunut.</b></p>\n");
            }

            // käyttäjä luettelee poistettavat rikokset pilkuilla eroteltuina;
            // poistetaan syötteestä välilyönnit ja pilkotaan se pilkkujen kohdalta

            let poistettavatKohdat = muokkaukset.poistettavatRikokset.replace(/\s/g, "").split(",");
            let poistettavatRikoksetLuettelo = [];
            let poistettavatRikoksetLöytymättömät = "";

            // etsitään jokainen poistettava syytekohta (i-silmukka) käymällä jokainen rikos (j-silmukka);
            // jokaisesta stilisoidaan pois pisteet tai sulkumerkit lopusta, esim. 2. tai 2) => 2;
            // kun poistettava syytekohta löytyy, talletetaan sen indeksi poistettavatRikoksetLuettelo-taulukkoon;
            // sellaisia rikoksia, jotka käyttäjä on lisännyt (onkoLisätty) ei poisteta (jotta käyttäjä voi poistaa
            // tietyn rikoksen ja lisätä uuden rikoksen samalla syytekohtanumerolla)

            for (let i = 0; i < poistettavatKohdat.length; i++) {
                let poistettavaKohtaLöytynyt = false;
                poistettavatKohdat[i] = poistettavatKohdat[i].replace(/\.$/, "").replace(/\)$/, "");
                for (let j = 0; j < lisättävätRikokset.length; j++) {
                    let vertailtava = lisättävätRikokset[j].syytekohta.replace(/\.$/, "").replace(/\)$/, "");
                    if (poistettavatKohdat[i] == vertailtava && !lisättävätRikokset[j].onkoLisätty) {
                        poistettavatRikoksetLuettelo.push(j);
                        poistettavaKohtaLöytynyt = true;
                    }
                }
                if (!poistettavaKohtaLöytynyt) {
                    if (poistettavatRikoksetLöytymättömät != "") {
                        poistettavatRikoksetLöytymättömät += ", ";
                    }
                    poistettavatRikoksetLöytymättömät += poistettavatKohdat[i];
                }
            }

            // poistetaan poistettavat syytekohdat, kun niiden indeksit ovat tiedossa
            for (let i = poistettavatRikoksetLuettelo.length - 1; i >= 0; i--) {
                lisättävätRikokset.splice(poistettavatRikoksetLuettelo[i], 1);
            }

            // tämä kohta (tulostusta varten, toistuu hieman alempana) voidaan siirtää muualle niin, että
            // se toteutuisi joka tapauksessa
            uusiTuomio.pvm1 = new Date(pvm1);
            uusiTuomio.pvm2 = new Date(pvm2);
            uusiTuomio.pvm3 = new Date(pvm3);
            uusiTuomio.tuomioistuin1 = tuomioistuin1;
            uusiTuomio.tuomioistuin2 = tuomioistuin2;
            uusiTuomio.tuomioistuin3 = tuomioistuin3;
            uusiTuomio.ratkaisunro1 = ratkaisunro1;
            uusiTuomio.ratkaisunro2 = ratkaisunro2;
            uusiTuomio.ratkaisunro3 = ratkaisunro3;

            if (poistettavatRikoksetLöytymättömät == "") {
                muokkaukset.muutokset.push("Tuomiosta <i>" + uusiTuomio.pitkäNimi() + "</i> on poistettu seuraavat "
                    + "syyksi luetut rikokset: " + muokkaukset.poistettavatRikokset);
            } else {
                muokkaukset.muutokset.push("<b class='varoitus'>Käyttäjä halusi poistaa tuomiosta <i>"
                    + uusiTuomio.pitkäNimi() + "</i>"
                    + " seuraavat syyksi luetut rikokset:&nbsp;" + muokkaukset.poistettavatRikokset + ". "
                    + "Näitä syytekohtia ei kuitenkaan löydetty:&nbsp;" + poistettavatRikoksetLöytymättömät + "</b>");
            }

        }

        // jos käyttäjä haluaa muokata rikosrekisteriotetta muuttamalla ehdollisen/nuorisorangaistuksen ehdottomaksi,
        // tarkistetaan, onko kyse nyt käsiteltävästä tuomiosta, ja jos on, tehdään tarvittavat muutokset
        // (oikeusasteiden muutokset jne.);
        // (huom. osa koodista (pvm-stilisointi) on osin sama kuin ylempänä uuden tuomion lisäämisen yhteydessä)

        if (ehdollinen && muokkaukset.tuomioEhdottomaksi != "" &&
           (ratkaisunro1 == muokkaukset.tuomioEhdottomaksi || ratkaisunro2 == muokkaukset.tuomioEhdottomaksi ||
            ratkaisunro3 == muokkaukset.tuomioEhdottomaksi)) {

            tuomioEhdottomaksiLöytynyt = true;

            if (vianhaku) {
                vianhakuHTML.push("<p><b style='color: red'>Kyseessä on tuomio, jonka käyttäjä on halunnut muuttaa "
                    + "ehdottomaksi. Tarkista varsinaiselta tulosteelta, että tämä on onnistunut.</b></p>\n");
            }

            let virhetilanne = false;

            // ks. vastaavista riveistä kommentti hieman ylempänä
            uusiTuomio.pvm1 = new Date(pvm1);
            uusiTuomio.pvm2 = new Date(pvm2);
            uusiTuomio.pvm3 = new Date(pvm3);
            uusiTuomio.tuomioistuin1 = tuomioistuin1;
            uusiTuomio.tuomioistuin2 = tuomioistuin2;
            uusiTuomio.tuomioistuin3 = tuomioistuin3;
            uusiTuomio.ratkaisunro1 = ratkaisunro1;
            uusiTuomio.ratkaisunro2 = ratkaisunro2;
            uusiTuomio.ratkaisunro3 = ratkaisunro3;

            let muutosteksti = "Tuomio no&nbsp;" + muokkaukset.tuomioEhdottomaksi + " muutetaan ehdottomaksi. "
                + "Tuomio ennen muutosta: <i>" + uusiTuomio.pitkäNimi() + "</i>";

            let stilisoituPvm = "";

            if (muokkaukset.tuomioEhdottomaksiPvm != "") {
                stilisoituPvm = stilisoiKäyttäjänPvm(muokkaukset.tuomioEhdottomaksiPvm);
                if (stilisoituPvm == "") {
                    muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän syöttämää ylemmän asteen "
                        + "antopäivämäärää (" + muokkaukset.uudenTuomionPvm + ") ehdottomaksi muutettavalle "
                        + "ehdolliselle tai nuorisorangaistukselle ei pystytty tulkitsemaan. Ylemmän asteen "
                        + "antopäivämääränä käytetään sen sijaan kuluvaa päivää.</b>");
                }
            }

            if (stilisoituPvm != "" && muunnaStilisoituPvm(stilisoituPvm) < uusiTuomio.viimeinenPvm()) {
                muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän syöttämä ylemmän asteen "
                    + "antopäivämäärä (" + muokkaukset.tuomioEhdottomaksiPvm + ", tulkittu päivämääräksi "
                    + stilisoituPvm + ") ehdottomaksi muutettavalle ehdolliselle tai nuorisorangaistukselle "
                    + "näyttää sijoittuvan ennen kyseisen tuomion viimeisimmän todellisen oikeusasteen "
                    + "antopäivämäärää (" + pvmTekstiksi(uusiTuomio.viimeinenPvm()) + "), mikä ei ole mahdollista. "
                    + "Ylemmän asteen antopäivämääränä käytetään tämän vuoksi kuluvaa päivää.</b>");
                stilisoituPvm = "";
            }

            if (stilisoituPvm == "") {
                let nyt = new Date();
                let pv = nyt.getDate() + "";
                let kk = (nyt.getMonth() + 1) + "";
                let v = nyt.getFullYear();
                stilisoituPvm = pv.padStart(2, "0") + "." + kk.padStart(2, "0") + "." + v;
            }

            if (tuomioistuin2 == "") {

                pvm2 = new Date(pvm1);
                tuomioistuin2 = tuomioistuin1;
                ratkaisunro2 = ratkaisunro1;
                pvm1 = new Date(muunnaStilisoituPvm(stilisoituPvm));
                tuomioistuin1 = tunnistaYlempiAste(tuomioistuin2);
                ratkaisunro1 = "999999";

            } else if (tuomioistuin3 == "") {

                pvm3 = new Date(pvm2);
                tuomioistuin3 = tuomioistuin2;
                ratkaisunro3 = ratkaisunro2;
                pvm2 = new Date(pvm1);
                tuomioistuin2 = tuomioistuin1;
                ratkaisunro2 = ratkaisunro1;
                pvm1 = new Date(muunnaStilisoituPvm(stilisoituPvm));
                tuomioistuin1 = "Korkein oikeus";
                ratkaisunro1 = "999999";

            } else {

                // kolme oikeusastetta jo valmiiksi, ei lainvoimainen, ei pitäisi olla mahdollista
                virhetilanne = true;

            }

            if (!virhetilanne) {

                // konkurrenssin kannalta merkityksellinen oikeusaste on se, josta nyt on kyse
                katkaisevaTuomio = 1;
                uusiTuomio.pvm = new Date(pvm1);

                // ks. vastaavista riveistä kommentti hieman ylempänä
                uusiTuomio.pvm1 = new Date(pvm1);
                uusiTuomio.pvm2 = new Date(pvm2);
                uusiTuomio.pvm3 = new Date(pvm3);
                uusiTuomio.tuomioistuin1 = tuomioistuin1;
                uusiTuomio.tuomioistuin2 = tuomioistuin2;
                uusiTuomio.tuomioistuin3 = tuomioistuin3;
                uusiTuomio.ratkaisunro1 = ratkaisunro1;
                uusiTuomio.ratkaisunro2 = ratkaisunro2;
                uusiTuomio.ratkaisunro3 = ratkaisunro3;

                muutosteksti += ". Tuomio muutoksen jälkeen: <i>" + uusiTuomio.pitkäNimi() + "</i>.";
                if (muokkaukset.tuomioEhdottomaksiPvm == "") {
                    muutosteksti += " Ylemmän oikeusasteen päivämääränä on käytetty kuluvaa päivää, kun "
                        + "käyttäjä ei muuta ilmoittanut.";
                }

                muokkaukset.muutokset.push(muutosteksti);

                huomioonotettava = true;
                ehdollinen = false;
                nuorisorangaistus = false;
                uusiTuomio.rangaistus = uusiTuomio.rangaistus.split(" (ehdollinen)")[0];
                if (uusiTuomio.rangaistus.includes("uorisorang")) {
                    uusiTuomio.rangaistus = "Ehdoton vankeus";
                }

            } else {

                muokkaukset.muutokset.push("<b class='varoitus'>Huom! Tuomiossa, jonka käyttäjä haluaa "
                    + "muuttaa ehdottomaksi ylemmässä asteessa (" + uusiTuomio.pitkäNimi() + ", "
                    + "käyttäjä yksilöinyt ratkaisunumerolla " + muokkaukset.tuomioEhdottomaksi + ") "
                    + "havaittiin jo valmiiksi kolmen oikeusasteen tiedot, vaikka tuomio on lainvoimaa vailla. "
                    + "Muutoksia ei&nbsp;tehty.</b>");

            }

        }

        // jos käyttäjä on lisännyt tuomioon rikoksia, lajitellaan kaikki tuomion rikokset numerojärjestykseen
        // (lisätyt rikokset tulisivat muutoin aina ensimmäisinä; lajittelu on tehtävä siksikin, että
        // konkurrenssilausuntoja luotaessa oletetaan rikosten olevan numerojärjestyksessä);
        // huom. syytekohdat ovat merkkijonoja, joissa voi olla piste tai sulku lopussa, ja lisäksi syytekohta
        // voi olla kaksiosainen (esim. 2.4, siis alkuosa 2 ja loppuosa 4)

        if (tuomionTiedotTunnistettu && lisättävätRikokset.length > 0 && muokkausOnnistui) {

            lisättävätRikokset.sort(function(a, b) {

                // aluksi poistetaan loppuosan pilkut sekä sulkumerkit
                let x = a.syytekohta.replace(/.$/, "").replace(")", "");
                let y = b.syytekohta.replace(/.$/, "").replace(")", "");

                // sitten jaetaan kaikki syytekohdat kahteen osaan
                let xAlkuosa = x.split(".")[0];
                let yAlkuosa = y.split(".")[0];

                let xLoppuosa = 0;
                let yLoppuosa = 0;

                if (x.includes(".")) {
                    xLoppuosa = x.split(".")[1];
                }
                if (y.includes(".")) {
                    yLoppuosa = y.split(".")[1];
                }

                // lajittelu perustuu alkuosien vertailuun, elleivät ne ole samoja, jolloin vertaillaan loppuosia
                if (xAlkuosa != yAlkuosa) {
                    return xAlkuosa - yAlkuosa;
                } else {
                    return xLoppuosa - yLoppuosa;
                }

            });

        }

        // tarkistetaan lisättävien rikosten pvm:t sen varalta, onko rikoksen pvm ennen käsiteltävän tuomion pvm:iä
        // (tämä on mahdollista joissakin harvinaisissa tilanteissa, joissa pvm on tulkinnanvarainen, tai jos käyttäjä
        // on syöttänyt itse uuden tuomion, tai on jokin virhetilanne)

        for (let j = 0; j < lisättävätRikokset.length; j++) {

            // etsitään tuomion oikeusasteiden vanhin pvm, johon verrataan
            let tuomionVanhinPvm = new Date(pvm1);
            if (tuomioistuin2 != "" && pvm2 < tuomionVanhinPvm) {
                tuomionVanhinPvm = new Date(pvm2);
            }
            if (tuomioistuin3 != "" && pvm3 < tuomionVanhinPvm) {
                tuomionVanhinPvm = new Date(pvm3);
            }

            if (lisättävätRikokset[j].pvm > tuomionVanhinPvm) {

                varoitukset.push("Tuomiossa <i>" + uusiTuomio.lyhytNimi() + "</i> olevasta rikoksesta (<i>"
                    + lisättävätRikokset[j].syytekohta + " " + lisättävätRikokset[j].nimike + "</i>) "
                    + "tunnistettu tekoajankohta <i>" + pvmTekstiksi(lisättävätRikokset[j].pvm) + "</i> "
                    + "on vasta tuomion ensimmäisen oikeusasteen antopäivän " + pvmTekstiksi(tuomionVanhinPvm) + " "
                    + "jälkeen &#8211; tekoajaksi korjataan päivämäärä, joka on kuukausi ennen tuomion antamista");

                lisättävätRikokset[j].pvm = new Date(tuomionVanhinPvm);
                lisättävätRikokset[j].pvm.setMonth(lisättävätRikokset[j].pvm.getMonth() - 1);

            }

        }

        // jos tuomion perustiedot (pvm, tuomioistuin ja lainvoimaisuus sekä ratkaisunro) ovat kunnossa,
        // tuomioon liittyy rikoksia ja kyseessä on ehdoton, lisätään tuomio ja siihen kuuluvat rikokset luetteloihin
        // (ellei ole niin, että kyseessä on poistettava ehdoton tuomio, mikä tarkastetaan aluksi)

        if (tuomionTiedotTunnistettu && lisättävätRikokset.length > 0 && huomioonotettava) {

            if (ratkaisunro1 == muokkaukset.poistettavaTuomio || ratkaisunro2 == muokkaukset.poistettavaTuomio ||
                ratkaisunro3 == muokkaukset.poistettavaTuomio) {

                // ks. vastaavista riveistä kommentti hieman ylempänä
                uusiTuomio.pvm1 = new Date(pvm1);
                uusiTuomio.pvm2 = new Date(pvm2);
                uusiTuomio.pvm3 = new Date(pvm3);
                uusiTuomio.tuomioistuin1 = tuomioistuin1;
                uusiTuomio.tuomioistuin2 = tuomioistuin2;
                uusiTuomio.tuomioistuin3 = tuomioistuin3;
                uusiTuomio.ratkaisunro1 = ratkaisunro1;
                uusiTuomio.ratkaisunro2 = ratkaisunro2;
                uusiTuomio.ratkaisunro3 = ratkaisunro3;

                muokkaukset.muutokset.push("Rikosrekisteristä löytynyt tuomio on poistettu: "
                    + uusiTuomio.pitkäNimi());
                poistettavaTuomioLöytynyt = true;

                if (vianhaku) {
                    vianhakuHTML.push("<p><b style='color: red'>Käyttäjä on määrittänyt, että tämä "
                        + "rikosrekisteriotteella oleva tuomio poistetaan.</b></p>\n");
                }

            } else {

                // ennen kuin uusi tuomio lisätään, asetetaan sille kellonaika sen mukaisesti, miten sen halutaan
                // asettuvan tuomioiden lajittelussa aikajärjestykseen (kellonaika vaikuttaa lajitteleTuomiot-funktion
                // mukaiseen lajitteluun, ja konkurrenssiryhmiä määritettäessä samalla päivällä annetuista tuomioista
                // konkurrenssin katkaisevaksi määrittyy ensimmäinen); millisekunnit määräytyvät seuraavasti:
                // - arvo on lähtökohtaisesti 1
                // - arvo on 2, jos kyseessä on riittävä seuraamus -tuomio (ei voi olla konkurrenssin katkaiseva)
                // - arvo on 0, jos kyseessä on tuomio, jonka käyttäjä haluaa konkurrenssin katkaisevaksi

                // ks. vastaavista riveistä kommentti hieman ylempänä
                uusiTuomio.pvm1 = new Date(pvm1);
                uusiTuomio.pvm2 = new Date(pvm2);
                uusiTuomio.pvm3 = new Date(pvm3);
                uusiTuomio.tuomioistuin1 = tuomioistuin1;
                uusiTuomio.tuomioistuin2 = tuomioistuin2;
                uusiTuomio.tuomioistuin3 = tuomioistuin3;
                uusiTuomio.ratkaisunro1 = ratkaisunro1;
                uusiTuomio.ratkaisunro2 = ratkaisunro2;
                uusiTuomio.ratkaisunro3 = ratkaisunro3;

                uusiTuomio.pvm.setHours(12);
                uusiTuomio.pvm.setMinutes(0);
                uusiTuomio.pvm.setSeconds(0);
                uusiTuomio.pvm.setMilliseconds(1);
                if (uusiTuomio.rangaistus.includes("Riittävä")) {
                    uusiTuomio.pvm.setMilliseconds(2);
                }
                if (katkaisevat.indexOf(ratkaisunro1) != -1) {
                    uusiTuomio.pvm.setMilliseconds(0);
                    katkaisevatLöytyneet[katkaisevat.indexOf(ratkaisunro1)] = true;
                    varoitukset.push("Käyttäjän määrittämä tuomio " + uusiTuomio.pitkäNimi() + " on merkitty "
                        + "sellaiseksi, että sillä on etusija konkurrenssin katkaisevana tuomiona, jos samalla "
                        + "päivällä on useampia tuomioita.");
                }
                if (katkaisevat.indexOf(ratkaisunro2) != -1) {
                    uusiTuomio.pvm.setMilliseconds(0);
                    katkaisevatLöytyneet[katkaisevat.indexOf(ratkaisunro2)] = true;
                    varoitukset.push("Käyttäjän määrittämä tuomio " + uusiTuomio.pitkäNimi() + " on merkitty "
                        + "sellaiseksi, että sillä on etusija konkurrenssin katkaisevana tuomiona, jos samalla "
                        + "päivällä on useampia tuomioita.");
                }
                if (katkaisevat.indexOf(ratkaisunro3) != -1) {
                    uusiTuomio.pvm.setMilliseconds(0);
                    katkaisevatLöytyneet[katkaisevat.indexOf(ratkaisunro3)] = true;
                    varoitukset.push("Käyttäjän määrittämä tuomio " + uusiTuomio.pitkäNimi() + " on merkitty "
                        + "sellaiseksi, että sillä on etusija konkurrenssin katkaisevana tuomiona, jos samalla "
                        + "päivällä on useampia tuomioita.");
                }

                // tämän jälkeen lisätään uusi tuomio ja sen rikokset

                ehdottomatTuomiot.push(new Tuomio(new Date(uusiTuomio.pvm.getTime()), uusiTuomio.tuomioistuin,
                    uusiTuomio.ratkaisunro, uusiTuomio.rangaistus, uusiTuomio.lainvoimaisuus, katkaisevaTuomio,
                    pvm1, tuomioistuin1, ratkaisunro1, pvm2, tuomioistuin2, ratkaisunro2, pvm3, tuomioistuin3,
                    ratkaisunro3, uusiTuomio.lainvoimaisuusLisätieto));

                for (let j = 0; j < lisättävätRikokset.length; j++) {
                    if (lisättävätRikokset[j].pitkäTekoaika) {
                        rikosluetteloEhdottomat.push(new Rikos(new Date(lisättävätRikokset[j].pvm.getTime()),
                            lisättävätRikokset[j].syytekohta, lisättävätRikokset[j].nimike, tuomiolaskuriEhdottomat,
                            null, true, new Date(lisättävätRikokset[j].alkupvm.getTime()),
                            lisättävätRikokset[j].pvmTeksti, lisättävätRikokset[j].pvmEpäselvä));
                        ehdottomatTuomiot[tuomiolaskuriEhdottomat].rikokset.push(rikosluetteloEhdottomat.length - 1);
                    } else {
                        rikosluetteloEhdottomat.push(new Rikos(new Date(lisättävätRikokset[j].pvm.getTime()),
                            lisättävätRikokset[j].syytekohta, lisättävätRikokset[j].nimike, tuomiolaskuriEhdottomat,
                            null, false, null, lisättävätRikokset[j].pvmTeksti, lisättävätRikokset[j].pvmEpäselvä));
                        ehdottomatTuomiot[tuomiolaskuriEhdottomat].rikokset.push(rikosluetteloEhdottomat.length - 1);
                    }
                }

                tuomiolaskuriEhdottomat++;

            }

        }

        // samanlainen toimenpide tehdään myös, jos kyseessä on ehdollinen tuomio

        if (tuomionTiedotTunnistettu && lisättävätRikokset.length > 0 && ehdollinen) {

            ehdollisetTuomiot.push(new Tuomio(new Date(uusiTuomio.pvm.getTime()), uusiTuomio.tuomioistuin,
                uusiTuomio.ratkaisunro, uusiTuomio.rangaistus, uusiTuomio.lainvoimaisuus, katkaisevaTuomio,
                pvm1, tuomioistuin1, ratkaisunro1, pvm2, tuomioistuin2, ratkaisunro2,
                pvm3, tuomioistuin3, ratkaisunro3, uusiTuomio.lainvoimaisuusLisätieto));

            for (let j = 0; j < lisättävätRikokset.length; j++) {
                if (lisättävätRikokset[j].pitkäTekoaika) {
                    rikosluetteloEhdolliset.push(new Rikos(new Date(lisättävätRikokset[j].pvm.getTime()),
                        lisättävätRikokset[j].syytekohta, lisättävätRikokset[j].nimike, tuomiolaskuriEhdolliset,
                        null, true, new Date(lisättävätRikokset[j].alkupvm.getTime()), lisättävätRikokset[j].pvmTeksti,
                        lisättävätRikokset[j].pvmEpäselvä));
                    ehdollisetTuomiot[tuomiolaskuriEhdolliset].rikokset.push(rikosluetteloEhdolliset.length - 1);
                } else {
                    rikosluetteloEhdolliset.push(new Rikos(new Date(lisättävätRikokset[j].pvm.getTime()),
                        lisättävätRikokset[j].syytekohta, lisättävätRikokset[j].nimike, tuomiolaskuriEhdolliset,
                        null, false, null, lisättävätRikokset[j].pvmTeksti, lisättävätRikokset[j].pvmEpäselvä));
                    ehdollisetTuomiot[tuomiolaskuriEhdolliset].rikokset.push(rikosluetteloEhdolliset.length - 1);
                }
            }

            tuomiolaskuriEhdolliset++;

            // vasta tässä vaiheessa, kun on varmistunut, että kyseessä on tuomioluetteloon lisättävä nuorisorangaistus
            // (eikä esim. sellaisen muunto), annetaan asiasta varoitus (koska nuorisorangaistuksen merkitys voi olla
            // tulkinnanvarainen

            if (nuorisorangaistus) {
                varoitukset.push("Ote sisältää nuorisorangaistuksen &#8211; tarkista rangaistuksen merkitys "
                    + "(konkurrenssikone olettaa, että nuorisorangaistus ei katkaise konkurrenssia): "
                    + "<i>" + uusiTuomio.lyhytNimi() + "</i>");
            }

        }

        // jos käyttäjä haluaa lisätä syyksiluettuja rikoksia tiettyyn tuomioon, ja tämä on kyseinen tuomio,
        // tässä vaiheessa luodaan ilmoitus sitä koskien (lisäys on tehty jo aiemmin, mutta nyt tiedetään tuomion
        // nimi kokonaisuudessaan niin, että se voidaan tulostaa pitkäNimi()-metodilla)

        if (onMuokattavaTuomio && muokkausOnnistui) {
            muokkaukset.muutokset.push("Tuomioon <i>" + uusiTuomio.lyhytNimi() + "</i> on lisätty rikoksia.");
        }
        if (onMuokattavaTuomio && !muokkausOnnistui) {
            muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän ilmoittamien uusien rikosten lisääminen "
                + "tuomioon " + uusiTuomio.lyhytNimi() + " ei onnistunut. Tarkista, että rikosrekisteriote on suoraan "
                + "järjestelmästä otettu &#8221;puhdas&#8221; ote (ei skannattu eikä tekstitunnistettu).</b>");
        }

        // ulkomaisia tuomioita voi olla rikosrekisterissä ilman ratkaisunumeroa, joten seuraavassa
        // ei tarkisteta ehdolla "if (tuomionTiedotTunnistettu)" vaan tätä suppeammalla, eli riittää, että
        // tuomiosta on tunnistettu pvm ja tuomioistuin (ks. tuomionTiedotTunnistettu-testi ylempänä)

        if (uusiTuomio.pvm != 0 && uusiTuomio.tuomioistuin != "") {
            if (lisättävätRikokset.length == 0 && !sivuutettava) {
                varoitukset.push("Tuomiosta ei pystytty tunnistamaan rikoksia &#8211; "
                    + "tuomio sivuutetaan: <i>" + uusiTuomio.lyhytNimi() + "</i>");
            } else {
                if (!huomioonotettava && !ehdollinen && !sivuutettava) {
                    varoitukset.push("Tuomion lajia (ehdollinen/ehdoton) ei pystytty tunnistamaan &#8211; "
                        + "tuomio sivuutetaan: <i>" + uusiTuomio.lyhytNimi() + "</i>");
                }
            }
        }

        // nollataan muuttujat, joita käytetään useamman tuomion tietojen väliaikaiseen tallettamiseen

        pvm1 = new Date();
        pvm2 = new Date();
        pvm3 = new Date();
        tuomioistuin1 = "";
        tuomioistuin2 = "";
        tuomioistuin3 = "";
        ratkaisunro1 = null;
        ratkaisunro2 = null;
        ratkaisunro3 = null;
        katkaisevaTuomio = 1;

    }

    if (muokkaukset.poistettavaTuomio > 0 && !poistettavaTuomioLöytynyt) {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän ilmoittamaa poistettavaa "
            + "tuomiota no&nbsp;" + muokkaukset.poistettavaTuomio + " ei löydetty "
            + "rikosrekisteriotteen tiedoista!</b>");
    }

    if (muokkaukset.poistettavatRikoksetTuomio != "" && !poistettavatRikoksetTuomioLöytynyt) {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän ilmoittamaa tuomiota no&nbsp;"
            + muokkaukset.poistettavatRikoksetTuomio + ", josta halutaan poistaa rikoksia, ei löydetty "
            + "rikosrekisteriotteen tiedoista!</b>");
    }

    if (muokkaukset.muokattavaTuomio != "" && !muokattavaTuomioLöytynyt) {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän ilmoittamaa tuomiota no&nbsp;"
            + muokkaukset.muokattavaTuomio + ", johon halutaan lisätä rikoksia, ei löydetty "
            + "rikosrekisteriotteen tiedoista!</b>");
    }

    if (muokkaukset.tuomioEhdottomaksi != "" && !tuomioEhdottomaksiLöytynyt) {
        muokkaukset.muutokset.push("<b class='varoitus'>Huom! Käyttäjän ilmoittamaa ehdollista "
            + "tai nuorisorangaistusta no&nbsp;" + muokkaukset.tuomioEhdottomaksi + ", joka halutaan muuttaa "
            + "ehdottomaksi, ei löydetty rikosrekisteriotteen tiedoista!</b>");
    }

    for (let i = 0; i < katkaisevat.length; i++) {
        if (!katkaisevatLöytyneet[i]) {
            varoitukset.push("Käyttäjän määrittämää tuomiota no " + katkaisevat[i] + ", jonka halutaan olevan "
                + "konkurrenssin katkaiseva, ei löydetty rikosrekisteriotteelta.")
        }
    }

    if (vianhaku) {
        vianhakuHTML.push("<hr>\n");
        vianhakuHTML.push("<p><b>Rikosrekisterin luenta valmis.</b></p>\n");
        vianhakuHTML.push("<p>Ehdottomia tuomioita tallennettu " + ehdottomatTuomiot.length + "&nbsp;kpl, ");
        vianhakuHTML.push("niissä rikoksia " + rikosluetteloEhdottomat.length + "&nbsp;kpl;<br>");
        vianhakuHTML.push("ehdollisia (tai vast.) tallennettu " + ehdollisetTuomiot.length + "&nbsp;kpl, ");
        vianhakuHTML.push("niissä rikoksia " + rikosluetteloEhdolliset.length + "&nbsp;kpl.<br>");
        vianhakuHTML.push("Tuomioita tallennettu yhteensä " + (ehdottomatTuomiot.length + ehdollisetTuomiot.length)
            + "&nbsp;kpl, rikoksia yhteensä " + (rikosluetteloEhdottomat.length + rikosluetteloEhdolliset.length)
            + "&nbsp;kpl.</p>\n");
        vianhakuHTML.push("</body>\n\n</html>\n");
        if (kyselytiedot[1] != "") {
            let täydennys = "<p><b>Rikosrekisteriotteen ajankohta:</b><br>" + kyselytiedot[1];
            if (kyselytiedot[0] != "") {
                täydennys += " (" + kyselytiedot[0] + ")";
            }
            täydennys += "</p>\n";
            vianhakuHTML[vianhakuAjankohtaIndeksi] = täydennys;
        }
    }

    if (tiivistys) {
        tiivisteet.rikosrekisteriote = tiiviste(rikrekTiivisteelle);
    }

    console.log("Pdf-muotoisen rikosrekisterin luenta valmis. Tilastot:");
    console.log("- ehdottomia tuomioita löydetty: " + ehdottomatTuomiot.length);
    console.log("- ehdottomista löydetty rikoksia: " + rikosluetteloEhdottomat.length);
    console.log("- ehdollisia tuomioita löydetty: " + ehdollisetTuomiot.length);
    console.log("- ehdollisista löydetty rikoksia: " + rikosluetteloEhdolliset.length + ".");

    // tunnistaYlempiAste:
    // funktio, joka palauttaa ylemmän oikeusasteen nimen sen perusteella, mikä on alempi oikeusaste
    // (tarkoitettu niihin tilanteisiin, joissa ehdollinen tuomio muutetaan ylemmässä asteessa ehdottomaksi
    // käyttäjän valinnan mukaan)

    function tunnistaYlempiAste(alempiAste) {

        if (alempiAste.includes("hovioikeus")) {
            return "Korkein oikeus";
        }

        const hovioikeudet = ["Helsingin hovioikeus", "Itä-Suomen hovioikeus", "Rovaniemen hovioikeus",
            "Turun hovioikeus", "Vaasan hovioikeus"];
        const alioikeudet = [["Helsingin käräjäoikeus", "Itä-Uudenmaan käräjäoikeus", "Länsi-Uudenmaan käräjäoikeus"],
            ["Etelä-Karjalan käräjäoikeus", "Etelä-Savon käräjäoikeus", "Kymenlaakson käräjäoikeus",
            "Pohjois-Karjalan käräjäoikeus", "Pohjois-Savon käräjäoikeus", "Päijät-Hämeen käräjäoikeus"],
            ["Kainuun käräjäoikeus", "Lapin käräjäoikeus", "Oulun käräjäoikeus"],
            ["Ahvenanmaan käräjäoikeus", "Kanta-Hämeen käräjäoikeus", "Pirkanmaan käräjäoikeus",
            "Varsinais-Suomen käräjäoikeus"],
            ["Etelä-Pohjanmaan käräjäoikeus", "Keski-Suomen käräjäoikeus", "Pohjanmaan käräjäoikeus",
            "Satakunnan käräjäoikeus"]];

        for (let i = 0; i < alioikeudet.length; i++) {
            for (let j = 0; j < alioikeudet[i].length; j++) {
                if (alempiAste.includes(alioikeudet[i][j])) {
                    return hovioikeudet[i];
                }
            }
        }

        if (alempiAste.includes("käräjäoikeus")) {
            return "Hovioikeus";
        }

        return "Ylempi oikeusaste";

    }

    // muunnaTLrikokset:
    // funktio, joka muuttaa Ritun tai Aipan tuomiolauselmalta kopioidut rikosten tiedot rikosrekisteriotteen
    // tietoja vastaavaan muotoon (jos käännös == true, kyseessä Ritu-tuomiolauselma, jossa rivit ovat väärin päin)

    function muunnaTLrikokset(syöte, käännös) {

        // jaetaan syöte riveiksi
        let muunnettuRivit = syöte.split("\n");

        // käännetään se tarvittaessa ympäri
        if (käännös) {
            muunnettuRivit.reverse();
        }

        let muunnettu = "";

        // käydään rivit läpi:
        // - poistetaan välilyönnit alusta ja lopusta
        // - sivuutetaan kaikki tyhjät rivit sekä pykälämerkin sisältävät rivit (joissa on ilmoitettu lainkohtia)
        // - otetaan mukaan sellaiset rivit, jotka alkavat syytekohtanumerolla ja välilyönnillä, sekä sellaiset rivit,
        //   joissa on päivämäärä (näiden perään tulee lisäksi tyhjä rivi)
        for (let i = 0; i < muunnettuRivit.length; i++) {
            muunnettuRivit[i] = muunnettuRivit[i].trim();
            if (muunnettuRivit[i].includes("§") || muunnettuRivit[i] == "") {
                continue;
            }
            if (/^\d+\.\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(muunnettuRivit[i]) ||
                /^\d+\.\d+\.\s([A-Za-z]|Å|Ä|Ö|å|ä|ö)/.test(muunnettuRivit[i])) {
                muunnettu += muunnettuRivit[i] + "\n";
            } else if (/([0-9]{2}).([0-9]{2}).([0-9]{4})/.test(muunnettuRivit[i]) ||
                /([0-9]).([0-9]{2}).([0-9]{4})/.test(muunnettuRivit[i]) ||
                /([0-9]{2}).([0-9]).([0-9]{4})/.test(muunnettuRivit[i]) ||
                /([0-9]).([0-9]).([0-9]{4})/.test(muunnettuRivit[i])) {
                muunnettu += muunnettuRivit[i] + "\n\n";
            }
        }
        return muunnettu;

    }

    // korjaaVäliviivat:
    // funktio, joka yhdenmukaistaa syötteen päivämäärien välissä olevat väliviivat
    // (viivojen pitää olla tavallisia yhdysmerkkejä ilman välilyöntejä niiden ympärillä)

    function korjaaVäliviivat(syöte) {

        // toimii samansuuntaisesti kuin muunnaTLrikokset edellä, eli jaetaan riveiksi ja muutetaan vain
        // päivämäärärivejä (huom. eri väliviivavaihtoehdot, jotka muunnetaan tavallisiksi yhdysmerkeiksi,
        // esiintyvät alla UTF-8-muodossa, eli kyse on eri väliviivoista, vaikka ne näyttävätkin samoille)

        let korjattuRivit = syöte.split("\n");

        let korjattu = "";

        for (let i = 0; i < korjattuRivit.length; i++) {

            if (/([0-9]{2}).([0-9]{2}).([0-9]{4})/.test(korjattuRivit[i]) ||
                /([0-9]).([0-9]{2}).([0-9]{4})/.test(korjattuRivit[i]) ||
                /([0-9]{2}).([0-9]).([0-9]{4})/.test(korjattuRivit[i]) ||
                /([0-9]).([0-9]).([0-9]{4})/.test(korjattuRivit[i])) {

                korjattuRivit[i] = korjattuRivit[i].replaceAll("–", "-").replaceAll("—", "-").replaceAll(" - ", "-");

            }

            korjattu += korjattuRivit[i] + "\n";

        }

        return korjattu;

    }

    // stilisoiKäyttäjänPvm:
    // funktio, joka tulkitsee/stilisoi käyttäjän lomakkeeseen syöttämän päivämäärämuotoisen merkkijonon (p.k.vv)
    // ja palauttaa merkkijonon sellaisessa muodossa, joka vastaa oikeassa rikosrekisteriotteessa olevaa (pp.kk.vvvv);
    // jos tulkinta ei onnistu, palautetaan tyhjä merkkijono (kaksinumeroisista vuosiluvuista hyväksytään 01...99)

    function stilisoiKäyttäjänPvm(pvm) {
        let osat = pvm.split(".");
        if (osat.length != 3 ||
            osat[0] < 1 || osat[0] > 31 ||
            osat[1] < 1 || osat[1] > 12 ||
            osat[2] < 1 || osat[2] > 2099 ||
           (osat[2] > 99 && osat[2] < 1950)) {
            return "";
        }
        if (osat[2] < 100) {
            osat[2] = "20" + osat[2].padStart(2, "0");
        }
        return osat[0].padStart(2, "0") +  "." + osat[1].padStart(2, "0") + "." + osat[2];
    }

    // muunnaStilisoituPvm:
    // funktio, joka muuntaa muodossa pp.kk.vvvv olevan (stilisoiKäyttäjänPvm-funktion tuottaman ja rikosrekisterissä
    // käytetyn) päivämäärän Date-muotoiseksi

    function muunnaStilisoituPvm(pvm) {
        return new Date(Number(pvm.slice(6, 10)), (Number(pvm.slice(3, 5)) - 1), Number(pvm.slice(0, 2)));
    }

    // tulkitseTekoaika:
    // funktio, joka pyrkii tulkitsemaan vapaamuotoisen tekoajan (esim. "elokuu 2009")

    function tulkitseTekoaika(teksti, vuosiluku) {

        // huom. seuraavissa kuukausi on yksi todellista vähemmän (Date-objektin sääntöjen mukaisesti),
        // eli esim. "15", "6" tarkoittaa 15. heinäkuuta
        let ajanjaksot =
            [["tammikuu", "15", "0"],
            ["helmikuu", "15", "1"],
            ["maaliskuu", "15", "2"],
            ["huhtikuu", "15", "3"],
            ["toukokuu", "15", "4"],
            ["kesäkuu", "15", "5"],
            ["heinäkuu", "15", "6"],
            ["elokuu", "15", "7"],
            ["syyskuu", "15", "8"],
            ["lokakuu", "15", "9"],
            ["marraskuu", "15", "1"],
            ["joulukuu",  "15", "11"],
            ["syystalv", "30", "10"],
            ["syyskesä", "1", "8"],
            ["kevätkesä", "31", "4"],
            ["kevättalv", "1", "2"],
            ["alkuvuo", "1", "0"],
            ["loppuvuo", "31", "11"],
            ["alkukesä", "1", "5"],
            ["loppukesä", "31", "7"],
            ["alkutalv", "1", "11"],
            ["lopputalv", "28", "1"],
            ["alkusyksy", "1", "8"],
            ["loppusyksy", "30", "10"],
            ["alkukevä", "1", "2"],
            ["loppukevä", "31", "4"],
            ["keskikesä", "15", "6"],
            ["kesä", "15", "6"],
            ["talv", "15", "0"],
            ["syksy", "15", "9"],
            ["kevä", "15", "3"],
            ["joulu", "25", "11"],
            ["juhannu", "25", "5"]];

        ajanjaksot.push(["vuoden " + vuosiluku + " alku", 1, 0]);
        ajanjaksot.push(["vuoden " + vuosiluku + " alus", 1, 0]);
        ajanjaksot.push(["vuoden " + vuosiluku + " loppu", 31, 11]);
        ajanjaksot.push(["vuoden " + vuosiluku + " lopus", 31, 11]);

        let pv = null;
        let kk = null;

        // otetaan tekstin sisältö vain mahdollisesta viimeisestä väliviivasta tai ja-sanasta oikealle
        // (koska jos on esim. "joulukuu 2009 - tammikuu 2010" tai "5. ja 6.4.2011 välinen yö",
        // niin vain loppuosa ratkaisee)
        teksti = teksti.split("-").pop();
        teksti = teksti.split(" ja ").pop();
        teksti = teksti.trim();

        // tekstissä viimeisenä esiintyvän ajanjakson sijainti merkkijonossa
        let ajanjaksonSijainti = -1;

        // tekstistä löydetyn ajanjakson indeksi ajanjaksot-taulukossa
        let ajanjaksonIndeksi = -1;

        // tarkistetaan ajanjaksojen löytyminen tekstistä niin, että valituksi tulee viimeisenä sijaitseva
        for (let i = 0; i < ajanjaksot.length; i++) {

            // kriteerinä siis, onko ajanjakson sijainti pidemmällä kuin tähänastisista pisimmällä oleva
            if (teksti.lastIndexOf(ajanjaksot[i][0]) > ajanjaksonSijainti) {

                // lisäkriteerinä on, että nyt löytynyt ei saa sisältyä jo löytyneeseen, jotta esim. "kesä" on
                // toissijainen osumaan "syyskesä" nähden (edellä ajanjaksot-taulukossa "kesä" ym. ovat lopussa,
                // jotta "syyskesä" löytyy ensin)
                if (ajanjaksonIndeksi == -1 || !ajanjaksot[ajanjaksonIndeksi][0].includes(ajanjaksot[i][0])) {
                    ajanjaksonSijainti = teksti.lastIndexOf(ajanjaksot[i][0]);
                    ajanjaksonIndeksi = i;
                }

            }

        }

        // jos tekstistä on löytynyt ajanjakso, tulkinta on onnistunut (jos ei, pv ja kk jäävät arvoksi null)
        if (ajanjaksonIndeksi > -1) {

            // tallennetaan pv- ja kk-muuttujiin tiedot ajanjaksot-taulukosta
            pv = ajanjaksot[ajanjaksonIndeksi][1];
            kk = ajanjaksot[ajanjaksonIndeksi][2];

            // tarkistetaan kuukausien osalta, löytyykö rajaava lisämääre ("alussa", "alku", "loppupuolella" jne.)
            if (ajanjaksonIndeksi < 12) {

                // rajataan teksti ajanjakson alkukohdasta eteenpäin
                let loppuosa = teksti.substring(ajanjaksonSijainti);

                if (loppuosa.includes("alku") || loppuosa.includes("alu") || loppuosa.includes("vaihde") ||
                    loppuosa.includes("vaihtee") || loppuosa.includes("taite") || loppuosa.includes("taittee")) {
                    pv = 1;
                }

                if (loppuosa.includes("loppu") || loppuosa.includes("lopu")) {
                    // kuun viimeinen päivä (Date-objekti huolehtii laskemisesta)
                    kk++;
                    pv = 0;
                }

                if (loppuosa.includes("puoliväl") || loppuosa.includes("idus") || loppuosa.includes("iduk")) {
                    pv = 15;
                }

            }

        }

        if (teksti.includes)

        return [pv, kk];

    }

}

// ********************************************************************************************************************
// luoEsimerkkiRikosrekisteriote:
// funktio, joka luo esimerkkirikosrekisterin tuomiot ja rikokset
// (ehdottomien ja ehdollisten luomiseksi funktiota on kutsuttava kahdesti)
// ********************************************************************************************************************

function luoEsimerkkiRikosrekisteriote(tuomiot, rikosluettelo, tuomionPvm, tuomioidenMäärä, rikoksiaEnintään,
    tuomioidenVäliMax, rikostenVäliMax, mhTodennäköisyys, mhVäliMax, lainvoimaistenMäärä) {

    console.log("Esimerkkirikosrekisterin luonti alkaa");

    const mhVäliMin = 99;                           // muutoksenhaun vähimmäiskesto
    const mhVäli = mhVäliMax - mhVäliMin;           // muutoksenhaun väli
    const kkoTodennäköisyys = 0.005;                // KKO:n ratkaisun todennäköisyys
    const hoviKatkaiseeTodennäköisyys = 0.006;      // todennäköisyys sille, että vasta HO:n tuomio on katkaiseva
    const alioikeusHylännytTodennäköisyys = 0.008;  // todennäköisyys sille, että vasta HO:n tuomio näkyy rekisterissä

    // ratkaisunumeron ja rangaistuksen pituuden välit
    const tlpRatkaisunroMin = 1;
    const tlpRatkaisunroMaxLisäys = 1500;
    const rituRatkaisunroMin = 110000;
    const rituRatkaisunroMaxLisäys = 9999;
    const aipaRatkaisunroMin = 10200000;
    const aipaRatkaisunroMaxLisäys = 140000;
    const rangaistuksenPituusMin = 1;
    const rangaistuksenPituusMaxLisäys = 16;
    const rikoksestaTuomioonMin = 30;
    const rikoksestaTuomioonMaxLisäys = 200;

    const nyt = new Date();

    // luettelo rikosnimikkeistä
    const rikosnimikkeet = ["Törkeä varkaus", "Varkaus", "Varkaus", "Varkaus", "Avunanto törkeään pahoinpitelyyn",
        "Pahoinpitely", "Pahoinpitely", "Pahoinpitely", "Törkeä huumausainerikos", "Huumausainerikos",
        "Huumausainerikos", "Törkeä vahingonteko", "Vahingonteko", "Vahingonteko", "Petos", "Petos", "Petos",
        "Petoksen yritys", "Virkamiehen väkivaltainen vastustaminen", "Kotirauhan rikkominen"];

    // seuraaviin taulukkoihin lisätään tiedot eri ajanjaksojen hovioikeuksista ja alioikeuksista
    let ajanjaksot = [];    // taulukko, jossa on ajanjaksojen alkupäivämäärät
    let hovioikeudet = [];  // taulukko, jossa on merkkijonoina luettelo hovioikeuksista
    let hoviKertoimet = []; // taulukko, jossa on hovioikeuksien arvontatodennäköisyyksien painokertoimet
    let hoviSummat = [];    // taulukko, jossa on painokerrointen summat
    let alioikeudet = [];   // taulukko, jossa on taulukko kutakin hovioikeutta kohden ja siinä merkkijonoina
                            // luettelo kyseisen hovioikeuspiirin alioikeuksista

    // asetus 288/1952
    ajanjaksot.push(new Date(1952, 9, 1));
    hovioikeudet.push(["Turun hovioikeus", "Vaasan hovioikeus", "Itä-Suomen hovioikeus", "Helsingin hovioikeus"]);
    hoviKertoimet.push([2, 1, 3, 6]);
    alioikeudet.push([["Ahvenanmaan tuomiokunta", "Euran tuomiokunta", "Halikon tuomiokunta", "Hauhon tuomiokunta",
        "Hollolan tuomiokunta", "Ikaalisten tuomiokunta", "Janakkalan tuomiokunta", "Jämsän tuomiokunta",
        "Loimaan tuomiokunta", "Paraisten tuomiokunta", "Piikkiön tuomiokunta", "Pirkkalan tuomiokunta",
        "Ruoveden tuomiokunta", "Tammelan tuomiokunta", "Toijalan tuomiokunta", "Tyrvään tuomiokunta",
        "Ulvilan tuomiokunta", "Vehmaan tuomiokunta", "Hämeenlinnan raastuvanoikeus", "Lahden raastuvanoikeus",
        "Maarianhaminan raastuvanoikeus", "Naantalin raastuvanoikeus", "Porin raastuvanoikeus",
        "Rauman raastuvanoikeus", "Tampereen raastuvanoikeus", "Turun raastuvanoikeus",
        "Uudenkaupungin raastuvanoikeus"],
        ["Alavuden tuomiokunta", "Iin tuomiokunta", "Ilmajoen tuomiokunta", "Kauhajoen tuomiokunta",
        "Kemijärven tuomiokunta", "Kokkolan tuomiokunta", "Korsholman tuomiokunta", "Lapin tuomiokunta",
        "Lapuan tuomiokunta", "Närpiön tuomiokunta", "Oulun tuomiokunta", "Piippolan tuomiokunta",
        "Rovaniemen tuomiokunta", "Salon tuomiokunta", "Tornion tuomiokunta", "Uudenkaarlepyyn tuomiokunta",
        "Kaskisten raastuvanoikeus", "Kemin raastuvanoikeus", "Kokkolan raastuvanoikeus",
        "Kristiinankaupungin raastuvanoikeus", "Oulun raastuvanoikeus", "Pietarsaaren raastuvanoikeus",
        "Raahen raastuvanoikeus", "Tornion raastuvanoikeus", "Uudenkaarlepyyn raastuvanoikeus",
        "Vaasan raastuvanoikeus"],
        ["Heinolan tuomiokunta", "Iisalmen tuomiokunta", "Ilomantsin tuomiokunta", "Imatran tuomiokunta",
        "Juvan tuomiokunta", "Jyväskylän tuomiokunta", "Kajaanin tuomiokunta", "Kerimäen tuomiokunta",
        "Kiteen tuomiokunta", "Kuopion tuomiokunta", "Kymin tuomiokunta", "Lappeen tuomiokunta",
        "Leppävirran tuomiokunta", "Liperin tuomiokunta", "Mikkelin tuomiokunta", "Mäntyharjun tuomiokunta",
        "Nilsiän tuomiokunta", "Pielaveden tuomiokunta", "Pielisjärven tuomiokunta", "Rantasalmen tuomiokunta",
        "Rautalammin tuomiokunta", "Saarijärven tuomiokunta", "Valkealan tuomiokunta", "Viitasaaren tuomiokunta",
        "Haminan raastuvanoikeus", "Heinolan raastuvanoikeus", "Iisalmen raastuvanoikeus", "Joensuun raastuvanoikeus",
        "Jyväskylän raastuvanoikeus", "Kajaanin raastuvanoikeus", "Kotkan raastuvanoikeus", "Kuopion raastuvanoikeus",
        "Lappeenrannan raastuvanoikeus", "Mikkelin raastuvanoikeus", "Savonlinnan raastuvanoikeus"],
        ["Helsingin tuomiokunta", "Iitin tuomiokunta", "Lohjan tuomiokunta", "Mäntsälän tuomiokunta",
        "Porvoon tuomiokunta", "Raaseporin tuomiokunta", "Tuusulan tuomiokunta", "Hangon raastuvanoikeus",
        "Helsingin raastuvanoikeus", "Loviisan raastuvanoikeus", "Porvoon raastuvanoikeus",
        "Tammisaaren raastuvanoikeus"]]);

    // asetus 121/1957
    lisääAjanjakso(new Date(1957, 6, 1));
    muokkaaTuomioistuimia("Turun", ["Kokemäen tuomiokunta"], []);
    muokkaaTuomioistuimia("Vaasan", ["Haapajärven tuomiokunta", "Jyväskylän tuomiokunta", "Kauhavan tuomiokunta",
        "Kyrön tuomiokunta", "Lohtajan tuomiokunta", "Muhoksen tuomiokunta", "Pietarsaaren tuomiokunta",
        "Saarijärven tuomiokunta", "Saloisten tuomiokunta", "Taivalkosken tuomiokunta", "Jyväskylän raastuvanoikeus"],
        ["Kokkolan tuomiokunta", "Piippolan", "Salon", "Uudenkaarlepyyn tuomiokunta"]);
    muokkaaTuomioistuimia("Itä-Suomen", [], ["Jyväskylän", "Saarijärven"]);

    // asetus 383/1973, voimaantulopäivää ei mainita asetuksessa (tässä oletetaan voimaantulopäiväksi 1.6.1973)
    lisääAjanjakso(new Date(1973, 5, 1));
    muokkaaTuomioistuimia("Vaasan", ["Kuusamon tuomiokunta", "Ylivieskan tuomiokunta"], ["Saloisten", "Taivalkosken"]);
    muokkaaTuomioistuimia("Itä-Suomen", ["Pieksämäen tuomiokunta", "Suonenjoen tuomiokunta", "Varkauden tuomiokunta"],
        ["Kerimäen", "Leppävirran", "Rautalammin"]);
    muokkaaTuomioistuimia("Helsingin hovioikeus", ["Espoon tuomiokunta", "Hyvinkään tuomiokunta",
        "Orimattilan tuomiokunta", "Vantaan tuomiokunta"], ["Helsingin tuomiokunta", "Mäntsälän"]);

    // asetus 803/1974
    lisääAjanjakso(new Date(1975, 0, 1));
    muokkaaTuomioistuimia("Itä-Suomen", ["Iitin tuomiokunta"], ["Mäntyharjun"]);
    muokkaaTuomioistuimia("Helsingin", [], ["Iitin tuomiokunta"]);

    // asetus 539/1977, Kouvolan HO ym.
    lisääAjanjakso(new Date(1978, 4, 1));
    muokkaaTuomioistuimia("Turun", [], ["Hauhon", "Hollolan", "Janakkalan", "Hämeenlinnan", "Lahden"]);
    muokkaaTuomioistuimia("Itä-Suomen", [], ["Heinolan", "Iitin", "Imatran", "Kymin", "Lappeen", "Valkealan",
        "Haminan", "Heinolan", "Kotkan", "Lappeenrannan"]);
    muokkaaTuomioistuimia("Helsingin", [], ["Orimattilan"]);
    hovioikeudet[hovioikeudet.length - 1].push("Kouvolan hovioikeus");
    hoviKertoimet[hoviKertoimet.length - 1].push(3);
    alioikeudet[alioikeudet.length - 1].push(["Hauhon tuomiokunta", "Heinolan tuomiokunta", "Hollolan tuomiokunta",
        "Iitin tuomiokunta", "Imatran tuomiokunta", "Janakkalan tuomiokunta", "Kymin tuomiokunta",
        "Lappeen tuomiokunta", "Orimattilan tuomiokunta", "Valkealan tuomiokunta", "Haminan raastuvanoikeus",
        "Heinolan raastuvanoikeus", "Hämeenlinnan raastuvanoikeus", "Kotkan raastuvanoikeus", "Lahden raastuvanoikeus",
        "Lappeenrannan raastuvanoikeus"]);

    // asetus 859/1978, Rovaniemen HO ym.
    lisääAjanjakso(new Date(1979, 4, 1));
    muokkaaTuomioistuimia("Turun", [], ["Jämsän tuomiokunta"]);
    muokkaaTuomioistuimia("Vaasan", ["Jämsän tuomiokunta", "Viitasaaren tuomiokunta"], ["Iin", "Kemijärven",
        "Kuusamon", "Lapin", "Rovaniemen", "Tornion", "Kemin"]);
    muokkaaTuomioistuimia("Itä-Suomen", [], ["Viitasaaren tuomiokunta"]);
    hovioikeudet[hovioikeudet.length - 1].push("Rovaniemen hovioikeus");
    hoviKertoimet[hoviKertoimet.length - 1].push(2);
    alioikeudet[alioikeudet.length - 1].push(["Iin tuomiokunta", "Kemijärven tuomiokunta", "Kuusamon tuomiokunta",
        "Lapin tuomiokunta", "Rovaniemen tuomiokunta", "Tornion tuomiokunta", "Kemin raastuvanoikeus",
        "Tornion raastuvanoikeus"]);

    // asetus 717/1980
    lisääAjanjakso(new Date(1981, 0, 1));
    muokkaaTuomioistuimia("Vaasan", [], ["Muhoksen", "Oulun"]);
    muokkaaTuomioistuimia("Helsingin", [], ["Tammisaaren"]);
    muokkaaTuomioistuimia("Rovaniemen", ["Muhoksen tuomiokunta", "Oulun tuomiokunta", "Oulun raastuvanoikeus"], []);

    // asetus 241/1982, voimaan 1.4.1982 paitsi Vaasan HO-piiriä koskevan 2 kohdan osalta 1.10.1982
    lisääAjanjakso(new Date(1982, 3, 1));
    muokkaaTuomioistuimia("Turun", ["Hauhon tuomiokunta", "Hämeenlinnan raastuvanoikeus"],
        ["Maarianhaminan"]);
    muokkaaTuomioistuimia("Kouvolan", [], ["Hauhon", "Hämeenlinnan raastuvanoikeus"]);

    // asetus 241/1982, voimaan 1.10.1982 myös em. 2 kohdan osalta
    lisääAjanjakso(new Date(1982, 9, 1));
    muokkaaTuomioistuimia("Vaasan", [], ["Kaskisten", "Kristiinankaupungin", "Uudenkaarlepyyn"]);

    // asetus 668/1984
    lisääAjanjakso(new Date(1984, 9, 1));
    muokkaaTuomioistuimia("Helsingin", ["Loviisan tuomiokunta"], ["Loviisan"]);

    // asetus 438/1985
    lisääAjanjakso(new Date(1985, 9, 1));
    muokkaaTuomioistuimia("Kouvolan", [], ["Heinolan raastuvanoikeus"]);

    // asetus 889/1988
    lisääAjanjakso(new Date(1988, 10, 1));
    muokkaaTuomioistuimia("Helsingin", [], ["Loviisan"]);
    muokkaaTuomioistuimia("Rovaniemen", [], ["Tornion raastuvanoikeus"]);

    // asetus 488/1989
    lisääAjanjakso(new Date(1989, 5, 1));
    muokkaaTuomioistuimia("Rovaniemen", ["Oulujoen tuomiokunta"], ["Iin", "Oulun tuomiokunta"]);

    // asetus 927/1993, alioikeusuudistus 1.12.1993 (1.5.1994 lukien päätöksessä 298/1994)
    ajanjaksot.push(new Date(1993, 11, 1));
    hovioikeudet.push(["Turun hovioikeus", "Vaasan hovioikeus", "Itä-Suomen hovioikeus", "Helsingin hovioikeus",
        "Kouvolan hovioikeus", "Rovaniemen hovioikeus"]);
    hoviKertoimet.push([2, 1, 2, 6, 2, 1]);
    alioikeudet.push([["Ahvenanmaan käräjäoikeus", "Forssan käräjäoikeus", "Hämeenlinnan käräjäoikeus",
        "Ikaalisten käräjäoikeus", "Kokemäen käräjäoikeus", "Loimaan käräjäoikeus", "Mynämäen käräjäoikeus",
        "Paraisten käräjäoikeus", "Pirkanmaan käräjäoikeus", "Porin käräjäoikeus", "Rauman käräjäoikeus",
        "Salon käräjäoikeus", "Tampereen käräjäoikeus", "Toijalan käräjäoikeus", "Turun käräjäoikeus",
        "Turunseudun käräjäoikeus", "Vammalan käräjäoikeus"],
        ["Alavuden käräjäoikeus", "Haapajärven käräjäoikeus", "Jyväskylän käräjäoikeus", "Jämsän käräjäoikeus",
        "Kauhajoen käräjäoikeus", "Kauhavan käräjäoikeus", "Kokkolan käräjäoikeus", "Kyrönmaan käräjäoikeus",
        "Lapuan käräjäoikeus", "Mustasaaren käräjäoikeus", "Pietarsaaren käräjäoikeus", "Raahen käräjäoikeus",
        "Saarijärven käräjäoikeus", "Seinäjoen käräjäoikeus", "Vaasan käräjäoikeus", "Ylivieskan käräjäoikeus",
        "Äänekosken käräjäoikeus"],
        ["Iisalmen käräjäoikeus", "Joensuun käräjäoikeus", "Juvan käräjäoikeus", "Kajaanin käräjäoikeus",
        "Kuopion käräjäoikeus", "Mikkelin käräjäoikeus", "Nilsiän käräjäoikeus", "Nurmeksen käräjäoikeus",
        "Pieksämäen käräjäoikeus", "Savonlinnan käräjäoikeus", "Varkauden käräjäoikeus"],
        ["Espoon käräjäoikeus", "Helsingin käräjäoikeus", "Hyvinkään käräjäoikeus", "Lohjan käräjäoikeus",
        "Loviisan käräjäoikeus", "Porvoon käräjäoikeus", "Raaseporin käräjäoikeus", "Tuusulan käräjäoikeus",
        "Vantaan käräjäoikeus"],
        ["Heinolan käräjäoikeus", "Iitin käräjäoikeus", "Imatran käräjäoikeus", "Kotkan käräjäoikeus",
        "Kouvolan käräjäoikeus", "Lahden käräjäoikeus", "Lappeenrannan käräjäoikeus", "Orimattilan käräjäoikeus",
        "Riihimäen käräjäoikeus"],
        ["Kemin käräjäoikeus", "Kemijärven käräjäoikeus", "Kuusamon käräjäoikeus", "Lapin käräjäoikeus",
        "Oulun käräjäoikeus", "Rovaniemen käräjäoikeus", "Tornion käräjäoikeus"]]);

    // päätös 976/2004
    lisääAjanjakso(new Date(2005, 0, 1));
    muokkaaTuomioistuimia("Turun", ["Lohjan käräjäoikeus", "Raaseporin käräjäoikeus", "Vakka-Suomen käräjäoikeus"],
        ["Mynämäen", "Pirkanmaan", "Porin", "Vammalan"]);
    muokkaaTuomioistuimia("Vaasan", ["Porin käräjäoikeus"], ["Alavuden", "Haapajärven", "Lapuan", "Pietarsaaren",
        "Raahen", "Saarijärven", "Ylivieskan"]);
    muokkaaTuomioistuimia("Itä-Suomen", [], ["Juvan"]);
    muokkaaTuomioistuimia("Helsingin", [], ["Hyvinkään", "Lohjan", "Raaseporin"]);
    muokkaaTuomioistuimia("Kouvolan", ["Hyvinkään käräjäoikeus"], ["Iitin"]);
    muokkaaTuomioistuimia("Rovaniemen", ["Haapajärven käräjäoikeus", "Kemi-Tornion käräjäoikeus",
        "Raahen käräjäoikeus", "Ylivieskan käräjäoikeus"], ["Kemin", "Tornion"]);

    // asetus 180/2009
    ajanjaksot.push(new Date(2010, 0, 1));
    hovioikeudet.push(["Turun hovioikeus", "Vaasan hovioikeus", "Itä-Suomen hovioikeus", "Helsingin hovioikeus",
        "Kouvolan hovioikeus", "Rovaniemen hovioikeus"]);
    hoviKertoimet.push([2, 1, 2, 6, 2, 1]);
    alioikeudet.push([["Ahvenanmaan käräjäoikeus", "Kanta-Hämeen käräjäoikeus", "Länsi-Uudenmaan käräjäoikeus",
        "Pirkanmaan käräjäoikeus", "Varsinais-Suomen käräjäoikeus"],
        ["Etelä-Pohjanmaan käräjäoikeus", "Keski-Pohjanmaan käräjäoikeus", "Keski-Suomen käräjäoikeus",
        "Pohjanmaan käräjäoikeus", "Satakunnan käräjäoikeus"],
        ["Etelä-Savon käräjäoikeus", "Kainuun käräjäoikeus", "Pohjois-Karjalan käräjäoikeus",
        "Pohjois-Savon käräjäoikeus"],
        ["Espoon käräjäoikeus", "Helsingin käräjäoikeus", "Itä-Uudenmaan käräjäoikeus", "Tuusulan käräjäoikeus",
        "Vantaan käräjäoikeus"],
        ["Etelä-Karjalan käräjäoikeus", "Hyvinkään käräjäoikeus", "Kymenlaakson käräjäoikeus",
        "Päijät-Hämeen käräjäoikeus"],
        ["Kemi-Tornion käräjäoikeus", "Lapin käräjäoikeus", "Oulun käräjäoikeus", "Ylivieska-Raahen käräjäoikeus"]]);

    // asetus 337/2013 (1.1.2017 lukien asetuksessa 864/2016)
    lisääAjanjakso(new Date(2014, 3, 1));
    muokkaaTuomioistuimia("Itä-Suomen", ["Etelä-Karjalan käräjäoikeus", "Kymenlaakson käräjäoikeus",
        "Päijät-Hämeen käräjäoikeus"], ["Kainuun"]);
    muokkaaTuomioistuimia("Helsingin", ["Hyvinkään käräjäoikeus"], []);
    muokkaaTuomioistuimia("Rovaniemen", ["Kainuun käräjäoikeus"], []);
    poistaHovioikeus("Kouvolan hovioikeus");

    // asetus 1025/2017
    lisääAjanjakso(new Date(2019, 0, 1));
    muokkaaTuomioistuimia("Helsingin", ["Länsi-Uudenmaan käräjäoikeus"], ["Espoon", "Hyvinkään", "Tuusulan",
        "Vantaan"]);
    muokkaaTuomioistuimia("Rovaniemen", [], ["Kemi-Tornion", "Ylivieska-Raahen"]);
    muokkaaTuomioistuimia("Turun", [], ["Länsi-Uudenmaan"]);
    muokkaaTuomioistuimia("Vaasan", [], ["Keski-Pohjanmaan"]);

    // käännetään taulukot lopuksi päinvastaiseen järjestykseen (uusin ensin) myöhempää käyttöä varten
    ajanjaksot.reverse();
    hovioikeudet.reverse();
    hoviKertoimet.reverse();
    alioikeudet.reverse();

    // lasketaan hovioikeuksien painokerrointen summat
    for (let i = 0; i < hoviKertoimet.length; i++) {
        let summa = 0;
        for (let j = 0; j < hoviKertoimet[i].length; j++) {
            summa += hoviKertoimet[i][j];
        }
        hoviSummat.push(summa);
    }

    // lisätään tuomiot

    for (let i = 0; i < tuomioidenMäärä; i++) {

        // alioikeuden ja hovioikeuden indeksit ao. taulukoissa
        let alioikeudenNro = 0;
        let hovioikeudenNro = 0;

        // eri oikeusasteiden tuomioiden tiedot
        let alioikeusPvm, hovioikeusPvm, kkoPvm;
        let alioikeus, hovioikeus;
        let alioikeusRatkaisunro, hovioikeusRatkaisunro, kkoRatkaisunro;
        let lainvoimaisuus, rangaistus;
        let rangaistuksenPituus;

        // vähennetään tuomionPvm-argumenttia satunnaisella määrällä päiviä
        tuomionPvm.setDate(tuomionPvm.getDate() - Math.trunc((Math.random() * tuomioidenVäliMax) + 1));

        // jos kyseessä on vapaapäivä, siirrytään päivä kerrallaan taaksepäin, kunnes löydetään arkipäivä
        while (onVapaapäivä(tuomionPvm)) {
            tuomionPvm.setDate(tuomionPvm.getDate() - 1);
        }

        // määritetään päivämäärät kolmen oikeusasteen tuomioille em. päivästä lähtien

        alioikeusPvm = new Date(tuomionPvm.getTime());

        hovioikeusPvm = new Date(alioikeusPvm.getTime());
        hovioikeusPvm.setDate(hovioikeusPvm.getDate() + mhVäliMin + Math.trunc(Math.random() * mhVäli));
        while (onVapaapäivä(hovioikeusPvm)) {
            hovioikeusPvm.setDate(hovioikeusPvm.getDate() + 1);
        }

        kkoPvm = new Date(hovioikeusPvm.getTime());
        kkoPvm.setDate(kkoPvm.getDate() + mhVäliMin + Math.trunc(Math.random() * mhVäli));
        while (onVapaapäivä(kkoPvm)) {
            kkoPvm.setDate(kkoPvm.getDate() + 1);
        }

        // etsitään, mille ajanjaksolle alioikeuden tuomio sijoittuu

        let jaksonNro = 0;
        while (jaksonNro < ajanjaksot.length - 1 && ajanjaksot[jaksonNro] > alioikeusPvm) {
            jaksonNro++;
        }

        // arvotaan ensin hovioikeus hovioikeudet-taulukosta painotetuilla todennäköisyyksillä

        let tavoite = Math.random() * hoviSummat[jaksonNro];
        let summa = 0;
        for (hovioikeudenNro = 0; hovioikeudenNro < hoviKertoimet[jaksonNro].length; hovioikeudenNro++) {
            summa += hoviKertoimet[jaksonNro][hovioikeudenNro];
            if (summa > tavoite) {
                break;
            }
        }
        hovioikeus = hovioikeudet[jaksonNro][hovioikeudenNro];

        // arvotaan sen jälkeen alioikeus alioikeudet-taulukosta

        alioikeudenNro = Math.trunc(Math.random() * alioikeudet[jaksonNro][hovioikeudenNro].length);
        alioikeus = alioikeudet[jaksonNro][hovioikeudenNro][alioikeudenNro];

        // otetaan erityistapauksena huomioon Kouvolan HO:n lakkauttaminen 1.4.2014 lukien
        if (hovioikeus == "Kouvolan hovioikeus" && hovioikeusPvm >= new Date(2014, 3, 1)) {
            if (alioikeus == "Hyvinkään käräjäoikeus") {
                hovioikeus = "Helsingin hovioikeus";
            } else {
                hovioikeus = "Itä-Suomen hovioikeus";
            }
        }

        // alioikeuden ja HO:n ratkaisunumero on erilainen TLP-aikana (n. 2012 asti), Ritu-aikana (n. 2013 - 2024)
        // ja Aipa-aikana (n. 2025 alkaen)
        if (alioikeusPvm.getFullYear() >= 2025) {
            alioikeusRatkaisunro = aipaRatkaisunroMin + Math.trunc(Math.random() * aipaRatkaisunroMaxLisäys);
            hovioikeusRatkaisunro = aipaRatkaisunroMin + Math.trunc(Math.random() * aipaRatkaisunroMaxLisäys);
        } else if (alioikeusPvm.getFullYear() >= 2013) {
            alioikeusRatkaisunro = rituRatkaisunroMin + Math.trunc(Math.random() * rituRatkaisunroMaxLisäys);
            hovioikeusRatkaisunro = rituRatkaisunroMin + Math.trunc(Math.random() * rituRatkaisunroMaxLisäys);
        } else {
            alioikeusRatkaisunro = tlpRatkaisunroMin + Math.trunc(Math.random() * tlpRatkaisunroMaxLisäys);
            hovioikeusRatkaisunro = tlpRatkaisunroMin + Math.trunc(Math.random() * tlpRatkaisunroMaxLisäys);
        }

        // KKO:n ratkaisunumero on Ritu-aikana samanlainen kuin TLP-aikana mutta Aipa-aikana erilainen
        if (kkoPvm.getFullYear() >= 2025) {
            kkoRatkaisunro = aipaRatkaisunroMin + Math.trunc(Math.random() * aipaRatkaisunroMaxLisäys);
        } else {
            kkoRatkaisunro = tlpRatkaisunroMin + Math.trunc(Math.random() * tlpRatkaisunroMaxLisäys);
        }

        // luodaan merkkijono, joka sisältää rangaistuksen pituuden
        rangaistuksenPituus = rangaistuksenPituusMin + Math.trunc(Math.random() * rangaistuksenPituusMaxLisäys);
        if (rangaistuksenPituus < 12) {
            rangaistus = rangaistuksenPituus + " kk vankeutta";
        } else {
            rangaistus = "1 v " + (rangaistuksenPituus - 12) + " kk vankeutta";
        }
        if (rangaistuksenPituus == 12) {
            rangaistus = "1 v vankeutta";
        }

        lainvoimaisuus = true;

        if (i < lainvoimaistenMäärä) {
            lainvoimaisuus = false;
        }

        // otetaan huomioon muutoksenhaku asetuksista määritetyn todennäköisyyden mukaisesti
        if (Math.random() < mhTodennäköisyys) {
            // hovioikeuden tuomio lisätään vain, jos se on kuluvaa päivää aiempi
            // (muussa tapauksessa merkitään tuomio lainvoimaa vailla olevaksi; jos näin ei tehtäisi, tuomio voisi olla
            // lainvoimainen ilman muutoksenhakua, vaikka muutoksenhaun todennäköisyydeksi olisi määritetty 100 %)
            if (hovioikeusPvm < nyt) {
                // tarvittaessa lisätään myös KKO:n tuomio rikosrekisteriin
                if (Math.random() < kkoTodennäköisyys && kkoPvm < nyt) {
                    tuomiot.push(new Tuomio(new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro,
                        rangaistus, lainvoimaisuus, 3, new Date(kkoPvm.getTime()), "Korkein oikeus", kkoRatkaisunro,
                        new Date(hovioikeusPvm.getTime()), hovioikeus, hovioikeusRatkaisunro,
                        new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro));
                } else {
                    tuomiot.push(new Tuomio(new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro,
                        rangaistus, lainvoimaisuus, 2, new Date(hovioikeusPvm.getTime()), hovioikeus,
                        hovioikeusRatkaisunro, new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro, 0,
                        "", 0));
                }
            } else {
                lainvoimaisuus = false;
                tuomiot.push(new Tuomio(new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro, rangaistus,
                    lainvoimaisuus, 1, new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro, 0, "", 0, 0,
                    "", 0));
            }
        } else {
            tuomiot.push(new Tuomio(new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro, rangaistus,
                lainvoimaisuus, 1, new Date(alioikeusPvm.getTime()), alioikeus, alioikeusRatkaisunro, 0, "", 0, 0, "",
                0));
        }

        // määritetään vasta hovioikeuden tuomio katkaisevaksi tietyn todennäköisyyden mukaisesti
        if (Math.random() < hoviKatkaiseeTodennäköisyys && tuomiot[tuomiot.length - 1].tuomioistuin2 != "") {
            if (tuomiot[tuomiot.length - 1].tuomioistuin3 != "") {
                tuomiot[tuomiot.length - 1].katkaisevaTuomio = 2;
            } else {
                tuomiot[tuomiot.length - 1].katkaisevaTuomio = 1;
            }
        }

        // poistetaan alioikeuden tuomio (syytteet hylätty) tietyn todennäköisyyden mukaisesti
        if (Math.random() < alioikeusHylännytTodennäköisyys && tuomiot[tuomiot.length - 1].tuomioistuin2 != "") {

            if (tuomiot[tuomiot.length - 1].tuomioistuin3 != "") {

                tuomiot[tuomiot.length - 1].pvm3 = 0;
                tuomiot[tuomiot.length - 1].tuomioistuin3 = "";
                tuomiot[tuomiot.length - 1].ratkaisunro3 = 0;

                tuomiot[tuomiot.length - 1].katkaisevaTuomio = 2;

                tuomiot[tuomiot.length - 1].pvm = tuomiot[tuomiot.length - 1].pvm2;
                tuomiot[tuomiot.length - 1].tuomioistuin = tuomiot[tuomiot.length - 1].tuomioistuin2;
                tuomiot[tuomiot.length - 1].ratkaisunro = tuomiot[tuomiot.length - 1].ratkaisunro2;

            } else {

                tuomiot[tuomiot.length - 1].pvm2 = 0;
                tuomiot[tuomiot.length - 1].tuomioistuin2 = "";
                tuomiot[tuomiot.length - 1].ratkaisunro2 = 0;

                tuomiot[tuomiot.length - 1].katkaisevaTuomio = 1;

                tuomiot[tuomiot.length - 1].pvm = tuomiot[tuomiot.length - 1].pvm1;
                tuomiot[tuomiot.length - 1].tuomioistuin = tuomiot[tuomiot.length - 1].tuomioistuin1;
                tuomiot[tuomiot.length - 1].ratkaisunro = tuomiot[tuomiot.length - 1].ratkaisunro1;

            }

        }

        // lisätään em. tuomioon satunnainen määrä rikoksia

        let rikostenMääräTuomiossa = 1 + Math.trunc(Math.random() * rikoksiaEnintään);
        let syytekohta = 0;

        for(let j = 0; j < rikostenMääräTuomiossa; j++) {

            // valitaan satunnainen rikosnimike luettelosta
            let rikosnimike = rikosnimikkeet[Math.trunc(Math.random() * (rikosnimikkeet.length))];

            // lisätään syytekohtanumeroa satunnaisesti
            syytekohta++;
            if (Math.random() < 0.2) {
                syytekohta++;
            }
            if (Math.random() < 0.1) {
                syytekohta++;
            }
            if (Math.random() < 0.05) {
                syytekohta++;
            }

            // lisätään uusi rikos rikosluettelo-taulukkoon
            rikosluettelo.push(new Rikos(new Date(0), syytekohta + ".", rikosnimike, i, null, false, null, "", false));

            // lisätään myös sen numero tuomiot-taulukkoon
            tuomiot[i].rikokset.push(rikosluettelo.length - 1);

         }

        // määritetään näille rikoksille tekopäivät

        // aloitetaan rikosten laskeminen tuomion päivämäärästä taaksepäin
        let rikoksenPvm = new Date(tuomionPvm.getTime());
        rikoksenPvm.setDate(rikoksenPvm.getDate() - rikoksestaTuomioonMin
            - Math.trunc(Math.random() * rikoksestaTuomioonMaxLisäys));

        for(let j = 0; j < rikostenMääräTuomiossa; j++) {

            // vähennetään päivämäärälaskuria satunnaisella pvm-määrällä, joka voi olla myös 0
            rikoksenPvm.setDate(rikoksenPvm.getDate() - Math.trunc(Math.random() * rikostenVäliMax));

            // asetetaan ko. päivä rikoksentekopäivämääräksi
            rikosluettelo[rikosluettelo.length - 1 - j].pvm = new Date(rikoksenPvm.getTime());

        }

    }

    console.log("Esimerkkirikosrekisterin luonti valmis");

    return tuomionPvm;

    // lisääAjanjakso:
    // funktio, joka lisää tuomioistuintietokantaan uuden ajanjakson, jonka sisältö on sama kuin edellisessä

    function lisääAjanjakso(pvm) {
        ajanjaksot.push(pvm);
        hovioikeudet.push([...hovioikeudet[hovioikeudet.length - 1]]);          // "yhden tason" taulukko
        hoviKertoimet.push([...hoviKertoimet[hoviKertoimet.length - 1]]);       // "yhden tason" taulukko
        alioikeudet.push(structuredClone(alioikeudet[alioikeudet.length - 1])); // sisältää sisäkkäisiä taulukoita
    }

    // muokkaaTuomioistuimia:
    // funktio, joka lisää ja poistaa viimeisimmästä tuomioistuinten tietokannan ajanjaksosta alioikeuksia tietyn
    // hovioikeuden kohdalta; argumentit ovat hovioikeuden nimi (nimen osa), lisättävien alioikeuksien taulukko ja
    // poistettavien taulukko; poistaminen tehdään ennen lisäämistä, jotta juuri lisättyjä tietoja ei poistettaisi;
    // sekä hovioikeuden nimestä että poistettavasta alioikeudesta riittää nimen osa, jolloin samalla kertaa voi
    // poistaa useita alioikeuksia (esim. "Loviisa" poistaa sekä "Loviisan tuomiokunta"- että "Loviisan
    // raastuvanoikeus" -nimiset)

    function muokkaaTuomioistuimia(hovioikeus, lisättävätAlioikeudet, poistettavatAlioikeudet) {

        // viimeisimmän ajanjakson indeksi
        let viimeisin = hovioikeudet.length - 1;

        // etsitään oikea hovioikeus kyseisestä ajanjaksosta
        for (let i = 0; i < hovioikeudet[viimeisin].length; i++) {

            if (hovioikeudet[viimeisin][i].includes(hovioikeus)) {

                // käydään läpi kyseisen hovioikeuden alioikeudet
                for (let j = alioikeudet[viimeisin][i].length - 1; j >= 0; j--) {

                    // käydään läpi poistettavien luettelo ja poistetaan alioikeus, jos nimen osa täsmää
                    for (let k = 0; k < poistettavatAlioikeudet.length; k++) {
                        if (alioikeudet[viimeisin][i][j].includes(poistettavatAlioikeudet[k])) {
                            alioikeudet[viimeisin][i].splice(j, 1);
                            break;
                        }
                    }

                }

                // lisätään alioikeudet
                alioikeudet[viimeisin][i].push(...lisättävätAlioikeudet);

            }

        }

    }

    // poistaHovioikeus:
    // funktio, joka poistaa hovioikeuden tuomioistuinten tietokannan viimeisimmästä ajanjaksosta

    function poistaHovioikeus(hovioikeus) {
        let viimeisin = hovioikeudet.length - 1;
        let poistettavanIndeksi = hovioikeudet[viimeisin].indexOf(hovioikeus);
        hovioikeudet[viimeisin].splice(poistettavanIndeksi, 1);
        hoviKertoimet[viimeisin].splice(poistettavanIndeksi, 1);
        alioikeudet[viimeisin].splice(poistettavanIndeksi, 1);
    }

    // onVapaapäivä:
    // funktio, joka tarkistaa, onko tietty päivä vapaapäivä (jolloin päivä ei kelpaa tuomion antamispäiväksi)

    function onVapaapäivä(pvm) {

        // onko kyseessä viikonloppu

        if (pvm.getDay() == 0 || pvm.getDay() == 6) {
            return true;
        }

        let v = pvm.getFullYear();
        let kk = pvm.getMonth();
        let pv = pvm.getDate();

        // onko kyseessä uudenvuodenpäivä, loppiainen, vappu, itsenäisyyspäivä, jouluaatto, joulupäivä tai tapaninpäivä
        // (muodossa pv, kk; kuukaudesta on vähennetty Date-oliota varten 1)

        const vapaapäivät = [[1, 0], [6, 0], [1, 4], [6, 11], [24, 11], [25, 11], [26, 11]];

        for (let i = 0; i < vapaapäivät.length; i++) {
            if (pv == vapaapäivät[i][0] && kk == vapaapäivät[i][1]) {
                return true;
            }
        }

        // onko kyseessä jokin liikkuvista pyhäpäivistä eli pitkäperjantai, toinen pääsiäispäivä ja helatorstai;
        // ne lasketaan suhteessa pääsiäissunnuntaihin, joka on seuraavassa n:nnen kuukauden p:s päivä, lähtötietona
        // vuosi v (ns. Butcherin algoritmi, lähteenä Wikipedia; kuukaudesta vähennetään Date-oliota varten 1)

        let a = v % 19;
        let b = Math.trunc(v / 100);
        let c = v % 100;
        let d = Math.trunc(b / 4);
        let e = b % 4;
        let f = Math.trunc((b + 8) / 25);
        let g = Math.trunc((b - f + 1) / 3);
        let h = (19 * a + b - d - g + 15) % 30;
        let i = Math.trunc(c / 4);
        let k = c % 4;
        let l = (32 + 2 * e + 2 * i - h - k) % 7;
        let m = Math.trunc((a + 11 * h + 22 * l) / 451);
        let n = Math.trunc((h + l - 7 * m + 114) / 31) - 1;
        let p = (h + l - 7 * m + 114) % 31 + 1;

        let pitkäperjantai = new Date(v, n, p - 2);
        let toinenPääsiäispäivä = new Date(v, n, p + 1);
        let helatorstai = new Date(v, n, p + 39);

        if (pvm.toDateString() == pitkäperjantai.toDateString() ||
            pvm.toDateString() == toinenPääsiäispäivä.toDateString() ||
            pvm.toDateString() == helatorstai.toDateString()) {
            return true;
        }

        return false;

    }

}

// ********************************************************************************************************************
// tiiviste:
// funktio, joka palauttaa 6-merkkisen heksamuotoisen tiivisteen
// ********************************************************************************************************************

function tiiviste(merkkijono) {
    let tiiviste = 0;
    for (let i = 0; i < merkkijono.length; i++) {
        tiiviste = Math.imul(31, tiiviste) + merkkijono.charCodeAt(i) | 0;
    }
    return(tiiviste.toString(16).slice(-6));
}

    </script>

    <style>

body {
  margin: auto;
  padding: 10px;
  font-size: 12pt;
  font-family: system-ui, Calibri, Helvetica, Arial, sans-serif;
  font-weight: normal;
  hyphens: auto;
}

hr {
  color: black;
  background: black;
  height: 1px;
  border: 1px solid black;
}

textarea {
  padding: 7px;
  border-radius: 5px; background: #fbfbfb;
  font-size: 10pt;
  font-family: ui-monospace, Menlo, Consolas, monospace;
  font-weight: normal;
  hyphens: none;
}

button {
  font-size: 12pt;
  font-family: system-ui, Calibri, Helvetica, Arial, sans-serif;
  font-weight: normal;
  background: #ddd;
  border: 1px solid #888;
  margin: 2px;
  padding: 7px 12px 7px 12px;
  border-radius: 8px;
  color: black;
  transition: 0.3s;
}

button:active {
  transform: scale(0.95);
}

button:hover {
  cursor: pointer;
  box-shadow: 5px 5px 5px #ddd;
}

button.b {
  font-weight: bold; border: 2px solid #888;
}

select {
  appearance: none;
  padding: 10px;
}

h1 {
  font-size: 20pt;
  text-align: center;
}

h2 {
  font-size: 18pt;
  text-align: center;
}

h3 {
  font-size: 14pt;
  text-align: center;
}

div.osio {
  text-align: center;
  margin-bottom: 25px;
}

#käyttöehto-osio, #tuomioistuinkäyttö {
  display: none;
}

#jsVaroitus {
  color: red;
}

#esittelyAsetukset {
  background: #eee; padding: 25px; border-radius: 20px;
}

#asetukset table, #versiohistoria table, #esittelyAsetukset table {
  margin: 20px auto 20px auto;
}

#lähdekoodikenttä, #tiivisteetkenttä {
  margin-top: 0.5em;
  display: none;
}

#esittelyAsetukset p {
  width: 66%;
  margin: auto;
  text-align: center;
}

#esittelyAsetukset td.painike {
  padding-bottom: 20px; text-align: center;
}

#esittelyAsetukset, #käyttöohjeet, #tärkeääTietoa, #asetukset, #versiohistoria, #muokkaaTuomiota, #käyttöehdot {
  display: none;
  margin: 20px auto 20px auto;
  background: #f5f5f5;
  padding: 15px 25px 15px 25px;
  border-radius: 20px;
  width: 75%;
  opacity: 0;
  transition: opacity 0.7s;
}

#muokkaaTuomiota {
  text-align: center;
}

#käyttöehtoNuoliYlös, #muokkausNuoliYlös {
  display: none;
}

#versiohistoria th, td {
  vertical-align: top;
  padding: 3px 5px 3px 5px;
}

#versiohistoria th {
  text-align: left;
  border-bottom: 3px double #999;
}

#versiohistoria td {
  border-top: 1px double #999;
  padding: 3px 5px 3px 5px;
}

#max {
  display: none;
  color: red;
  font-weight: bold;
}

span.huomautus {
  color: red;
}

div#käyttöehdotPiilotettu {
  display: none;
}

summary {
  margin: 20px auto 20px auto;
}

summary:hover {
  cursor: pointer;
}

details ul {
  text-align: left;
}

textarea#uudenTuomionPvm {
  width: auto;
}

div.vasen textarea {
  width: 80%;
}

ul {
  list-style-type: none;
  padding-left: 1em;
}

li:before {
  content: '–';
  position: absolute;
  margin-left: -1em;
}

ol li:before {
  content: '';
}

li {
  margin-bottom: 1em;
}

li ol {
  margin-top: 1em;
}

li ul {
  margin-top: 1em;
}

td ul, td li {
  margin-top: 0;
  margin-bottom: 0;
}

dt {
  font-weight: bold;
}

dd {
  padding-bottom: 0.5em;
}

table {
  border-collapse: collapse;
}

td {
  margin: 0;
  padding: 0;
}

td.lukema {
  width: 4em;
  text-align: right;
  padding-right: 1em;
}

td.liukusäädin {
  width: 300px;
}

td.liukusäädin input {
  width: 100%;
  height: 10px;
  padding: 0;
}

#asetukset th {
  padding: 1em 0 0.3em 0;
  border-bottom: 1px solid #999;
}

#asetukset td {
  padding: 0.1em;
}

abbr {
  font-variant: small-caps;
}

    </style>

  </head>

  <body>

    <h1>Konkurrenssikone 2.0</h1>

    <div class="osio">HON Juha Terho 29.1.2025</div>

    <div class="osio" id="jsVaroitus">
      <b>Konkurrenssikonetta käynnistettäessä tapahtui virhe.</b>
    </div>

    <div class="osio" id="tuomioistuinkäyttö">
      <span style="color: red">Vain tuomioistuimen sisäiseen käyttöön. Muu käyttö kielletty.<br>Julkinen versio on ladattavissa <a href="https://github.com/konkurrenssikone" target="_blank">GitHub-palvelusta</a>.</span>
    </div>

    <form id="lomake" onsubmit="analysoiRikosrekisteriote(this)">

      <div class="osio">
        <textarea id="rikrek" name="rikrek" autofocus cols="60" rows="10" maxlength="200000" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Kopioi tähän pdf-muotoisen rikosrekisteriotteen tekstisisältö kokonaisuudessaan (suoraan järjestelmästä otettuna; skannattua tai tekstitunnistettua pdf-otetta ei saa käyttää)"></textarea><br>
        <button type="button" class="b" onclick="analysoiRikosrekisteriote(this.form)">Analysoi rikosrekisteriote</button>
        <button type="button" onclick="analysoiRikosrekisteriote(this.form, false, true)">Lataa tuloste</button><br>
      </div>

      <div class="osio">
        <button type="button" id="käyttöohjeetPainike" onclick="näytäTaiPiilota('käyttöohjeet', ['tärkeääTietoa', 'versiohistoria', 'asetukset', 'esittelyAsetukset'])">Käyttöohjeet</button>
        <button type="button" id="tärkeääTietoaPainike" onclick="näytäTaiPiilota('tärkeääTietoa', ['käyttöohjeet', 'versiohistoria', 'asetukset', 'esittelyAsetukset'])">Tärkeää&nbsp;tietoa</button>
        <button type="button" id="asetuksetPainike" onclick="näytäTaiPiilota('asetukset', ['käyttöohjeet', 'tärkeääTietoa', 'versiohistoria', 'esittelyAsetukset'])">Asetukset</button><br>
        <button type="button" id="versiohistoriaPainike" onclick="näytäTaiPiilota('versiohistoria', ['käyttöohjeet', 'tärkeääTietoa', 'asetukset', 'esittelyAsetukset'])">Versiohistoria</button>
        <button type="button" id="esittelyAsetuksetPainike" onclick="näytäTaiPiilota('esittelyAsetukset', ['käyttöohjeet', 'tärkeääTietoa', 'asetukset', 'versiohistoria'])">Esittelytoiminto</button>
      </div>

      <div id="käyttöohjeet">
        <h2>Käyttöohjeet</h2>
        <ul>
          <li>Kopioi <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen koko sisältö yllä olevaan tekstikenttään ja valitse sitten <i>Analysoi rikosrekisteriote</i>.</li>
          <li>Kun kopioit rikosrekisteriotetta, valitse kaikki teksti yhdellä kertaa niin, että painat <abbr>pdf</abbr>-sovelluksessa <i>Ctrl&#8209;A</i> (Valitse kaikki). Älä siis &#8221;maalaa&#8221; tekstiä hiirellä, sillä tällöin kopioinnissa voi tapahtua virheitä ja konkurrenssikoneen tulokset voivat olla virheellisiä.</li>
          <li>Ote ei missään tapauksessa saa olla paperitulosteesta skannattu tai tekstitunnistettu. Käytä vain suoraan järjestelmästä otettuja <abbr>pdf</abbr>-muotoisia otteita. Skannatut tai tekstitunnistetut otteet tuottavat virheellisiä tuloksia.</li>
          <li>Jos etukäteen tallennetun <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen kopiointi ei onnistu lainkaan, syy on todennäköisesti se, että alkuperäinen ote on tallennettu tulostamalla se uudeksi <abbr>pdf</abbr>-tiedostoksi sen sijaan, että se olisi tallennettu sellaisenaan eli käyttämällä <abbr>pdf</abbr>-sovelluksen tallennustoimintoa. Tulostamalla tallennettua tiedostoa ei voi korjata, vaan järjestelmästä on otettava uusi rikosrekisteriote.</li>
          <li>Tyhjennä leikepöytä varmuuden vuoksi heti konkurrenssikoneen käytön jälkeen kopioimalla esim. jokin yksittäinen sana (<i>Ctrl&#8209;C</i>), jotta rikosrekisteriotteen salassa pidettävä sisältö ei jää leikepöydälle. Konkurrenssikoneen asetuksista voi myös kytkeä päälle toiminnon, joka tyhjentää leikepöydän automaattisesti konkurrenssikonetta käytettäessä, jos selain sen sallii.</li>
          <li>Konkurrenssikoneen tuloste avautuu selaimessa uuteen ikkunaan tai uudelle välilehdelle. Vaihtoehtoisesti tulosteen voi ladata erillisenä tiedostona valitsemalla <i>Lataa tuloste</i>. Tuloste tallentuu tällöin selaimen latauskansioon <abbr>html</abbr>-muodossa. Muista poistaa tuloste latauskansiosta, kun sitä ei enää tarvita.</li>
        </ul>
      </div>

      <div id="tärkeääTietoa">
        <h2>Tärkeää tietoa</h2>
        <p>Konkurrenssikone määrittää rikoslain 7&nbsp;luvun 6&nbsp;§:n soveltamiseen liittyvät ns. konkurrenssiryhmät rikosrekisteriotteen tietojen perusteella noudattaen ennakkopäätöksistä KKO&nbsp;1972&nbsp;II&nbsp;5 ja KKO&nbsp;2004:130 johdettua algoritmia. Konkurrenssikoneen vapaasti saatavilla oleva julkinen versio on julkaistu <a href="https://github.com/konkurrenssikone" target="_blank">GitHub-palvelussa</a>, jotta yleisö voi perehtyä sovelluksen lähdekoodiin ja toimintaperiaatteeseen sekä konkurrenssialgoritmin automatisoinnin toteutukseen.</p>
        <p>Konkurrenssikoneen toimintalogiikka on selostettu yksityiskohtaisesti lähdekoodin kommenteissa. Lisätietoa konkurrenssikoneesta on kahdessa artikkelissa, joista toinen on julkaistu <a href="https://oikeus.fi/material/collections/20210407093422/7PNsJ7hZR/Valittuja_kysymyksia_rikos-_prosessi-_ja_vahingonkorvausoikeudesta_I_2021.pdf" target="_blank">Helsingin hovioikeuspiirin yliopistopainotteisen laatuhankkeen julkaisussa 2021</a> (s.&nbsp;419&#8211;480) ja toinen <a href="https://www.edilex.fi/defensor_legis/1000490008" target="_blank">Defensor Legis &#8209;aikakauskirjassa 1/2022</a> (s.&nbsp;106&#8211;131, Edilex/maksumuuri). Konkurrenssikonetta voi myös kokeilla ilman rikosrekisteriotetta <i>Esittelytoiminto</i>-painikkeesta. Toiminto muodostaa fiktiivisiin tietoihin perustuvan esimerkin konkurrenssikoneen tulosteesta.</p>
        <p>Konkurrenssikoneen tulostetta hyödyntävän lainsoveltajan tai muun käyttäjän tulee lukea käyttöohjeet ja ottaa huomioon seuraavat seikat:</p>
        <ul>
          <li>Konkurrenssikoneen ilmoittamiin tietoihin ei tule sokeasti luottaa. Käyttäjän vastuulla on tarkistaa konkurrenssikoneen tulosteen oikeellisuus.</li>
          <li><abbr>Pdf</abbr>-tiedostosta siirrettävien tietojen luenta on testattu PDF-XChange- ja Acrobat Reader &#8209;sovelluksilla.</li>
          <li>Konkurrenssikone esittää jokaisen tuomion kohdalla RL&nbsp;7:6.2:n mukaisen konkurrenssilausunnon eli tuomiolauselmaan sisällytettävän ilmoituksen siitä, mitkä aikaisemmat tuomiot ovat kulloinkin huomioon otettavia tuomioita. Lausuntojen mallia voidaan muuttaa <i>Asetukset</i>-painikkeen takaa löytyvistä valinnoista (ns.&nbsp;lyhyestä mallista ks. esim. ratkaisun KKO 2017:41 tuomiolauselma ja pitkästä mallista esim. ratkaisun KKO 2019:46 tuomiolauselma).</li>
          <li>Konkurrenssikoneen muodostamissa konkurrenssilausunnoissa mainitaan kaikki aikaisemmat tuomiot, joissa on samojen konkurrenssiryhmien rikoksia kuin mitä myöhemmässä tuomiossa on luettu syyksi (huomioon ottaminen laajassa merkityksessä). Konkurrenssikone ei ota kantaa tuomioiden konkreettiseen alentavaan vaikutukseen (huomioon ottaminen suppeassa merkityksessä) eikä siihen, milloin tuomiolauselmassa on perusteltua mainita tuomioista kaikki ja milloin ainoastaan ne tuomiot, jotka ovat konkreettisesti alentaneet rangaistusta.</li>
          <li>Jos tuomiota ei vielä löydy rikosrekisteristä tai jos olemassa olevan tuomion tietoja on tarvetta muuttaa, tarvittavat toiminnot saa näkyviin alla olevasta painikkeesta <i>Rikosrekisteriotteen tietojen muokkaus&nbsp;ym.</i></li>
          <li>Rikosrekisteriotteiden luenta perustuu otteissa esiintyvien avainsanojen, kuten &#8221;vankeus&#8221;, tunnistamiseen. Tietojen siirtämiseen <abbr>pdf</abbr>-muotoisesta rikosrekisteriotteesta liittyy teknisten virheiden mahdollisuus, joka on yleensä sitä suurempi, mitä vanhemmasta tuomiosta on kysymys. Rikosrekisteriotteissa esiintyvät tiedot voidaan ajallisesti jakaa neljään osaan:
            <ol>
              <li>Vuonna 2024 tai sen jälkeen annetut <abbr>Aipa</abbr>-tuomiot, joiden tietojen lukemista ei ole vielä kattavasti testattu.</li>
              <li>Vuodesta 2013 alkaen annetut Ritu-tuomiot, jotka konkurrenssikone pystyy tulkitsemaan ongelmitta. Tiedossa ei ole, että Ritu-tuomioiden tietojen lukemisessa esiintyisi tällä hetkellä virheitä.</li>
              <li>TLP-aikakauden loppuvaiheen tuomiot vuosilta 2003&#8211;2013, joiden tiedot konkurrenssikone pystyy lähes aina tulkitsemaan oikein.</li>
              <li>Vuotta 2003 edeltävät, ns. tekstimuodossa olevat tuomiot, joilla ei käytännössä voi enää olla merkitystä konkurrenssiryhmien määräytymisen kannalta. Näistäkin konkurrenssikone ymmärtää valtaosan yhtenäisrangaistusjärjestelmän voimaantulon (1992) jälkeisistä tuomioista lukuun ottamatta vuosina 1992&#8211;1997 voimassa olleen RL&nbsp;7:8:n mukaisia ns.&nbsp;yhteisen rangaistuksen poikkeuksellista määräämistä koskevia ratkaisuja. Tätä vanhempia tuomioita konkurrenssikone pystyy lukemaan vain rajallisesti.</li>
            </ol>
          </li>
          <li>Konkurrenssikoneessa ei ole tukea ruotsinkielisten rikosrekisteriotteiden käsittelylle. Konkurrenssikoneeseen syötettävä ote tulee siis hankkia suomenkielisenä.</li>
          <li>Konkurrenssikoneen tulosten manuaalisessa tarkistuksessa on syytä kiinnittää huomiota erityisesti siihen, onko konkurrenssikone osannut valita oikean oikeusasteen tuomion (tulosteessa alleviivattuna, jos oikeusasteita on useampia). Siihen, minkä oikeusasteen tuomio on konkurrenssin kannalta ratkaiseva, vaikuttaa se, onko alioikeus esimerkiksi hylännyt syytteen tai tuominnut vain sakkoa tai ehdollista vankeutta (viimeaikaistenkin tuomioiden kohdalla rikosrekisteriotteen merkinnöissä saattaa olla tältä osin epäyhtenäisyyttä tai puutteita). Ensimmäinen oikeusaste on yleensä konkurrenssin kannalta ratkaiseva, sillä useimmiten RL&nbsp;7:6:n ja RL&nbsp;7:7:n soveltamisalaan kuuluva rangaistus on tuomittu ensimmäisessä oikeusasteessa.</li>
          <li>Konkurrenssikone merkitsee muutoksenhakutuomioistuimessa käsiteltävänä olevan (tai olleen) alemman oikeusasteen tuomion jälkeen annetut samaa konkurrenssiryhmää koskevat tuomiot eli ns.&nbsp;jälkituomiot maininnalla <i>[jälkituomio]</i>. Ks.&nbsp;näistä tilanteista esim. KKO 2018:72 ja artikkeli <a href="https://oikeus.fi/hovioikeudet/helsinginhovioikeus/material/attachments/oikeus_hovioikeudet_helsinginhovioikeus/julkaisut/painetutjulkaisut/DsmQCFevP/Valittuja_kysymyksia_rikos_ja_rikosprosessioikeudesta_III_2020.pdf" target="_blank">Helsingin hovioikeuspiirin yliopistopainotteisen laatuhankkeen julkaisussa 2020</a> (s.&nbsp;397&#8211;452).</li>
          <li>Ulkomaiset tuomiot eivät yleensä ilmene rikosrekisteriotteelta, joten tarvittaessa on hankittava erillinen ns.&nbsp;<abbr>Ecris</abbr>-ote, joka on käytävä läpi manuaalisesti, sillä konkurrenssikone ei pysty lukemaan sitä. Jos varsinaisella rikosrekisteriotteella on ulkomaisia tuomioita, konkurrenssikone ei tunnista niitä, jolloin niiden tiedot jäävät pois konkurrenssikoneen tulosteesta.  Mahdollisten ulkomaisten tuomioiden olemassaolo rikosrekisteriotteella pyritään kuitenkin havaitsemaan sen perusteella, onko otteella mainittu RL&nbsp;7:9:ssä tarkoitettuja valtioita tai niiden maakoodeja. Jos ulkomainen tuomio havaitaan, siitä annetaan käyttäjälle erillinen ilmoitus. Ulkomaisten tuomioiden merkitys on harkittava tapauskohtaisesti ottaen huomioon asiaa koskeva oikeuskäytäntö.</li>
          <li>Konkurrenssikoneen tulosteessa luetellaan vain konkurrenssin kannalta merkitykselliset ehdottomat vankeusrangaistukset mukaan lukien yhdyskuntapalvelu- ja valvontarangaistustuomiot (RL&nbsp;7:7). Tulosteessa ei siten luetella ehdollisia vankeustuomioita (oheisrangaistuksesta riippumatta, ks. KKO&nbsp;2011:53) eikä nuorisorangaistustuomioita (RL&nbsp;7:8), mutta ehdolliset ja nuorisorangaistukset esitetään konkurrenssikaaviossa katkoviivoin merkittyinä. Muuntorangaistustuomiot ja vastaavat sivuutetaan kokonaan, sillä niissä ei ole kyse rangaistuksen tuomitsemisesta (ks. KKO&nbsp;2013:95, kohta&nbsp;4). Myöskään tietoja vapaudenmenetyksistä tai rangaistusten suorittamisesta ei näytetä. Näillä tiedoilla voi luonnollisesti olla merkitystä rangaistuksen määräämisessä, joten ne on tarkistettava alkuperäiseltä rikosrekisteriotteelta. Konkurrenssikone kuitenkin huomauttaa käyttäjälle, jos huomioon otettavassa aikaisemmassa tuomiossa vapaudenmenetys on katsottu rangaistuksen täydeksi suoritukseksi, jolloin vapaudenmenetys on vähennettävä myös myöhemmässä tuomiossa (KKO&nbsp;2018:72).</li>
          <li>Konkurrenssikoneessa on toiminto, joka pyrkii tunnistamaan tapauskohtaista harkintaa edellyttävät tilanteet ja ilmoittamaan niistä. Tällaisia ovat nuorisorangaistuksia tai ulkomaisia tuomioita sisältävät rikosrekisteriotteet, rikosten ja tuomioiden sijoittuminen samalle päivälle sekä tapaukset, joissa samana päivänä on annettu useampi kuin yksi tuomio. Viimeksi mainituissa tilanteissa voi hyödyntää <i>Rikosrekisteriotteen tietojen muokkaus&nbsp;ym.</i> &#8209;painikkeen takaa löytyvää toimintoa <i>Konkurrenssin katkaisevan tuomion valinta</i>.</li>
          <li>Tuomiot, joissa aikaisempi rangaistus on katsottu riittäväksi seuraamukseksi, näytetään konkurrenssikoneen tulosteessa, vaikka ne eivät olekaan RL&nbsp;7:6:ssä tarkoitettuja ehdottomia vankeustuomioita. Riittävä seuraamus &#8209;tuomiossa on näet kyse siitä, että aikaisemmasta rangaistuksesta tulee myös uuden rikoksen seuraamus (ks.&nbsp;KKO&nbsp;2021:71, kohta&nbsp;10). Tällaisissa tapauksissa konkurrenssikone lisää konkurrenssilausuntoon hakasulkeissa maininnan siitä, että viitattu aikaisempi tuomio on riittävä seuraamus &#8209;tuomio; lainkäyttäjän harkittavaksi jää, mainitaanko sitä konkurrenssilausunnossa. Konkurrenssiryhmien määräytymiseen tällainen tuomio ei vaikuta. Sellaisen ei kuitenkaan pitäisi voida määräytyä konkurrenssin katkaisevaksi tuomioksi. Jos näin silti tapahtuu, konkurrenssikone antaa siitä käyttäjälle ilmoituksen. Jos samana päivänä on annettu useampi tuomio, konkurrenssikone asettaa konkurrenssin katkaisevuudessa etusijalle sellaiset, jotka eivät ole riittävä seuraamus &#8209;tuomioita.</li>
          <li>Ritu-aikaa edeltävien tuomioiden rikosten tekoajat on voitu merkitä rikosrekisteriin vapaamuotoisesti, esim. muodossa &#8221;loppuvuosi 2010&#8221; tai &#8221;8.&nbsp;ja 9.3.2012 välinen yö&#8221;. Konkurrenssikone pyrkii tunnistamaan tällaiset tekoajat mm.&nbsp;etsimällä tiettyjä avainsanoja ja muuttamalla ne erikseen määritellyiksi yksiselitteisiksi päivämääriksi: esim. &#8221;alkusyksy 2011&#8221; tulkitaan päivämääräksi 1.9.2011. Jos tällaisia tekoaikoja esiintyy, konkurrenssikone ilmoittaa käyttäjälle erikseen, miten tekoaika on tulkittu.</li>
          <li>Konkurrenssiryhmien mukaan järjestetyssä tulosteen osiossa ilmoitetaan myös kunkin konkurrenssiryhmän kokonaisrangaistus eli konkurrenssiryhmän rikoksista seuranneiden vankeusrangaistusten yhteispituus (RL&nbsp;2c:3:n mukaisesti ilmaistuna). Tätä tietoa voi hyödyntää arvioitaessa, onko konkurrenssiryhmäkohtainen kokonaisrangaistus ylittämässä RL&nbsp;7:2:n mukaisen enimmäisrangaistuksen (ks.&nbsp;KKO&nbsp;2025:5) tai onko esimerkiksi yhdyskuntapalvelun raja ylittymässä tai jo ylittynyt (ks.&nbsp;KKO&nbsp;2017:66, vrt.&nbsp;KKO&nbsp;2021:61). Jos konkurrenssiryhmää koskevissa tuomioissa on luettu syyksi myös muiden konkurrenssiryhmien rikoksia, yleensä ei ole mahdollista arvioida täsmällisesti, mikä osuus mistäkin yksittäisestä rangaistuksesta kohdistuu mihinkin konkurrenssiryhmään. Tällaisissa tapauksissa tulosteessa ilmoitettu kokonaisrangaistus muodostaa ylärajan kyseisen konkurrenssiryhmän rangaistusten yhteispituudelle, jolloin tulosteessa mainitaan, että kokonaisrangaistus on <i>enintään</i> tietyn suuruinen (poikkeuksena tilanteet, joissa muiden konkurrenssiryhmien rikoksia sisältävät tuomiot eivät vaikuta kokonaisrangaistukseen, koska niissä on katsottu aikaisempi rangaistus riittäväksi seuraamukseksi).</li> 
          <li>Lainvoimaisten tuomioiden konkurrenssilausuntoja ei ole edes teoriassa mahdollista laatia varmuudella täysin oikein pelkkien rikosrekisteritietojen perusteella, jos huomioon otettua tuomiota koskeva muutoksenhaku on jatkunut lainvoimaiseksi tulleen viimeisimmän oikeusasteen tuomion jälkeen. Tämä johtuu siitä, että rikosrekisteristä ilmenee vain viimeisimmän oikeusasteen tuomiolauselma eivätkä aikaisempina ajankohtina vallinneet tilanteet yleensä ole rikosrekisteriotteen pohjalta pääteltävissä kuin enintään epäsuorasti. Tällaisista tilanteista annetaan käyttäjälle mahdollisuuksien mukaan ilmoitus, jos asetuksista on valittu, että konkurrenssilausunnot laaditaan myös lainvoimaisille tuomioille.</li>
        </ul>
      </div>

      <div id="asetukset">
        <h2>Asetukset</h2>
        <table>
          <tr>
            <th colspan="2">Konkurrenssilausunnot</th>
          </tr>
          <tr>
            <td><input type="checkbox" id="lausuntoLyhyt" name="lausuntoLyhyt" checked></td>
            <td><label for="lausuntoLyhyt">Lyhyt malli &#8211; ei kohdittaista erittelyä</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="lausuntoKeskipitkä" name="lausuntoKeskipitkä"></td>
            <td><label for="lausuntoKeskipitkä">Keskipitkä malli &#8211; kohdittainen erittely vain aikaisempien tuomioiden osalta</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="lausuntoPitkä" name="lausuntoPitkä" checked></td>
            <td><label for="lausuntoPitkä">Pitkä malli &#8211; kohdittainen erittely myös nyt syyksiluettavien rikosten osalta</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="lausuntoKaikille" name="lausuntoKaikille"></td>
            <td><label for="lausuntoKaikille">Myös lainvoimaisille tuomioille</label></td>
          </tr>
          <tr>
            <th colspan="2">Konkurrenssikaavio</th>
          </tr>
          <tr>
            <td><input type="checkbox" id="värillinenKaavio" name="värillinenKaavio" checked></td>
            <td><label for="värillinenKaavio">Värillinen kaavio</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="mhKaaviossa" name="mhKaaviossa" checked></td>
            <td><label for="mhKaaviossa">Näytä myös muutoksenhaut</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="ehdollisetKaaviossa" name="ehdollisetKaaviossa" checked></td>
            <td><label for="ehdollisetKaaviossa">Näytä myös ehdolliset vankeusrangaistukset ja nuorisorangaistukset</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="isoKaavio" name="isoKaavio"></td>
            <td><label for="isoKaavio">Kaksinkertainen mittakaava aika-akselilla</label></td>
          </tr>
          <tr>
            <th colspan="2">Lisäasetukset</th>
          </tr>
          <tr>
            <td><input type="checkbox" id="tyhjennäLeikepöytä" name="tyhjennäLeikepöytä"></td>
            <td><label for="tyhjennäLeikepöytä">Tyhjennä leikepöytä heti käytön jälkeen, jos selain sallii</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="vianhaku" name="vianhaku"></td>
            <td><label for="vianhaku">Vianhakutiedot <abbr>pdf</abbr>:n luennan etenemisestä normaalin tulosteen sijaan</label></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="lähdekoodi" name="lähdekoodi" onclick="näytäTaiPiilotaKenttä('lähdekoodi')"></td>
            <td><label for="lähdekoodi">Näytä tulosteen <abbr>html</abbr>-lähdekoodi
            </label><br><textarea id="lähdekoodikenttä" cols="60" rows="10" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Tulosteen lähdekoodi näytetään tässä tekstikentässä" readonly></textarea></td>
          </tr>
          <tr>
            <td><input type="checkbox" id="tiivisteet" name="tiivisteet" onclick="näytäTaiPiilotaKenttä('tiivisteet')"></td>
            <td><label for="tiivisteet">Laske tiivisteet (<i>hash</i>)</label><br><textarea id="tiivisteetkenttä" cols="60" rows="2" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Tiivisteet näytetään sekä tässä tekstikentässä että konkurrenssikoneen tulosteessa" readonly></textarea></td>
          </tr>
        </table>
      </div>

      <div id="versiohistoria">
        <h2>Versiohistoria</h2>
        <table>
          <tr>
            <th>Versio</th>
            <th>Julkaisupäivä</th>
            <th>Päivityksen sisältö</th>
          </tr>
          <tr>
            <td>0.10</td>
            <td>6.12.2016</td>
            <td>Toteutettu konkurrenssiryhmien määrittämisen automatisointi.</td>
          </tr>
          <tr>
            <td>0.20</td>
            <td>9.12.2016</td>
            <td>Toteutettu rikosten tulostaminen konkurrenssiryhmien mukaiseen järjestykseen.</td>
          </tr>
          <tr>
            <td>0.30</td>
            <td>19.12.2016</td>
            <td>Lisätty alustava mahdollisuus lukea <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietoja.</td>
          </tr>
          <tr>
            <td>0.33</td>
            <td>22.12.2016</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa.</td>
          </tr>
          <tr>
            <td>0.40</td>
            <td>1.1.2017</td>
            <td>Rikosrekisteriotteen tietojen lukutapaa parannettu. Lisätty muutoksenhakutilanteiden käsittely.</td>
          </tr>
          <tr>
            <td>0.43</td>
            <td>2.1.2017</td>
            <td>Lisätty konkurrenssikaavio (ns.&nbsp;tikapuut).</td>
          </tr>
          <tr>
            <td>0.44</td>
            <td>3.1.2017</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa ja lisätty konkurrenssikaavioon värikoodaus.</td>
          </tr>
          <tr>
            <td>0.50</td>
            <td>7.1.2017</td>
            <td>Lisätty konkurrenssilausuntojen automaattinen luominen sekä huomautukset käyttäjälle ulkomaisista tuomioista ja nuorisorangaistuksesta. Kehitetty konkurrenssikaaviota.</td>
          </tr>
          <tr>
            <td>0.51</td>
            <td>8.1.2017</td>
            <td>Lisätty huomautukset käyttäjälle tilanteista, joissa samana päivänä on annettu useampi kuin yksi tuomio tai joissa rikos on tehty samana päivänä kuin jokin aikaisempi tuomio.</td>
          </tr>
          <tr>
            <td>0.52</td>
            <td>18.1.2017</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa, tulosteen sisältöä ja konkurrenssikaaviota.</td>
          </tr>
          <tr>
            <td>0.53</td>
            <td>23.1.2017</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa.</td>
          </tr>
          <tr>
            <td>0.54</td>
            <td>25.1.2017</td>
            <td>Lisätty ilmoitus käyttäjälle tilanteesta, jossa rikosrekisteriotteelta ei löydetä huomioon otettavia ehdottomia tuomioita.</td>
          </tr>
          <tr>
            <td>0.55</td>
            <td>8.2.2017</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa lainvoimaa vailla olevien täytäntöönpanokelpoisten tuomioiden osalta.</td>
          </tr>
          <tr>
            <td>0.56</td>
            <td>9.2.2017</td>
            <td>Lisätty mahdollisuus näyttää tarkemmat tiedot <abbr>pdf</abbr>-muotoisen rikosrekisterin luennasta virheiden etsimistä varten. Kehitetty tietojen luentaa ulkomaisten tuomioiden osalta.</td>
          </tr>
          <tr>
            <td>0.60</td>
            <td>10.2.2017</td>
            <td>Lisätty koneen tulosteeseen tiedot tulostusajankohdasta sekä rikosrekisteriotteen pyytäjästä ja ajankohdasta. Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa ja lisätty alustava tuki tuomioille, jotka on annettu ennen vuotta 2003.</td>
          </tr>
          <tr>
            <td>0.70</td>
            <td>10.8.2017</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa tilanteissa, joissa rikosnimike jakautuu kahdelle riville.</td>
          </tr>
          <tr>
            <td>0.80</td>
            <td>15.8.2017</td>
            <td>Lisätty tulkinnanvaraisten (&#8221;alkuvuosi 2005&#8221; &#8209;tyyppisten) tekoaikojen tunnistus vanhoista TLP-aikaisista tuomioista. Lisätty myös ilmoitus käyttäjälle vanhan lain mukaisista yhdistämisratkaisuista. Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa muutoinkin. Päivitetty ohjeita.</td>
          </tr>
          <tr>
            <td>0.90</td>
            <td>16.2.2018</td>
            <td>Muutettu ei-lainvoimaisten tuomioiden konkurrenssilausuntoehdotusten tulostusta niin, että myös tuomion antamisen jälkeiset (hovioikeudessa mahdollisesti huomioon otettavat) tuomiot mainitaan. Ne näytetään harmaalla tekstillä ja punaisissa hakasulkeissa. Muutettu nimi konkurrenssilaskurista konkurrenssikoneeksi.</td>
          </tr>
          <tr>
            <td>0.91</td>
            <td>20.2.2018</td>
            <td>Lisätty yhdyskuntapalveluiden ja valvontarangaistusten tietojen näyttäminen. Kehitetty konkurrenssiryhmittäistä tulostetta: korjattu tulostusjärjestys, parannettu ulkoasua sekä lisätty tiedot lainvoimaisuudesta ja tieto sellaisten rikosten konkurrenssiryhmistä, jotka on tuomittu eri konkurrenssin katkaisevassa muussa tuomiossa.</td>
          </tr>
          <tr>
            <td>0.95</td>
            <td>25.2.2018</td>
            <td>Lisätty vaihtoehdoiksi myös konkurrenssilausunnon tulostus kohdittain eriteltynä eli ns.&nbsp;pitkän mallin mukaisena ja myös lainvoimaisia tuomioita koskien. Kehitetty konkurrenssikaaviota.</td>
          </tr>
          <tr>
            <td>0.96</td>
            <td>4.3.2018</td>
            <td>Lisätty pitkien ja tulkinnanvaraisten tekoaikojen näyttäminen (aiemmin näytettiin vain tekoajan päättymispäivä). Kehitetty konkurrenssikaaviota sekä <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa TLP-aikaisten tekoaikojen osalta.</td>
          </tr>
          <tr>
            <td>0.97</td>
            <td>12.3.2018</td>
            <td>Lisätty konkurrenssilausuntoihin kaikkien oikeusasteiden tuomioiden tiedot.</td>
          </tr>
          <tr>
            <td>0.98</td>
            <td>4.4.2018</td>
            <td>Muutettu lainvoimaisten tuomioiden konkurrenssilausuntoja niin, että niissä mainitaan myös ne tuomiot, jotka on annettu konkurrenssin kannalta ratkaisevan oikeusasteen tuomion antamisen jälkeen. Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa vanhimpien TLP-aikaisten ykp-tuomiolauselmien osalta.</td>
          </tr>
          <tr>
            <td>0.981</td>
            <td>4.6.2018</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa käytettäessä muita sovelluksia kuin Adobe Readeria.</td>
          </tr>
          <tr>
            <td>0.982</td>
            <td>13.8.2018</td>
            <td>Lisätty vaihtoehdoksi perinteinen eli mustavalkoinen konkurrenssikaavio (oletusarvo). Lisätty ilmoitus ruotsinkielisistä tuomiotiedoista, joita kone ei pysty lukemaan.</td>
          </tr>
          <tr>
            <td>0.983</td>
            <td>20.8.2019</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisten rikosrekisteriotteiden luentaa tilanteissa, joissa tuomion lainvoimaisuus on määrittämätön. Muutettu täytäntöönpanokelpoisten tuomioiden lainvoimaisuustiedoksi tulosteessa "Ei lainvoimainen" (aiemmin "Lainvoimainen").</td>
          </tr>
          <tr>
            <td>0.983b</td>
            <td>10.9.2019</td>
            <td>Lisätty huomautus siitä, että rikosrekisteriotteen tekstiä ei saa maalata hiirellä vaan on käytettävä <i>Valitse kaikki</i> &#8209;toimintoa.</td>
          </tr>
          <tr>
            <td>0.984</td>
            <td>3.10.2019</td>
            <td>Kehitetty konkurrenssikaavioita. Muutettu mustavalkoisen kaavion harmaat tekstit mustiksi, jotta kaavio tulostuu paremmin. Muutettu värillisen kaavion mallia niin, että eri värit kuvaavat konkurrenssiryhmiä. Poistettu erilliset viivat rikoksista konkurrenssin katkaiseviin tuomioihin.</td>
          </tr>
          <tr>
            <td>0.985</td>
            <td>23.10.2019</td>
            <td>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa yhdistelmärangaistustuomioiden osalta.</td>
          </tr>
          <tr>
            <td>0.99</td>
            <td>25.5.2020</td>
            <td>
              <ul>
                <li>Lukuisia teknisiä parannuksia.</li>
                <li>Yksinkertaistettu ulkoasua piilottamalla käyttöohjeet ja muut tiedot (saatavissa näkyviin painikkeilla).</li>
                <li>Tuloste avautuu nyt uuteen ikkunaan, samoin otteen luennan vianetsintätiedot (muilla selaimilla kuin IE:llä).</li>
                <li>Mahdollistettu konkurrenssikoneen käytön jatkaminen kaikilla selaimilla ilman uudelleenlatausta.</li>
                <li>Kehitetty niiden tilanteiden käsittelyä, joissa rikosrekisteriotteelta ei löydetä tuomioita.</li>
                <li>Muutettu värillinen konkurrenssikaavio oletusarvoksi ja lisätty kaavioon ehdolliset tuomiot ja nuorisorangaistukset.</li>
                <li>Lisätty ns.&nbsp;riittävä seuraamus &#8209;tuomiot konkurrenssikoneen tulosteeseen ja konkurrenssilausuntoehdotuksiin.</li>
                <li>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisterin luentaa.</li>
                <li>Päivitetty ohjeita.</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>0.991</td>
            <td>1.6.2020</td>
            <td>
              <ul>
                <li>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisterin luentaa ns.&nbsp;riittävä seuraamus &#8209;tuomioiden, nuorisorangaistustuomioiden ja TLP-aikaisten tuomioiden osalta. Lisätty muuntorangaistusten tunnistus (muuntorangaistukset sivuutetaan ilman erillistä ilmoitusta).</li>
                <li>Rajattu samalla päivällä olevien tuomioiden ja rikosten tarkistus koskemaan vain konkurrenssin katkaisevia tuomioita.</li>
                <li>Lisätty tulosteeseen tieto konkurrenssiryhmien määrittämisen kestosta.</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>0.995</td>
            <td>2.9.2020</td>
            <td>
              <ul>
                <li>Lisätty esittelytoiminto, joka luo ja analysoi fiktiivisen esimerkkirikosrekisteriotteen.</li>
                <li>Lukuisia teknisiä parannuksia. Uusittu tuomioiden, rikosten ja konkurrenssiryhmien tulostuksen toteutus pääosin ja kehitetty tulosteen ulkoasua. Uusittu kokonaan konkurrenssilausuntojen luomisen sekä samalla päivällä olevien tuomioiden ja rikosten etsimisen toteutus. Kehitetty muutoinkin niiden tilanteiden käsittelyä, joissa samalla päivällä on useita tuomioita.</li>
                <li>Otettu lainvoimaisten tuomioiden konkurrenssilausuntoehdotuksissa huomioon tilanteet, joissa huomioon otettavaa tuomiota on koskenut muutoksenhaku sen jälkeen, kun alennettu tuomio on tullut lainvoimaiseksi, ja lisätty varoitus näistä tilanteista.</li>
                <li>Lisätty konkurrenssiryhmäluettelon otsikoihin tieto konkurrenssiryhmien alku- ja loppupäivämääristä.</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>0.996</td>
            <td>18.10.2021</td>
            <td>
              <ul>
                <li>Julkinen koekäyttöön tarkoitettu testiversio. Vähäisiä teknisiä muutoksia.</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>2.0</td>
            <td>29.1.2025</td>
            <td>
              <ul>
                <li>Uusittu käyttöliittymän ja tulosteen ulkoasu. Järjestelty asetukset uudelleen ja sijoitettu ne painikkeen taakse omaan osioonsa. Päivitetty ohjeita laajasti.</li>
                <li>Lisätty mahdollisuus muokata rikosrekisteriotteen sisältöä: tuomioiden lisääminen, poistaminen ja muokkaaminen sekä alemman oikeusasteen tuomitseman rangaistuksen muuttaminen ehdottomaksi vankeudeksi ylemmässä asteessa.</li>
                <li>Lisätty mahdollisuus määrittää tietty tuomio konkurrenssin katkaisevaksi tilanteessa, jossa samana päivänä on annettu useita tuomioita. Täsmennetty konkurrenssiryhmien määräytymistä niin, että ns.&nbsp;riittävä seuraamus &#8209;tuomio on viimesijainen vaihtoehto konkurrenssin katkaisevaksi tuomioksi, jos samana päivänä on annettu useita tuomioita, ja lisätty varoitus tilanteista, joissa tällainen tuomio silti määrittyy konkurrenssin katkaisevaksi.</li>
                <li>Lisätty uutena vaihtoehtona ns.&nbsp;keskipitkän mallin konkurrenssilausunto sekä mahdollisuus tulostaa eri mallien mukaisia konkurrenssilausuntoja samalla kertaa, jolloin mahdollisesti samansisältöiset lausunnot yhdistetään.</li>
                <li>Muutettu rikosten tietojen tulostamista niin, että rikoksen konkurrenssiryhmä mainitaan aina riippumatta siitä, onko rikos käsitelty konkurrenssin katkaisevassa tuomiossa vai&nbsp;ei.</li>
                <li>Lisätty tulosteen konkurrenssiryhmittäiseen osioon tieto kunkin konkurrenssiryhmän rikosten kokonaisrangaistuksesta tai sen ylärajasta.</li>
                <li>Lisätty konkurrenssikaavioon muutoksenhaut, muutettu kaavion väritystä ja kehitetty kaaviota muutenkin. Lisätty mahdollisuus muuttaa konkurrenssikaavion aika-akselin mittakaavaa.</li>
                <li>Kehitetty <abbr>pdf</abbr>-muotoisen rikosrekisteriotteen tietojen luentaa erityisesti yhdistelmärangaistustuomioiden sekä TLP-aikaisten tuomioiden tekoaikojen ja yhdyskuntapalvelun muuntotuomioiden osalta. Lisäksi uusittu tulkinnanvaraisten tekoaikojen tulkinnan toteutus.</li>
                <li>Lisätty tulosteeseen tiedot viraltapanoista, jäännösrangaistusten ja ehdollisten vankeusrangaistusten täytäntöönpanosta osana yhteistä rangaistusta sekä tuomioiden täytäntöönpanokelpoisuudesta lainvoimaisuuden lisätietona.</li>
                <li>Lisätty huomautus tilanteista, joissa muun kuin ensimmäisen oikeusasteen tuomion päivämäärä ratkaisee.</li>
                <li>Lisätty huomautus tilanteista, joissa vapaudenmenetys on aikaisemmassa tuomiossa katsottu rangaistuksen täydeksi suoritukseksi ja pitää siten vähentää myös samaa konkurrenssiryhmää koskevassa myöhemmässä tuomiossa.</li>
                <li>Lisätty varoitus rikosrekisterin osaotteen käyttämisestä.</li>
                <li>Kehitetty esittelytoimintoa mm.&nbsp;niin, että tuomion antopäivä ei voi olla ns.&nbsp;liikkuva pyhäpäivä. Lisätty esittelytoiminnon tuomioistuintietokantaan alioikeudet hovioikeuspiireittäin vuodesta 1952 alkaen.</li>
                <li>Uudistettu vianhakutulosteen ulkoasu, kehitetty sitä muutoinkin ja lisätty rikosrekisteriotteen sisällön muokkaamiseen liittyvät tiedot vianhakutulosteeseen.</li>
                <li>Lisätty mahdollisuus ladata tuloste <abbr>html</abbr>-tiedostona sekä tarkastella tulosteen <abbr>html</abbr>-koodia erillisessä tekstikentässä.</li>
                <li>Lisätty leikepöydän automaattinen tyhjentämistoiminto.</li>
                <li>Lisätty konkurrenssikoneen kehittämistä varten toiminto, joka laskee tiivisteet (<i>hash</i>) rikosrekisteriotteesta, konkurrenssianalyysin tulosten eri vaiheista ja konkurrenssikoneen tulosteesta.</li>
                <li>IE-tuki poistettu.</li>
                <li>Useita teknisiä parannuksia.</li>
              </ul>
            </td>
          </tr>
        </table>
      </div>

      <div id="esittelyAsetukset">
        <h2>Esittelytoiminto</h2>
        <p>Tällä toiminnolla voi luoda konkurrenssikoneen mallitulosteen. Sen pohjana on fiktiivinen rikosrekisteriote, jonka tiedot muodostetaan satunnaisesti noudattaen alla olevia asetuksia.</p>
        <table>
          <tr>
            <td colspan="3" class="painike">
            <button type="button" onclick="analysoiRikosrekisteriote(this.form, true)">Luo mallituloste fiktiivisen rikosrekisteriotteen pohjalta<span id="max"> (up&nbsp;to&nbsp;11)</span></button>
            </td>
          </tr>
          <tr>
            <td>Ehdottomien tuomioiden määrä:</td>
            <td class="lukema" id="ehdottomienMääräLukema"></td>
            <td class="liukusäädin"><input type="range" min="0" max="100" step="1" value="10" id="ehdottomienMäärä"></td>
          </tr>
          <tr>
            <td>Ehdollisten tuomioiden määrä:</td>
            <td class="lukema" id="ehdollistenMääräLukema"></td>
            <td class="liukusäädin"><input type="range" min="0" max="10" step="1" value="2" id="ehdollistenMäärä"></td>
          </tr>
          <tr>
            <td>Rikosten enimmäismäärä tuomiossa:</td>
            <td class="lukema" id="rikostenEnimmäismääräLukema"></td>
            <td class="liukusäädin"><input type="range" min="5" max="30" step="1" value="6" id="rikostenEnimmäismäärä"></td>
          </tr>
          <tr>
            <td>Enimmäisaika tuomioiden välillä:</td>
            <td class="lukema" id="tuomioidenVäliMaxLukema"></td>
            <td class="liukusäädin"><input type="range" min="50" max="365" step="1" value="250" id="tuomioidenVäliMax"></td>
          </tr>
          <tr>
            <td>Enimmäisaika rikosten välillä:</td>
            <td class="lukema" id="rikostenVäliMaxLukema"></td>
            <td class="liukusäädin"><input type="range" min="50" max="150" step="1" value="100" id="rikostenVäliMax"></td>
          </tr>
          <tr>
            <td>Muutoksenhaun todennäköisyys:</td>
            <td class="lukema" id="mhTodennäköisyysLukema"></td>
            <td class="liukusäädin"><input type="range" min="0" max="100" step="1" value="35" id="mhTodennäköisyys"></td>
          </tr>
          <tr>
            <td>Muutoksenhaun enimmäiskesto:</td>
            <td class="lukema" id="mhVäliMaxLukema"></td>
            <td class="liukusäädin"><input type="range" min="100" max="600" step="1" value="300" id="mhVäliMax"></td>
          </tr>
        </table>
      </div>

      <div class="osio">
        <button type="button" id="muokkaaTuomiotaPainike" onclick="näytäTaiPiilota('muokkaaTuomiota')">Rikosrekisteriotteen tietojen muokkaus&nbsp;ym.&nbsp;<span id="muokkausNuoliAlas">&#8681;</span><span id="muokkausNuoliYlös">&#8679;</span></button>
      </div>

      <div id="muokkaaTuomiota">
        <details>
          <summary><b>Ohje</b></summary>
          <ul>
            <li>Alla olevilla toiminnoilla voi muokata rikosrekisteriotteen rikosten ja tuomioiden tietoja. Jos tietoja muokataan, käyttäjän on tarkistettava konkurrenssikoneen tulosteesta, että otteen tiedot ovat päivittyneet halutulla tavalla.</li>
            <li>Muokattava tuomio yksilöidään ilmoittamalla sen ratkaisunumero (minkä tahansa oikeusasteen ratkaisunumero käy).</li>
            <li>Otteeseen lisättävien rikosten tiedot voi joko kirjoittaa itse mallin mukaisesti tai kopioida Ritu- tai <abbr>Aipa</abbr>-tuomiolauselmasta. Lisäämisen jälkeen konkurrenssikone lajittelee automaattisesti kaikki rikokset syytekohtien mukaiseen järjestykseen.</li>
            <li><b><span style="color: red">Tärkeää:</span> jos tiedot kopioidaan, käyttäjän on ehdottomasti valittava vaihtoehto &#8221;Ritusta kopioitu&#8221; tai &#8221;<abbr>Aipa</abbr>sta kopioitu&#8221;, jotta konkurrenssikone osaa lukea tiedot oikein. Jos oikeaa vaihtoehtoa ei ole valittu, rikosten tekoajat voivat mennä keskenään sekaisin ja tuloste voi olla muutenkin virheellinen.</b></li>
            <li>Jos kopioitava tuomiolauselma ulottuu useammalle kuin yhdelle sivulle, kopiointi kannattaa suorittaa osissa sivu kerrallaan. Ritu-tietojen kopiointi PDF-XChange-sovelluksessa onnistuu yleensä paremmin, jos piirtää hiirellä &#8221;laatikon&#8221; kopioitavan tekstin ympärille sen sijaan, että aloittaisi tekstin &#8221;maalaamisen&#8221; ensimmäisestä kirjaimesta.</li>
            <li>Muokkaustoimintoja voi myös yhdistellä esimerkiksi niin, että lainvoimaa vailla oleva ehdollinen tuomio muutetaan ehdottomaksi ylemmässä asteessa ja siitä poistetaan syyksi luettuja rikoksia. Rikosrekisterissä näkyvien syyksi luettujen rikosten tietoja voi muuttaa yhdistämällä poistamisen ja lisäämisen: rikoksen voi poistaa tuomiosta ja lisätä tilalle muutetun rikoksen samalla syytekohtanumerolla.</li>
          </ul>
        </details>
        <details>
          <summary>Tuomion lisääminen</summary>
          <textarea id="uudenTuomionPvm" cols="60" rows="1" maxlength="20" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Antopäivä pp.kk.vvvv (jos tyhjä, käytetään kuluvaa päivää)"></textarea><br>
          <input type="radio" id="uusiTuomioVapaa" name="uusiTuomioLaji" checked>
          <label for="uusiTuomioVapaa">Alla olevan mallin mukaisesti</label>
          <input type="radio" id="uusiTuomioRitu" name="uusiTuomioLaji">
          <label for="uusiTuomioRitu">Ritusta kopioitu</label>
          <input type="radio" id="uusiTuomioAipa" name="uusiTuomioLaji">
          <label for="uusiTuomioAipa"><abbr>Aipa</abbr>sta kopioitu</label><br>
          <textarea id="uudenTuomionRikokset" cols="72" rows="10" maxlength="5000" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Kirjoita tähän uudessa tuomiossa syyksiluettavat rikokset seuraavan mallin mukaisesti:&#10;&#10;1. Pahoinpitely&#10;15.3.2024&#10;&#10;2.1. Petos&#10;6.-8.4.2024&#10;&#10;(jne.)"></textarea>
        </details>
        <details>
          <summary>Tuomion poistaminen</summary>
          <textarea id="poistettavaTuomio" cols="35" rows="1" maxlength="20" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Poistettavan tuomion ratkaisunumero"></textarea>
        </details>
        <details>
          <summary>Rikosten lisääminen tuomioon</summary>
          <textarea id="muokattavaTuomio" cols="35" rows="1" maxlength="20" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Tuomion ratkaisunumero"></textarea><br>
          <input type="radio" id="rikoksetVapaa" name="muokattavaTuomioLaji" checked>
          <label for="rikoksetVapaa">Alla olevan mallin mukaisesti</label>
          <input type="radio" id="rikoksetRitu" name="muokattavaTuomioLaji">
          <label for="rikoksetRitu">Ritusta kopioitu</label>
          <input type="radio" id="rikoksetAipa" name="muokattavaTuomioLaji">
          <label for="rikoksetAipa"><abbr>Aipa</abbr>sta kopioitu</label><br>
          <textarea id="muokattavaTuomioRikokset" cols="72" rows="10" maxlength="5000" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Kirjoita tähän lisättävät syyksiluetut rikokset seuraavan mallin mukaisesti:&#10;&#10;1. Pahoinpitely&#10;15.3.2024&#10;&#10;2.1. Petos&#10;6.-8.4.2024&#10;&#10;(jne.)"></textarea>
        </details>
        <details>
          <summary>Rikosten poistaminen tuomiosta</summary>
          <textarea id="poistettavatRikoksetTuomio" cols="35" rows="1" maxlength="20" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Tuomion ratkaisunumero"></textarea><br>
          <textarea id="poistettavatRikokset" cols="35" rows="2" maxlength="1000" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Poistettavat syytekohdat pilkuilla erotettuina (esim. 3, 4.1, 4.2, 7)"></textarea>
        </details>
        <details>
          <summary>Tuomion muuttaminen ehdottomaksi ylemmässä asteessa</summary>
          <textarea id="tuomioEhdottomaksi" cols="40" rows="1" maxlength="20" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Muutettavan tuomion ratkaisunumero"></textarea><br>
          <textarea id="tuomioEhdottomaksiPvm" cols="75" rows="1" maxlength="20" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Ylemmän asteen antopäivä pp.kk.vvvv (jos tyhjä, käytetään kuluvaa päivää)"></textarea>
        </details>
        <details>
          <summary>Konkurrenssin katkaisevan tuomion valinta samana päivänä annetuista tuomioista</summary>
          <textarea id="katkaisevatTuomiot" cols="48" rows="1" maxlength="100" spellcheck="false" autocomplete="off" autocapitalize="off" placeholder="Tuomioiden ratkaisunumerot pilkuilla erotettuina"></textarea>
        </details>
      </div>

      <div class="osio" id="käyttöehto-osio">
        <span class="huomautus"><b>Huom!</b> Konkurrenssikoneen käyttäminen edellyttää käyttöehtojen hyväksymistä.</span><br><br>
        <input type="checkbox" name="käyttöehdotHyväksytty" id="käyttöehdotHyväksytty" onclick="tallennaKäyttöehtojenAjankohta();"> <b>Hyväksyn käyttöehdot</b><br>
        <button type="button" id="käyttöehdotPainike" onclick="näytäTaiPiilota('käyttöehdot')">Käyttöehdot&nbsp;<span id="käyttöehtoNuoliAlas">&#8681;</span><span id="käyttöehtoNuoliYlös">&#8679;</span></button>
        <div id="käyttöehdotPiilotettu">
          Käyttöehtojen hyväksymisajankohta:
          <input type="text" readonly name="käyttöehtojenAjankohta" id="käyttöehtojenAjankohta">
        </div>
      </div>

      <div id="käyttöehdot">
        <h2>Konkurrenssikoneen käyttöehdot</h2>
        <ol>
          <li>Konkurrenssikone on maksuttomaan koekäyttöön tarkoitettu testiversio, jota käyttäjä käyttää omalla vastuulla, eikä konkurrenssikoneen kehittäjä tai Helsingin hovioikeus voi taata ohjelman toimivuutta tai tulosten oikeellisuutta.</li>
          <li>Konkurrenssikone ja sen lähdekoodi on julkistettu, jotta yleisö voi perehtyä konkurrenssikoneeseen ja sen toimintaan. Koekäytössä voi hyödyntää sekä esittelytoimintoa että fiktiivisiä tietoja sisältävää rikosrekisteriotteen mallikappaletta. Jos konkurrenssikoneeseen tästä käyttötarkoituksesta poiketen syötetään todellisia rikosrekisteritietoja, käyttäjä vastaa itse konkurrenssikoneen tietoturvallisesta käytöstä, rikosrekisteritietojen ja konkurrenssikoneen tulosteen salassapidosta sekä tietosuojavelvoitteiden noudattamisesta. Tarvittaessa käyttäjä voi selvittää tai selvityttää konkurrenssikoneen toiminnan yksityiskohdat lähdekoodiin tutustumalla.</li>
          <li>Konkurrenssikoneen käyttäminen edellyttää joka tapauksessa, että käyttäjä on lukenut ja ymmärtänyt oheiset ohjeet (kohdat <i>Käyttöohjeet</i> ja <i>Tärkeää tietoa</i>) ja noudattaa niitä.</li>
          <li>Konkurrenssikoneelle ei voida tarjota minkäänlaista käyttöopastusta tai teknistä tukea.</li>
          <li>Jos käyttäjä ei hyväksy käyttöehtoja kokonaisuudessaan, konkurrenssikonetta ei saa käyttää.</li>
        </ol>
      </div>

    </form>

  </body>

</html>
